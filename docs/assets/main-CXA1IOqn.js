import{g as ut,a as _e,s as Oe}from"./Storage-Dq_nzxBD.js";import{e as We}from"./index-2S9iaWh7.js";var ft=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],f="",u=0,l=n.length;u<l;++u)f+=n.charAt(u),s.push(f);return s},e}(),pt=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function Te(e,r){r=r||[],e=e||{};for(var a=e,n=0;n<r.length;n++)if(a=a[r[n]],a==null)return null;return a}var mt=function(){function e(a){this._uidFieldName=a,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,f){this._tokenToIdfCache={};var u=this._tokenMap,l;typeof u[n]!="object"?u[n]=l={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(l=u[n],l.$totalNumOccurrences++);var h=l.$uidMap;typeof h[s]!="object"?(l.$numDocumentOccurrences++,h[s]={$document:f,$numTokenOccurrences:1}):h[s].$numTokenOccurrences++},r.search=function(n,s){for(var f={},u=0,l=n.length;u<l;u++){var h=n[u],k=this._tokenMap[h];if(!k)return[];if(u===0)for(var $=Object.keys(k.$uidMap),E=0,C=$.length;E<C;E++){var v=$[E];f[v]=k.$uidMap[v].$document}else for(var $=Object.keys(f),E=0,C=$.length;E<C;E++){var v=$[E];typeof k.$uidMap[v]!="object"&&delete f[v]}}var p=[];for(var v in f)p.push(f[v]);var I=this._createCalculateTfIdf();return p.sort(function(w,K){return I(n,K,s)-I(n,w,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(u,l){if(!s[u]){var h=typeof n[u]<"u"?n[u].$numDocumentOccurrences:0;s[u]=1+Math.log(l.length/(1+h))}return s[u]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,f=this._createCalculateIdf();return function(l,h,k){for(var $=0,E=0,C=l.length;E<C;++E){var v=l[E],p=f(v,k);p===1/0&&(p=0);var I;s instanceof Array?I=h&&Te(h,s):I=h&&h[s];var w=typeof n[v]<"u"&&typeof n[v].$uidMap[I]<"u"?n[v].$uidMap[I].$numTokenOccurrences:0;$+=w*p}return $}},e}(),ht=/[^a-zа-яё0-9\-']+/i,gt=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(ht).filter(function(s){return s})},e}();function Be(e,r){for(var a=0;a<r.length;a++){var n=r[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function yt(e,r,a){return r&&Be(e.prototype,r),a&&Be(e,a),e}var xt=function(){function e(a){if(!a)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=a,this._indexStrategy=new ft,this._searchIndex=new mt(a),this._sanitizer=new pt,this._tokenizer=new gt,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var f=this._indexStrategy,u=this._sanitizer,l=this._searchIndex,h=this._tokenizer,k=this._uidFieldName,$=0,E=n.length;$<E;$++){var C=n[$],v;k instanceof Array?v=Te(C,k):v=C[k];for(var p=0,I=s.length;p<I;p++){var w,K=s[p];if(K instanceof Array?w=Te(C,K):w=C[K],w!=null&&typeof w!="string"&&w.toString&&(w=w.toString()),typeof w=="string")for(var W=h.tokenize(u.sanitize(w)),F=0,ie=W.length;F<ie;F++)for(var _=W[F],ee=f.expandToken(_),G=0,R=ee.length;G<R;G++){var te=ee[G];l.indexDocument(te,v,C)}}}},yt(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),Le={exports:{}};function vt(e,r){var a=e[0]-r[0],n=e[1]-r[1];return a*a+n*n}var wt=function(r,a){if(r.length<=1)return r;a=typeof a=="number"?a:1;for(var n=a*a,s=r[0],f=[s],u,l=1,h=r.length;l<h;l++)u=r[l],vt(u,s)>n&&(f.push(u),s=u);return s!==u&&f.push(u),f};function Et(e,r,a){var n=r[0],s=r[1],f=a[0]-n,u=a[1]-s;if(f!==0||u!==0){var l=((e[0]-n)*f+(e[1]-s)*u)/(f*f+u*u);l>1?(n=a[0],s=a[1]):l>0&&(n+=f*l,s+=u*l)}return f=e[0]-n,u=e[1]-s,f*f+u*u}function Me(e,r,a,n,s){for(var f=n,u,l=r+1;l<a;l++){var h=Et(e[l],e[r],e[a]);h>f&&(u=l,f=h)}f>n&&(u-r>1&&Me(e,r,u,n,s),s.push(e[u]),a-u>1&&Me(e,u,a,n,s))}var bt=function(r,a){if(r.length<=1)return r;a=typeof a=="number"?a:1;var n=a*a,s=r.length-1,f=[r[0]];return Me(r,0,s,n,f),f.push(r[s]),f},nt=wt,rt=bt;Le.exports=function(r,a){return r=nt(r,a),r=rt(r,a),r};Le.exports.radialDistance=nt;Le.exports.douglasPeucker=rt;var St=Le.exports;const kt=ut(St);let ot=!1;function y(e=!0){ot=e}window.addEventListener("beforeunload",function(e){if(!ot)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function Je(e,r,a,n=s=>s){return e*n(.5-r*(.5-a))}function $t(e){return[-e[0],-e[1]]}function H(e,r){return[e[0]+r[0],e[1]+r[1]]}function Y(e,r){return[e[0]-r[0],e[1]-r[1]]}function U(e,r){return[e[0]*r,e[1]*r]}function Ct(e,r){return[e[0]/r,e[1]/r]}function Se(e){return[e[1],-e[0]]}function Ue(e,r){return e[0]*r[0]+e[1]*r[1]}function It(e,r){return e[0]===r[0]&&e[1]===r[1]}function zt(e){return Math.hypot(e[0],e[1])}function Lt(e){return e[0]*e[0]+e[1]*e[1]}function He(e,r){return Lt(Y(e,r))}function at(e){return Ct(e,zt(e))}function Dt(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function ke(e,r,a){let n=Math.sin(a),s=Math.cos(a),f=e[0]-r[0],u=e[1]-r[1],l=f*s-u*n,h=f*n+u*s;return[l+r[0],h+r[1]]}function Ne(e,r,a){return H(e,U(Y(r,e),a))}function Ge(e,r,a){return H(e,U(r,a))}var{min:ye,PI:_t}=Math,Ze=.275,$e=_t+1e-4;function Ot(e,r={}){let{size:a=16,smoothing:n=.5,thinning:s=.5,simulatePressure:f=!0,easing:u=x=>x,start:l={},end:h={},last:k=!1}=r,{cap:$=!0,easing:E=x=>x*(2-x)}=l,{cap:C=!0,easing:v=x=>--x*x*x+1}=h;if(e.length===0||a<=0)return[];let p=e[e.length-1].runningLength,I=l.taper===!1?0:l.taper===!0?Math.max(a,p):l.taper,w=h.taper===!1?0:h.taper===!0?Math.max(a,p):h.taper,K=Math.pow(a*n,2),W=[],F=[],ie=e.slice(0,10).reduce((x,D)=>{let b=D.pressure;if(f){let S=ye(1,D.distance/a),ne=ye(1,1-S);b=ye(1,x+(ne-x)*(S*Ze))}return(x+b)/2},e[0].pressure),_=Je(a,s,e[e.length-1].pressure,u),ee,G=e[0].vector,R=e[0].point,te=R,Z=R,X=te,se=!1;for(let x=0;x<e.length;x++){let{pressure:D}=e[x],{point:b,vector:S,distance:ne,runningLength:B}=e[x];if(x<e.length-1&&p-B<3)continue;if(s){if(f){let Q=ye(1,ne/a),O=ye(1,1-Q);D=ye(1,ie+(O-ie)*(Q*Ze))}_=Je(a,s,D,u)}else _=a/2;ee===void 0&&(ee=_);let me=B<I?E(B/I):1,Ce=p-B<w?v((p-B)/w):1;_=Math.max(.01,_*Math.min(me,Ce));let ce=(x<e.length-1?e[x+1]:e[x]).vector,A=x<e.length-1?Ue(S,ce):1,xe=Ue(S,G)<0&&!se,ve=A!==null&&A<0;if(xe||ve){let Q=U(Se(G),_);for(let O=1/13,j=0;j<=1;j+=O)Z=ke(Y(b,Q),b,$e*j),W.push(Z),X=ke(H(b,Q),b,$e*-j),F.push(X);R=Z,te=X,ve&&(se=!0);continue}if(se=!1,x===e.length-1){let Q=U(Se(S),_);W.push(Y(b,Q)),F.push(H(b,Q));continue}let he=U(Se(Ne(ce,S,A)),_);Z=Y(b,he),(x<=1||He(R,Z)>K)&&(W.push(Z),R=Z),X=H(b,he),(x<=1||He(te,X)>K)&&(F.push(X),te=X),ie=D,G=S}let q=e[0].point.slice(0,2),N=e.length>1?e[e.length-1].point.slice(0,2):H(e[0].point,[1,1]),fe=[],P=[];if(e.length===1){if(!(I||w)||k){let x=Ge(q,at(Se(Y(q,N))),-(ee||_)),D=[];for(let b=1/13,S=b;S<=1;S+=b)D.push(ke(x,q,$e*2*S));return D}}else{if(!(I||w&&e.length===1))if($)for(let D=1/13,b=D;b<=1;b+=D){let S=ke(F[0],q,$e*b);fe.push(S)}else{let D=Y(W[0],F[0]),b=U(D,.5),S=U(D,.51);fe.push(Y(q,b),Y(q,S),H(q,S),H(q,b))}let x=Se($t(e[e.length-1].vector));if(w||I&&e.length===1)P.push(N);else if(C){let D=Ge(N,x,_);for(let b=1/29,S=b;S<1;S+=b)P.push(ke(D,N,$e*3*S))}else P.push(H(N,U(x,_)),H(N,U(x,_*.99)),Y(N,U(x,_*.99)),Y(N,U(x,_)))}return W.concat(P,F.reverse(),fe)}function Tt(e,r={}){var a;let{streamline:n=.5,size:s=16,last:f=!1}=r;if(e.length===0)return[];let u=.15+(1-n)*.85,l=Array.isArray(e[0])?e:e.map(({x:v,y:p,pressure:I=.5})=>[v,p,I]);if(l.length===2){let v=l[1];l=l.slice(0,-1);for(let p=1;p<5;p++)l.push(Ne(l[0],v,p/4))}l.length===1&&(l=[...l,[...H(l[0],[1,1]),...l[0].slice(2)]]);let h=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,$=0,E=h[0],C=l.length-1;for(let v=1;v<l.length;v++){let p=f&&v===C?l[v].slice(0,2):Ne(E.point,l[v],u);if(It(E.point,p))continue;let I=Dt(p,E.point);if($+=I,v<C&&!k){if($<s)continue;k=!0}E={point:p,pressure:l[v][2]>=0?l[v][2]:.5,vector:at(Y(E.point,p)),distance:I,runningLength:$},h.push(E)}return h[0].vector=((a=h[1])==null?void 0:a.vector)||[0,0],h}function Mt(e,r={}){return Ot(Tt(e,r),r)}var Nt=Mt;const ze=(e,r)=>(e+r)/2;function qt(e,r=!0){const a=e.length;if(a<4)return"";let n=e[0],s=e[1];const f=e[2];let u=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${ze(s[0],f[0]).toFixed(2)},${ze(s[1],f[1]).toFixed(2)} T`;for(let l=2,h=a-1;l<h;l++)n=e[l],s=e[l+1],u+=`${ze(n[0],s[0]).toFixed(2)},${ze(n[1],s[1]).toFixed(2)} `;return r&&(u+="Z"),u}function Qe(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),qe(r,e.points,e.size),r}function qe(e,r,a){e.setAttributeNS(null,"d",qt(Nt(r,{size:a,smoothing:.5,streamline:.25,thinning:.5})))}function Ve(e,r,a){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),a)}function et(e,r){const a=[],n=/^\s*$/;function s(f){if(f.nodeType==3)(r||!n.test(f.nodeValue||""))&&a.push(f);else for(var u=0,l=f.childNodes.length;u<l;++u)s(f.childNodes[u])}return s(e),a}const tt=(e,r)=>{e.forEach(a=>{const n=a.textContent,s=r(n||""),f=document.createRange().createContextualFragment(s);a.replaceWith(f)})},Pt=(e,r,a)=>{const n=a(r);let s=et(e,!0);tt(s,f=>Ve(f,[r],'<mark class="exact">$1</mark>')),s=et(e,!0),tt(s,f=>Ve(f,n,"<mark>$1</mark>"))};function At(){return new Promise((e,r)=>{const a=document.createElement("input");a.type="file",a.onchange=()=>{var f;const n=(f=a.files)==null?void 0:f[0];if(!n)return;const s=new FileReader;s.readAsText(n,"UTF-8"),s.onload=()=>{var u;e(((u=s.result)==null?void 0:u.toString())||"")},s.onerror=r},a.click()})}function jt(e){document.addEventListener("paste",r=>{const a=r.clipboardData||r.originalEvent.clipboardData,n=a.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=a.items;for(let f in s){const u=s[f];if(u.kind==="file"){const l=u.getAsFile(),h=new FileReader;h.onload=()=>{const k=h.result;k!=null&&k.startsWith("data:image")&&e(k)},h.readAsDataURL(l)}}})}async function Ft(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable();await n.write(e),await n.close()}const V=[];let ae=-1;const Rt=50;function M(e){for(V.splice(ae+1,V.length),V.push(e);V.length>Rt;)V.shift();ae=V.length-1,V[ae].redo()}function Xt(){const e=V[ae];return e?(e.undo(),--ae,e.name):(ae=-1,!1)}function Yt(){++ae;const e=V[ae];return e?(e==null||e.redo(),e==null?void 0:e.name):(ae=V.length-1,!1)}(async()=>{let e=_e("current"),r=_e("grid"),a=_e("areas"),n,s=1;const f=()=>{s=Math.pow(1.1,n.zoom)},u=document.querySelector("#controls"),l=document.querySelector("#map-container"),h=document.querySelector("#map"),k=document.querySelector("#images"),$=document.querySelector("#drawings"),E=document.querySelector("#pins"),C=document.querySelector("#text"),v=document.querySelector("#about"),p=document.querySelector("#cursor"),I=document.querySelector("#btn-about"),w=document.querySelector("#areas"),K=document.querySelector("#btn-area-add"),W=document.querySelector("#btn-area-rename"),F=document.querySelector("#btn-area-delete"),ie=document.querySelector("#btn-grid"),_=document.querySelector("#btn-save"),ee=document.querySelector("#btn-export"),G=document.querySelector("#btn-import"),R=document.querySelector("#btn-select"),te=document.querySelector("#btn-pan"),Z=document.querySelector("#btn-text"),X=document.querySelectorAll('#options-colour > input[type="radio"]'),se=document.querySelector("#stroke"),q=document.querySelectorAll('#options-pin input[type="radio"]'),N=document.querySelector("#custom-pin"),fe=document.querySelector("#custom-pin-entry"),P=document.querySelector("#context"),x=document.querySelector("#context-delete"),D=document.querySelector("#context-pin"),b=document.querySelector("#context-datalist"),S=document.querySelector("#context-notes"),ne=document.querySelector("#context-images"),B=document.querySelector("#search"),me=document.querySelector("#search-results"),Ce=document.querySelector("#toasts");if(!u||!l||!h||!k||!$||!E||!C||!v||!p||!R||!te||!Z||!I||!w||!K||!W||!F||!ie||!_||!ee||!G||!X.length||!se||!q.length||!N||!fe||!P||!x||!b||!D||!S||!ne||!B||!me||!Ce)throw new Error("Could not find elements");const ce=t=>{const o=document.createElement("li");o.textContent=t,Ce.appendChild(o),setTimeout(()=>{o.remove()},2500)},A=t=>{e=t,n=a[t],w.value=t,de(),Q()},xe=()=>{w.textContent="",Object.keys(a).sort().forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,t===e&&(o.selected=!0),w.appendChild(o)})},ve=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},he=()=>{E.textContent="",n.pins.forEach((t,o)=>{const i=t.type,c=document.createElement("div");c.textContent=i||"???",c.style.top=`${t.y}px`,c.style.left=`${t.x}px`,E.appendChild(c),c.dataset.idx=o.toString(10)}),ve()},Q=()=>{xe(),he(),C.textContent="",n.text.forEach((t,o)=>{const i=document.createElement("div");try{i.contentEditable="plaintext-only"}catch{i.contentEditable="true"}i.style.top=`${t.y}px`,i.style.left=`${t.x}px`,i.style.fontSize=`${t.size*100}%`,i.textContent=t.text,i.dataset.idx=o.toString(10),C.appendChild(i),i.addEventListener("input",()=>{n.text[parseInt(i.dataset.idx||"",10)].text=i.textContent||"",y()}),i.addEventListener("blur",()=>{var c;(c=i.textContent)!=null&&c.trim()||(n.text.splice(parseInt(i.dataset.idx||"",10),1),Ke(i),i.remove(),y())})}),we(),pe(),f(),ge()};I.addEventListener("click",()=>{v.classList.toggle("show")}),w.addEventListener("change",()=>{const t=e,o=w.value;t!==o&&M({name:"change area",undo(){A(t)},redo(){A(o)}})}),K.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(a).length}`);if(!t)return;if(a[t]){window.alert("error: an area with that name already exists!");return}const o=e,i={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};M({name:"create area",undo(){delete a[t],xe(),A(o),y()},redo(){a[t]=i,xe(),A(t),y()}})}),W.addEventListener("click",()=>{const t=e,o=window.prompt("rename area",e);!o||o===t||M({name:"rename area",undo(){a[t]=a[o],delete a[o],e=t,w.selectedOptions[0].value=w.selectedOptions[0].textContent=t,y()},redo(){a[o]=a[t],delete a[t],e=o,w.selectedOptions[0].value=w.selectedOptions[0].textContent=o,y()}})}),F.addEventListener("click",()=>{const t=e;if(Object.keys(a).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const o=Object.keys(a).filter(m=>m!==t)[0],i=a[t],c=w.selectedOptions[0],d=w.selectedIndex;M({name:"delete area",undo(){a[t]=i,w.insertBefore(c,w.children[d]),A(t),y()},redo(){delete a[t],c.remove(),A(o),y()}})}),ie.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",o=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!o)return;const i=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!i)return;const c=r[0],d=r[1],m=parseInt(o,10),z=parseInt(i,10);M({name:"resize grid",undo(){r[0]=c,r[1]=d,pe(),y()},redo(){r[0]=m,r[1]=z,pe(),y()}})}),_.addEventListener("click",async()=>{await Oe("grid",r),await Oe("current",e),await Oe("areas",a),ce("saved"),y(!1)}),ee.addEventListener("click",async()=>{try{const t=`{ "grid": ${JSON.stringify(r)}, "current": ${JSON.stringify(e)}, "areas": ${JSON.stringify(a)} }`;await Ft(t),ce("exported"),y(!1)}catch(t){We(t),window.alert(`error: failed to export - ${t.message}`)}}),G.addEventListener("click",async()=>{try{const t=await At(),o=JSON.parse(t);if(typeof o.current!="string"||typeof o.areas!="object")throw new Error("invalid file");const i=r,c=o.grid,d=a,m=o.areas,z=e,L=o.current;ce("imported"),M({name:"import",undo(){r=i,a=d,A(z),y()},redo(){r=c,a=m,A(L),y()}})}catch(t){We(t),window.alert(`error: failed to import - ${t.message}`)}}),X.forEach(t=>{t.style.backgroundColor=t.value}),q.forEach(t=>{var i;const o=document.createElement("span");o.textContent=t.value||"",(i=t.parentElement)==null||i.appendChild(o)});let O="select",j="",Pe=Array.from(X)[0].value,Ae=Array.from(q)[0].value;const J=(t,o="",i=!0)=>{var c;O=t,j=o,O==="select"?(p.textContent="",p.className="select",l.style.cursor="auto"):O==="pan"?(p.textContent="",p.className="pan",l.style.cursor="grab"):O==="text"?(p.textContent="Type here...",p.className="text",l.style.cursor="text"):O==="pin"?(Ae=j,p.textContent=j,p.className="pin",l.style.cursor="none"):O==="draw"&&(Pe=j,p.style.setProperty("--colour",j),p.textContent="",p.className="draw",l.style.cursor="crosshair"),i&&((c=document.querySelector(`input[type="radio"][name="tool"][value="${j||O}"]`))==null||c.click())};X.forEach(t=>{t.addEventListener("change",()=>{J("draw",t.value,!1)})}),fe.addEventListener("input",()=>{N.value=fe.value,N.nextElementSibling.textContent=N.value,N.disabled=!N.value.trim()}),q.forEach(t=>{t.addEventListener("change",()=>{J("pin",t.value,!1)})}),R.addEventListener("change",()=>{J("select",void 0,!1)}),te.addEventListener("change",()=>{J("pan",void 0,!1)}),Z.addEventListener("change",()=>{J("text",void 0,!1)});const je=()=>{p.style.setProperty("--size",`${parseInt(se.value,10)}px`)};se.addEventListener("input",je);const it=(t,o)=>{const i=parseFloat(se.value)/(s*2),c=Qe({points:[],colour:o,size:i});$.appendChild(c);let d=[];const m=10;let z=0;const L=oe=>{const Ie=Date.now(),ue=Fe(oe.clientX,oe.clientY);ue.x/=s,ue.y/=s,Ie-z<m?(d[d.length-1][0]=ue.x,d[d.length-1][1]=ue.y):(z=Ie,d=kt(d,2/s),d.push([ue.x,ue.y])),qe(c,d,i)};L(t);const T=()=>{window.removeEventListener("pointermove",L),qe(c,d,i);const oe={points:d,size:i,colour:o};M({name:"draw",undo(){n.drawings.pop(),we(),y()},redo(){n.drawings.push(oe),we(),y()}})};window.addEventListener("pointermove",L),window.addEventListener("pointerup",T,{once:!0})},ge=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;l.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,l.style.backgroundPositionX=`${-n.offset.x}px`,l.style.backgroundPositionY=`${-n.offset.y}px`,h.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,ve()},we=()=>{$.textContent="",n.drawings.forEach(t=>{$.appendChild(Qe(t))})},pe=()=>{k.textContent="";const[t,o,i,c]=Object.keys(n.images).length?Object.keys(n.images).map(d=>d.split("|").map(m=>parseInt(m,10))).reduce(([d,m,z,L],[T,oe])=>[Math.min(d,T),Math.min(m,oe),Math.max(z,T),Math.max(L,oe)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0];for(let d=o-1;d<=c+1;++d)for(let m=t-1;m<=i+1;++m){const z=n.images[`${m}|${d}`],L=document.createElement(z?"img":"div");L.src=z,L.draggable=!1,L.dataset.x=m.toString(10),L.dataset.y=d.toString(10),L.style.width=`${r[0]}px`,L.style.height=`${r[1]}px`,L.style.transform=`translate(${m*r[0]}px, ${d*r[1]}px)`,k.appendChild(L)}},Fe=(t,o)=>({x:t+n.offset.x,y:o+n.offset.y}),Re=()=>({x:parseFloat(p.style.left),y:parseFloat(p.style.top)}),Xe=()=>{const t=Re(),o=Fe(t.x,t.y);return o.x/=s,o.y/=s,o},Ye=t=>{const o={...n.offset},i={x:t.clientX,y:t.clientY},c=l.style.cursor;l.style.cursor="grabbing";const d=z=>{n.offset.x=-(z.clientX-i.x)+o.x,n.offset.y=-(z.clientY-i.y)+o.y,g&&le(g,re),ge()},m=()=>{window.removeEventListener("pointermove",d),l.style.cursor=c};window.addEventListener("pointermove",d),window.addEventListener("pointerup",m,{once:!0})},st=(t,o,i)=>{const c={x:t.clientX,y:t.clientY},d={x:parseInt(o.style.left,10),y:parseInt(o.style.top,10)},m=l.style.cursor;l.style.cursor="move";const z=T=>{i((T.clientX-c.x)/s+d.x,(T.clientY-c.y)/s+d.y)},L=()=>{window.removeEventListener("pointermove",z),l.style.cursor=m;const T={x:parseInt(o.style.left,10),y:parseInt(o.style.top,10)};(T.x!==d.x||T.y!==d.y)&&M({name:"move",undo(){i(d.x,d.y),y()},redo(){i(T.x,T.y),y()}})};window.addEventListener("pointermove",z),window.addEventListener("pointerup",L,{once:!0})};let g=null,re="";const Ee=t=>{var c;if(t!==g)return;const o=n.pins[parseInt(t.dataset.idx||"",10)];ne.textContent="";const i=(((c=o.images)==null?void 0:c.split("|"))||[]).filter(d=>d);if(i.forEach(d=>{const m=document.createElement("img");m.src=d,m.draggable=!1;const z=document.createElement("li"),L=document.createElement("button");L.title="open in new tab",L.textContent="🔍",L.addEventListener("click",()=>{window.open(d,"_blank")});const T=document.createElement("button");T.title="delete",T.textContent="✖",T.addEventListener("click",()=>{z.remove();const oe=o.images,Ie=Array.from(ne.querySelectorAll("img")).map(ue=>ue.src).join("|");M({name:"delete image in pin",undo(){o.images=oe,Ee(t),y()},redo(){o.images=Ie,Ee(t),y()}})}),z.appendChild(L),z.appendChild(T),z.appendChild(m),ne.appendChild(z)}),!i.length){const d=document.createElement("li");d.textContent="paste to add image",d.className="null",ne.appendChild(d)}},le=(t,o)=>{if(de(),g=t,re=o,o==="pin"){const i=n.pins[parseInt(g.dataset.idx||"",10)];P.classList.add("show");const c=g.getBoundingClientRect();g.classList.add("selected"),D.value=i.type||"???",S.value=i.notes||"",Ee(t),P.style.top=`${c.bottom<l.clientHeight/2?c.bottom:c.top-P.clientHeight}px`,P.style.left=`${c.right<l.clientWidth/2?c.right:c.left-P.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",d=>{d.target&&![P,g].includes(d.target)&&!(P.contains(d.target)||!(g!=null&&g.contains(d.target)))&&de()},{once:!0})})}else(o==="image"||o==="drawing")&&g.classList.add("selected")},de=()=>{P.classList.remove("show"),g==null||g.classList.remove("selected"),g=null},Ke=t=>{let o=t.nextSibling;for(;o;)o.dataset.idx=(parseInt(o.dataset.idx||"",10)-1).toString(10),o=o.nextSibling};x.addEventListener("click",()=>{if(!g)return;const t=parseInt(g.dataset.idx||"",10),o=n.pins[t];M({name:"delete pin",undo(){n.pins.splice(t,0,o),he(),le(E.children[t],"pin"),y()},redo(){n.pins.splice(t,1),he(),de(),y()}})}),D.addEventListener("input",()=>{if(!g)return;const t=n.pins[parseInt(g.dataset.idx||"",10)];t.type=D.value||"???",g.textContent=t.type,y()}),S.addEventListener("input",()=>{if(!g)return;const t=n.pins[parseInt(g.dataset.idx||"",10)];t.notes=S.value,y()}),l.addEventListener("pointerdown",t=>{const o=document.activeElement;if(u.contains(o)&&(o==null||o.blur()),t.button===1){t.preventDefault(),Ye(t);return}else if(t.button===0){if(O==="select"){de();const i=document.elementFromPoint(t.clientX,t.clientY);if(i!=null&&i.closest("#pins")){o==null||o.blur(),t.preventDefault(),le(i,"pin");const c=n.pins[parseInt(i.dataset.idx||"",10)];st(t,i,(d,m)=>{i.style.left=`${d}px`,i.style.top=`${m}px`,c.x=d,c.y=m,le(i,"pin")})}else i!=null&&i.closest("#images")?(o==null||o.blur(),t.preventDefault(),le(i,"image")):i!=null&&i.closest("#drawings")&&(o==null||o.blur(),t.preventDefault(),le(i,"drawing"));return}else if(O==="pan")t.preventDefault(),Ye(t);else if(O==="pin"){t.preventDefault();const i=j,c=document.createElement("div");c.textContent=i;const d=Xe();c.style.top=`${d.y}px`,c.style.left=`${d.x}px`,c.dataset.idx=n.pins.length.toString(10),R.click();const m={x:d.x,y:d.y,type:i,notes:"",images:""};M({name:"place pin",undo(){de(),n.pins.pop(),c.remove(),ge(),y()},redo(){E.appendChild(c),n.pins.push(m),ge(),le(c,"pin"),y()}})}else if(O==="draw")t.preventDefault(),it(t,j);else if(O==="text"){t.preventDefault();const i=document.createElement("div");try{i.contentEditable="plaintext-only"}catch{i.contentEditable="true"}const c=Xe();i.style.top=`${c.y}px`,i.style.left=`${c.x}px`,i.style.fontSize="200%",i.dataset.idx=n.text.length.toString(10),R.click(),i.addEventListener("input",()=>{n.text[parseInt(i.dataset.idx||"",10)].text=i.textContent||"",y()}),i.addEventListener("blur",()=>{var m;(m=i.textContent)!=null&&m.trim()||(n.text.splice(parseInt(i.dataset.idx||"",10),1),Ke(i),i.remove(),y())});const d={x:c.x,y:c.y,text:"",size:2};M({name:"place text",undo(){i.remove(),n.text.pop(),y()},redo(){C.appendChild(i),n.text.push(d),i.focus(),y()}})}}}),l.addEventListener("pointermove",t=>{p.style.left=`${t.clientX}px`,p.style.top=`${t.clientY}px`});const ct=t=>{const o=g;if(!o)return;const i=n.pins[parseInt(o.dataset.idx||"",10)],c=i.images,d=[i.images,t].filter(m=>m).join("|");M({name:"add image to pin",undo(){i.images=c,Ee(o),y()},redo(){i.images=d,Ee(o),y()}})},lt=t=>{if(!g)return;const o=`${g.dataset.x}|${g.dataset.y}`,i=n.images[o];M({name:"place image",undo(){i?n.images[o]=i:delete n.images[o],pe(),y()},redo(){n.images[o]=t,pe(),y()}})};jt(t=>{g&&re==="pin"?ct(t):g&&re==="image"&&lt(t)});let De=!1;window.addEventListener("keydown",t=>{var i;const o=document.activeElement;if((o==null?void 0:o.tagName)==="TEXTAREA"||(o==null?void 0:o.tagName)==="INPUT"||(o==null?void 0:o.contentEditable)==="plaintext-only"||(o==null?void 0:o.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&o.parentElement===C){t.preventDefault();const c=n.text[parseInt(o.dataset.idx||"",10)];c.size*=2,o.style.fontSize=`${c.size*100}%`,y()}else if(t.ctrlKey&&t.key==="-"&&o.parentElement===C){t.preventDefault();const c=n.text[parseInt(o.dataset.idx||"",10)];c.size/=2,o.style.fontSize=`${c.size*100}%`,y()}return}if(t.ctrlKey&&t.key==="z"){const c=Xt();c!==!1&&ce(["undo",c].filter(d=>d).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const c=Yt();c!==!1&&ce(["redo",c].filter(d=>d).join(" - "))}if(t.key==="Escape"&&de(),(t.key==="Backspace"||t.key==="Delete")&&g&&re==="image"){const c=`${g.dataset.x}|${g.dataset.y}`,d=n.images[c];M({name:"delete image",undo(){n.images[c]=d,pe(),y()},redo(){delete n.images[c],pe(),y()}})}if((t.key==="Backspace"||t.key==="Delete")&&g&&re==="drawing"){const c=Array.from(((i=g.parentElement)==null?void 0:i.children)||[]).indexOf(g),d=n.drawings[c];M({name:"delete drawing",undo(){n.drawings.splice(c,0,d),we(),y()},redo(){n.drawings.splice(c,1),we(),y()}})}if((t.key==="Backspace"||t.key==="Delete")&&g&&re==="pin"&&x.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),_.click();return}if(t.ctrlKey&&t.key==="c"&&g&&re==="image"){t.preventDefault(),navigator.clipboard.writeText(g.src);return}if(!De&&t.key===" "){De=!0;const c=O,d=j;J("pan"),window.addEventListener("keyup",m=>{m.key===" "&&(De=!1,J(c,d))})}if(t.key==="q"){t.preventDefault(),J("select");return}if(t.key==="t"){t.preventDefault(),J("text");return}if(t.key==="b"){t.preventDefault(),J("draw",Pe);return}if(t.key==="p"){t.preventDefault(),J("pin",Ae);return}}),l.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const o=s;f();const i=s-o,c=Re(),d={x:(c.x+n.offset.x)/o,y:(c.y+n.offset.y)/o};n.offset.x+=d.x*i,n.offset.y+=d.y*i,ge(),g&&le(g,re)});const dt=(t,o)=>{n.offset.x=t*s-l.clientWidth/2-me.clientWidth/2,n.offset.y=o*s-l.clientHeight/2,ge()};let be;B.addEventListener("focus",()=>{be=new xt("key"),be.addDocuments(Object.entries(a).flatMap(([t,{pins:o,text:i}])=>o.map((c,d)=>({key:`${t}-p-${d}`,area:t,text:[t,c.type,c.notes].filter(m=>m).join(" > "),original:c})).concat(i.map((c,d)=>({key:`${t}-t-${d}`,area:t,text:[t,c.text].filter(m=>m).join(" > "),original:c}))))),be.addIndex("text")}),B.addEventListener("input",()=>{const t=be.search(B.value);me.textContent="",t.forEach(o=>{const i=document.createElement("li"),c=document.createElement("span");c.innerHTML=o.text,Pt(c,B.value,be.tokenizer.tokenize);const d=document.createElement("button");d.title="focus",d.textContent="🔍",d.addEventListener("click",()=>{de();const m=o.area;e!==m&&A(m),dt(o.original.x,o.original.y)}),d.addEventListener("dblclick",()=>{n.zoom=1,f()}),i.appendChild(d),i.appendChild(c),me.appendChild(i)})}),Array.from(q).forEach(t=>{const o=document.createElement("option");o.value=t.value,b.appendChild(o)}),A(e),je()})();
