import{g as ht,a as _e,s as De}from"./Storage-DSuOIonK.js";import{e as Be}from"./index-BPqf1-sd.js";var yt=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],d="",f=0,c=n.length;f<c;++f)d+=n.charAt(f),s.push(d);return s},e}(),gt=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function je(e,r){r=r||[],e=e||{};for(var o=e,n=0;n<r.length;n++)if(o=o[r[n]],o==null)return null;return o}var xt=function(){function e(o){this._uidFieldName=o,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,d){this._tokenToIdfCache={};var f=this._tokenMap,c;typeof f[n]!="object"?f[n]=c={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(c=f[n],c.$totalNumOccurrences++);var h=c.$uidMap;typeof h[s]!="object"?(c.$numDocumentOccurrences++,h[s]={$document:d,$numTokenOccurrences:1}):h[s].$numTokenOccurrences++},r.search=function(n,s){for(var d={},f=0,c=n.length;f<c;f++){var h=n[f],k=this._tokenMap[h];if(!k)return[];if(f===0)for(var x=Object.keys(k.$uidMap),p=0,y=x.length;p<y;p++){var g=x[p];d[g]=k.$uidMap[g].$document}else for(var x=Object.keys(d),p=0,y=x.length;p<y;p++){var g=x[p];typeof k.$uidMap[g]!="object"&&delete d[g]}}var m=[];for(var g in d)m.push(d[g]);var I=this._createCalculateTfIdf();return m.sort(function(b,Y){return I(n,Y,s)-I(n,b,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(f,c){if(!s[f]){var h=typeof n[f]<"u"?n[f].$numDocumentOccurrences:0;s[f]=1+Math.log(c.length/(1+h))}return s[f]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,d=this._createCalculateIdf();return function(c,h,k){for(var x=0,p=0,y=c.length;p<y;++p){var g=c[p],m=d(g,k);m===1/0&&(m=0);var I;s instanceof Array?I=h&&je(h,s):I=h&&h[s];var b=typeof n[g]<"u"&&typeof n[g].$uidMap[I]<"u"?n[g].$uidMap[I].$numTokenOccurrences:0;x+=b*m}return x}},e}(),vt=/[^a-zÐ°-ÑÑ‘0-9\-']+/i,wt=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(vt).filter(function(s){return s})},e}();function We(e,r){for(var o=0;o<r.length;o++){var n=r[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function bt(e,r,o){return r&&We(e.prototype,r),o&&We(e,o),e}var Et=function(){function e(o){if(!o)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=o,this._indexStrategy=new yt,this._searchIndex=new xt(o),this._sanitizer=new gt,this._tokenizer=new wt,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var d=this._indexStrategy,f=this._sanitizer,c=this._searchIndex,h=this._tokenizer,k=this._uidFieldName,x=0,p=n.length;x<p;x++){var y=n[x],g;k instanceof Array?g=je(y,k):g=y[k];for(var m=0,I=s.length;m<I;m++){var b,Y=s[m];if(Y instanceof Array?b=je(y,Y):b=y[Y],b!=null&&typeof b!="string"&&b.toString&&(b=b.toString()),typeof b=="string")for(var B=h.tokenize(f.sanitize(b)),F=0,ae=B.length;F<ae;F++)for(var _=B[F],ee=d.expandToken(_),J=0,K=ee.length;J<K;J++){var te=ee[J];c.indexDocument(te,g,y)}}}},bt(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),ze={exports:{}};function St(e,r){var o=e[0]-r[0],n=e[1]-r[1];return o*o+n*n}var kt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;for(var n=o*o,s=r[0],d=[s],f,c=1,h=r.length;c<h;c++)f=r[c],St(f,s)>n&&(d.push(f),s=f);return s!==f&&d.push(f),d};function It(e,r,o){var n=r[0],s=r[1],d=o[0]-n,f=o[1]-s;if(d!==0||f!==0){var c=((e[0]-n)*d+(e[1]-s)*f)/(d*d+f*f);c>1?(n=o[0],s=o[1]):c>0&&(n+=d*c,s+=f*c)}return d=e[0]-n,f=e[1]-s,d*d+f*f}function Te(e,r,o,n,s){for(var d=n,f,c=r+1;c<o;c++){var h=It(e[c],e[r],e[o]);h>d&&(f=c,d=h)}d>n&&(f-r>1&&Te(e,r,f,n,s),s.push(e[f]),o-f>1&&Te(e,f,o,n,s))}var Ct=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;var n=o*o,s=r.length-1,d=[r[0]];return Te(r,0,s,n,d),d.push(r[s]),d},nt=kt,rt=Ct;ze.exports=function(r,o){return r=nt(r,o),r=rt(r,o),r};ze.exports.radialDistance=nt;ze.exports.douglasPeucker=rt;var $t=ze.exports;const Ot=ht($t);let ot=!1;function E(e=!0){ot=e}window.addEventListener("beforeunload",function(e){if(!ot)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function He(e,r,o,n=s=>s){return e*n(.5-r*(.5-o))}function zt(e){return[-e[0],-e[1]]}function G(e,r){return[e[0]+r[0],e[1]+r[1]]}function X(e,r){return[e[0]-r[0],e[1]-r[1]]}function U(e,r){return[e[0]*r,e[1]*r]}function Lt(e,r){return[e[0]/r,e[1]/r]}function Se(e){return[e[1],-e[0]]}function Ue(e,r){return e[0]*r[0]+e[1]*r[1]}function _t(e,r){return e[0]===r[0]&&e[1]===r[1]}function Dt(e){return Math.hypot(e[0],e[1])}function jt(e){return e[0]*e[0]+e[1]*e[1]}function Ge(e,r){return jt(X(e,r))}function it(e){return Lt(e,Dt(e))}function Tt(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function ke(e,r,o){let n=Math.sin(o),s=Math.cos(o),d=e[0]-r[0],f=e[1]-r[1],c=d*s-f*n,h=d*n+f*s;return[c+r[0],h+r[1]]}function Me(e,r,o){return G(e,U(X(r,e),o))}function Je(e,r,o){return G(e,U(r,o))}var{min:ge,PI:Mt}=Math,Ze=.275,Ie=Mt+1e-4;function Nt(e,r={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:d=!0,easing:f=S=>S,start:c={},end:h={},last:k=!1}=r,{cap:x=!0,easing:p=S=>S*(2-S)}=c,{cap:y=!0,easing:g=S=>--S*S*S+1}=h;if(e.length===0||o<=0)return[];let m=e[e.length-1].runningLength,I=c.taper===!1?0:c.taper===!0?Math.max(o,m):c.taper,b=h.taper===!1?0:h.taper===!0?Math.max(o,m):h.taper,Y=Math.pow(o*n,2),B=[],F=[],ae=e.slice(0,10).reduce((S,z)=>{let C=z.pressure;if(d){let $=ge(1,z.distance/o),ne=ge(1,1-$);C=ge(1,S+(ne-S)*($*Ze))}return(S+C)/2},e[0].pressure),_=He(o,s,e[e.length-1].pressure,f),ee,J=e[0].vector,K=e[0].point,te=K,Z=K,R=te,se=!1;for(let S=0;S<e.length;S++){let{pressure:z}=e[S],{point:C,vector:$,distance:ne,runningLength:W}=e[S];if(S<e.length-1&&m-W<3)continue;if(s){if(d){let Q=ge(1,ne/o),D=ge(1,1-Q);z=ge(1,ae+(D-ae)*(Q*Ze))}_=He(o,s,z,f)}else _=o/2;ee===void 0&&(ee=_);let me=W<I?p(W/I):1,Ce=m-W<b?g((m-W)/b):1;_=Math.max(.01,_*Math.min(me,Ce));let ce=(S<e.length-1?e[S+1]:e[S]).vector,A=S<e.length-1?Ue($,ce):1,xe=Ue($,J)<0&&!se,ve=A!==null&&A<0;if(xe||ve){let Q=U(Se(J),_);for(let D=1/13,P=0;P<=1;P+=D)Z=ke(X(C,Q),C,Ie*P),B.push(Z),R=ke(G(C,Q),C,Ie*-P),F.push(R);K=Z,te=R,ve&&(se=!0);continue}if(se=!1,S===e.length-1){let Q=U(Se($),_);B.push(X(C,Q)),F.push(G(C,Q));continue}let he=U(Se(Me(ce,$,A)),_);Z=X(C,he),(S<=1||Ge(K,Z)>Y)&&(B.push(Z),K=Z),R=G(C,he),(S<=1||Ge(te,R)>Y)&&(F.push(R),te=R),ae=z,J=$}let N=e[0].point.slice(0,2),M=e.length>1?e[e.length-1].point.slice(0,2):G(e[0].point,[1,1]),fe=[],q=[];if(e.length===1){if(!(I||b)||k){let S=Je(N,it(Se(X(N,M))),-(ee||_)),z=[];for(let C=1/13,$=C;$<=1;$+=C)z.push(ke(S,N,Ie*2*$));return z}}else{if(!(I||b&&e.length===1))if(x)for(let z=1/13,C=z;C<=1;C+=z){let $=ke(F[0],N,Ie*C);fe.push($)}else{let z=X(B[0],F[0]),C=U(z,.5),$=U(z,.51);fe.push(X(N,C),X(N,$),G(N,$),G(N,C))}let S=Se(zt(e[e.length-1].vector));if(b||I&&e.length===1)q.push(M);else if(y){let z=Je(M,S,_);for(let C=1/29,$=C;$<1;$+=C)q.push(ke(z,M,Ie*3*$))}else q.push(G(M,U(S,_)),G(M,U(S,_*.99)),X(M,U(S,_*.99)),X(M,U(S,_)))}return B.concat(q,F.reverse(),fe)}function qt(e,r={}){var o;let{streamline:n=.5,size:s=16,last:d=!1}=r;if(e.length===0)return[];let f=.15+(1-n)*.85,c=Array.isArray(e[0])?e:e.map(({x:g,y:m,pressure:I=.5})=>[g,m,I]);if(c.length===2){let g=c[1];c=c.slice(0,-1);for(let m=1;m<5;m++)c.push(Me(c[0],g,m/4))}c.length===1&&(c=[...c,[...G(c[0],[1,1]),...c[0].slice(2)]]);let h=[{point:[c[0][0],c[0][1]],pressure:c[0][2]>=0?c[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,x=0,p=h[0],y=c.length-1;for(let g=1;g<c.length;g++){let m=d&&g===y?c[g].slice(0,2):Me(p.point,c[g],f);if(_t(p.point,m))continue;let I=Tt(m,p.point);if(x+=I,g<y&&!k){if(x<s)continue;k=!0}p={point:m,pressure:c[g][2]>=0?c[g][2]:.5,vector:it(X(p.point,m)),distance:I,runningLength:x},h.push(p)}return h[0].vector=((o=h[1])==null?void 0:o.vector)||[0,0],h}function At(e,r={}){return Nt(qt(e,r),r)}var Pt=At;const Oe=(e,r)=>(e+r)/2;function Ft(e,r=!0){const o=e.length;if(o<4)return"";let n=e[0],s=e[1];const d=e[2];let f=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${Oe(s[0],d[0]).toFixed(2)},${Oe(s[1],d[1]).toFixed(2)} T`;for(let c=2,h=o-1;c<h;c++)n=e[c],s=e[c+1],f+=`${Oe(n[0],s[0]).toFixed(2)},${Oe(n[1],s[1]).toFixed(2)} `;return r&&(f+="Z"),f}function Qe(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),Ne(r,e.points,e.size),r}function Ne(e,r,o){e.setAttributeNS(null,"d",Ft(Pt(r,{size:o,smoothing:.5,streamline:.25,thinning:.5})))}function Ve(e,r,o){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),o)}function et(e,r){const o=[],n=/^\s*$/;function s(d){if(d.nodeType==3)(r||!n.test(d.nodeValue||""))&&o.push(d);else for(var f=0,c=d.childNodes.length;f<c;++f)s(d.childNodes[f])}return s(e),o}const tt=(e,r)=>{e.forEach(o=>{const n=o.textContent,s=r(n||""),d=document.createRange().createContextualFragment(s);o.replaceWith(d)})},Kt=(e,r,o)=>{const n=o(r);let s=et(e,!0);tt(s,d=>Ve(d,[r],'<mark class="exact">$1</mark>')),s=et(e,!0),tt(s,d=>Ve(d,n,"<mark>$1</mark>"))};function at(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function st(e){return e}function ct(e,r){r=r||{};const o=r.delimiter||".",n=r.maxDepth,s=r.transformKey||st,d={};function f(c,h,k){k=k||1,Object.keys(c).forEach(function(x){const p=c[x],y=r.safe&&Array.isArray(p),g=Object.prototype.toString.call(p),m=at(p),I=g==="[object Object]"||g==="[object Array]",b=h?h+o+s(x):s(x);if(!y&&!m&&I&&Object.keys(p).length&&(!r.maxDepth||k<n))return f(p,b,k+1);d[b]=p})}return f(e),d}function lt(e,r){r=r||{};const o=r.delimiter||".",n=r.overwrite||!1,s=r.transformKey||st,d={};if(at(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function c(x){const p=Number(x);return isNaN(p)||x.indexOf(".")!==-1||r.object?x:p}function h(x,p,y){return Object.keys(y).reduce(function(g,m){return g[x+o+m]=y[m],g},p)}function k(x){const p=Object.prototype.toString.call(x),y=p==="[object Array]",g=p==="[object Object]";if(x){if(y)return!x.length;if(g)return!Object.keys(x).length}else return!0}return e=Object.keys(e).reduce(function(x,p){const y=Object.prototype.toString.call(e[p]);return!(y==="[object Object]"||y==="[object Array]")||k(e[p])?(x[p]=e[p],x):h(p,x,ct(e[p],r))},{}),Object.keys(e).forEach(function(x){const p=x.split(o).map(s);let y=c(p.shift()),g=c(p[0]),m=d;for(;g!==void 0;){if(y==="__proto__")return;const I=Object.prototype.toString.call(m[y]),b=I==="[object Object]"||I==="[object Array]";if(!n&&!b&&typeof m[y]<"u")return;(n&&!b||!n&&m[y]==null)&&(m[y]=typeof g=="number"&&!r.object?[]:{}),m=m[y],p.length>0&&(y=c(p.shift()),g=c(p[0]))}m[y]=lt(e[x],r)}),d}function Rt(){return new Promise((e,r)=>{const o=document.createElement("input");o.type="file",o.onchange=()=>{var d;const n=(d=o.files)==null?void 0:d[0];if(!n)return e("");const s=new FileReader;s.onload=()=>{const f=s.result,c=new TextDecoder("utf-8");let h="";const k=[],x=1e5;for(let p=0;p<f.byteLength;p+=x)for(h+=c.decode(f.slice(p,Math.min(f.byteLength,p+x)));h.includes(`,
`);){let[y,...g]=h.split(`,
`);h=g.join(`,
`),y=y.replace(/^\[\n/,""),y=y.replace(/^\]/,""),!(y==="["||y==="]")&&k.push(JSON.parse(y))}e(lt(Object.fromEntries(k)))},s.onerror=f=>{r(f)},s.readAsArrayBuffer(n)},o.click()})}function Xt(e){document.addEventListener("paste",r=>{const o=r.clipboardData||r.originalEvent.clipboardData,n=o.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=o.items;for(let d in s){const f=s[d];if(f.kind==="file"){const c=f.getAsFile(),h=new FileReader;h.onload=()=>{const k=h.result;k!=null&&k.startsWith("data:image")&&e(k)},h.readAsDataURL(c)}}})}async function Yt(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable(),s=Object.entries(ct(e));await n.write(`[
`);for(let d of s)await n.write(JSON.stringify(d)),d!==s[s.length-1]&&await n.write(`,
`);await n.write(`
]`),await n.close()}const V=[];let ie=-1;const Bt=50;function T(e){for(V.splice(ie+1,V.length),V.push(e);V.length>Bt;)V.shift();ie=V.length-1,V[ie].redo()}function Wt(){const e=V[ie];return e?(e.undo(),--ie,e.name):(ie=-1,!1)}function Ht(){++ie;const e=V[ie];return e?(e==null||e.redo(),e==null?void 0:e.name):(ie=V.length-1,!1)}(async()=>{let e=_e("current"),r=_e("grid"),o=_e("areas"),n,s=1;const d=()=>{s=Math.pow(1.1,n.zoom)},f=document.querySelector("#controls"),c=document.querySelector("#map-container"),h=document.querySelector("#map"),k=document.querySelector("#images"),x=document.querySelector("#drawings"),p=document.querySelector("#pins"),y=document.querySelector("#text"),g=document.querySelector("#about"),m=document.querySelector("#cursor"),I=document.querySelector("#btn-about"),b=document.querySelector("#areas"),Y=document.querySelector("#btn-area-add"),B=document.querySelector("#btn-area-rename"),F=document.querySelector("#btn-area-delete"),ae=document.querySelector("#btn-grid"),_=document.querySelector("#btn-save"),ee=document.querySelector("#btn-export"),J=document.querySelector("#btn-import"),K=document.querySelector("#btn-select"),te=document.querySelector("#btn-pan"),Z=document.querySelector("#btn-text"),R=document.querySelectorAll('#options-colour > input[type="radio"]'),se=document.querySelector("#stroke"),N=document.querySelectorAll('#options-pin input[type="radio"]'),M=document.querySelector("#custom-pin"),fe=document.querySelector("#custom-pin-entry"),q=document.querySelector("#context"),S=document.querySelector("#context-delete"),z=document.querySelector("#context-pin"),C=document.querySelector("#context-datalist"),$=document.querySelector("#context-notes"),ne=document.querySelector("#context-images"),W=document.querySelector("#search"),me=document.querySelector("#search-results"),Ce=document.querySelector("#toasts");if(!f||!c||!h||!k||!x||!p||!y||!g||!m||!K||!te||!Z||!I||!b||!Y||!B||!F||!ae||!_||!ee||!J||!R.length||!se||!N.length||!M||!fe||!q||!S||!C||!z||!$||!ne||!W||!me||!Ce)throw new Error("Could not find elements");const ce=t=>{const i=document.createElement("li");i.textContent=t,Ce.appendChild(i),setTimeout(()=>{i.remove()},2500)},A=t=>{e=t,n=o[t],b.value=t,ue(),Q()},xe=()=>{b.textContent="",Object.keys(o).sort().forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e&&(i.selected=!0),b.appendChild(i)})},ve=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},he=()=>{p.textContent="",n.pins.forEach((t,i)=>{const a=t.type,l=document.createElement("div");l.textContent=a||"???",l.style.top=`${t.y}px`,l.style.left=`${t.x}px`,p.appendChild(l),l.dataset.idx=i.toString(10)}),ve()},Q=()=>{xe(),he(),y.textContent="",n.text.forEach((t,i)=>{const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}a.style.top=`${t.y}px`,a.style.left=`${t.x}px`,a.style.fontSize=`${t.size*100}%`,a.textContent=t.text,a.dataset.idx=i.toString(10),y.appendChild(a),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var l;(l=a.textContent)!=null&&l.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ye(a),a.remove(),E())})}),we(),pe(),d(),ye()};I.addEventListener("click",()=>{g.classList.toggle("show")}),b.addEventListener("change",()=>{const t=e,i=b.value;t!==i&&T({name:"change area",undo(){A(t)},redo(){A(i)}})}),Y.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(o).length}`);if(!t)return;if(o[t]){window.alert("error: an area with that name already exists!");return}const i=e,a={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};T({name:"create area",undo(){delete o[t],xe(),A(i),E()},redo(){o[t]=a,xe(),A(t),E()}})}),B.addEventListener("click",()=>{const t=e,i=window.prompt("rename area",e);!i||i===t||T({name:"rename area",undo(){o[t]=o[i],delete o[i],e=t,b.selectedOptions[0].value=b.selectedOptions[0].textContent=t,E()},redo(){o[i]=o[t],delete o[t],e=i,b.selectedOptions[0].value=b.selectedOptions[0].textContent=i,E()}})}),F.addEventListener("click",()=>{const t=e;if(Object.keys(o).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const i=Object.keys(o).filter(v=>v!==t)[0],a=o[t],l=b.selectedOptions[0],u=b.selectedIndex;T({name:"delete area",undo(){o[t]=a,b.insertBefore(l,b.children[u]),A(t),E()},redo(){delete o[t],l.remove(),A(i),E()}})}),ae.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",i=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!i)return;const a=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!a)return;const l=r[0],u=r[1],v=parseInt(i,10),O=parseInt(a,10);T({name:"resize grid",undo(){r[0]=l,r[1]=u,pe(),E()},redo(){r[0]=v,r[1]=O,pe(),E()}})}),_.addEventListener("click",async()=>{await De("grid",r),await De("current",e),await De("areas",o),ce("saved"),E(!1)}),ee.addEventListener("click",async()=>{try{await Yt({grid:r,current:e,areas:o}),ce("exported"),E(!1)}catch(t){Be(t),window.alert(`error: failed to export - ${t.message}`)}}),J.addEventListener("click",async()=>{try{const t=await Rt();if(typeof t.current!="string"||typeof t.areas!="object")throw new Error("invalid file");const i=r,a=t.grid,l=o,u=t.areas,v=e,O=t.current;ce("imported"),T({name:"import",undo(){r=i,o=l,A(v),E()},redo(){r=a,o=u,A(O),E()}})}catch(t){Be(t),window.alert(`error: failed to import - ${t.message}`)}}),R.forEach(t=>{t.style.backgroundColor=t.value}),N.forEach(t=>{var a;const i=document.createElement("span");i.textContent=t.value||"",(a=t.parentElement)==null||a.appendChild(i)});let D="select",P="",qe=Array.from(R)[0].value,Ae=Array.from(N)[0].value;const H=(t,i="",a=!0)=>{var l;D=t,P=i,D==="select"?(m.textContent="",m.className="select",c.style.cursor="auto"):D==="pan"?(m.textContent="",m.className="pan",c.style.cursor="grab"):D==="text"?(m.textContent="Type here...",m.className="text",c.style.cursor="text"):D==="pin"?(Ae=P,m.textContent=P,m.className="pin",c.style.cursor="none"):D==="draw"&&(qe=P,m.style.setProperty("--colour",P),m.textContent="",m.className="draw",c.style.cursor="crosshair"),a&&((l=document.querySelector(`input[type="radio"][name="tool"][value="${P||D}"]`))==null||l.click())};R.forEach(t=>{t.addEventListener("change",()=>{H("draw",t.value,!1)})}),fe.addEventListener("input",()=>{M.value=fe.value,M.nextElementSibling.textContent=M.value,M.disabled=!M.value.trim()}),N.forEach(t=>{t.addEventListener("change",()=>{H("pin",t.value,!1)})}),K.addEventListener("change",()=>{H("select",void 0,!1)}),te.addEventListener("change",()=>{H("pan",void 0,!1)}),Z.addEventListener("change",()=>{H("text",void 0,!1)});const Pe=()=>{m.style.setProperty("--size",`${parseInt(se.value,10)}px`)};se.addEventListener("input",Pe);const ut=(t,i)=>{const a=parseFloat(se.value)/(s*2),l=Qe({points:[],colour:i,size:a});x.appendChild(l);let u=[];const v=10;let O=0;const L=oe=>{const $e=Date.now(),de=Fe(oe.clientX,oe.clientY);de.x/=s,de.y/=s,$e-O<v?(u[u.length-1][0]=de.x,u[u.length-1][1]=de.y):(O=$e,u=Ot(u,2/s),u.push([de.x,de.y])),Ne(l,u,a)};L(t);const j=()=>{window.removeEventListener("pointermove",L),Ne(l,u,a);const oe={points:u,size:a,colour:i};T({name:"draw",undo(){n.drawings.pop(),we(),E()},redo(){n.drawings.push(oe),we(),E()}})};window.addEventListener("pointermove",L),window.addEventListener("pointerup",j,{once:!0})},ye=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;c.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,c.style.backgroundPositionX=`${-n.offset.x}px`,c.style.backgroundPositionY=`${-n.offset.y}px`,h.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,ve()},we=()=>{x.textContent="",n.drawings.forEach(t=>{x.appendChild(Qe(t))})},pe=()=>{k.textContent="";const[t,i,a,l]=Object.keys(n.images).length?Object.keys(n.images).map(u=>u.split("|").map(v=>parseInt(v,10))).reduce(([u,v,O,L],[j,oe])=>[Math.min(u,j),Math.min(v,oe),Math.max(O,j),Math.max(L,oe)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0];for(let u=i-1;u<=l+1;++u)for(let v=t-1;v<=a+1;++v){const O=n.images[`${v}|${u}`],L=document.createElement(O?"img":"div");L.src=O,L.draggable=!1,L.dataset.x=v.toString(10),L.dataset.y=u.toString(10),L.style.width=`${r[0]}px`,L.style.height=`${r[1]}px`,L.style.transform=`translate(${v*r[0]}px, ${u*r[1]}px)`,k.appendChild(L)}},Fe=(t,i)=>({x:t+n.offset.x,y:i+n.offset.y}),Ke=()=>({x:parseFloat(m.style.left),y:parseFloat(m.style.top)}),Re=()=>{const t=Ke(),i=Fe(t.x,t.y);return i.x/=s,i.y/=s,i},Xe=t=>{const i={...n.offset},a={x:t.clientX,y:t.clientY},l=c.style.cursor;c.style.cursor="grabbing";const u=O=>{n.offset.x=-(O.clientX-a.x)+i.x,n.offset.y=-(O.clientY-a.y)+i.y,w&&le(w,re),ye()},v=()=>{window.removeEventListener("pointermove",u),c.style.cursor=l};window.addEventListener("pointermove",u),window.addEventListener("pointerup",v,{once:!0})},dt=(t,i,a)=>{const l={x:t.clientX,y:t.clientY},u={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)},v=c.style.cursor;c.style.cursor="move";const O=j=>{a((j.clientX-l.x)/s+u.x,(j.clientY-l.y)/s+u.y)},L=()=>{window.removeEventListener("pointermove",O),c.style.cursor=v;const j={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)};(j.x!==u.x||j.y!==u.y)&&T({name:"move",undo(){a(u.x,u.y),E()},redo(){a(j.x,j.y),E()}})};window.addEventListener("pointermove",O),window.addEventListener("pointerup",L,{once:!0})};let w=null,re="";const be=t=>{var l;if(t!==w)return;const i=n.pins[parseInt(t.dataset.idx||"",10)];ne.textContent="";const a=(((l=i.images)==null?void 0:l.split("|"))||[]).filter(u=>u);if(a.forEach(u=>{const v=document.createElement("img");v.src=u,v.draggable=!1;const O=document.createElement("li"),L=document.createElement("button");L.title="open in new tab",L.textContent="ðŸ”",L.addEventListener("click",()=>{window.open(u,"_blank")});const j=document.createElement("button");j.title="delete",j.textContent="âœ–",j.addEventListener("click",()=>{O.remove();const oe=i.images,$e=Array.from(ne.querySelectorAll("img")).map(de=>de.src).join("|");T({name:"delete image in pin",undo(){i.images=oe,be(t),E()},redo(){i.images=$e,be(t),E()}})}),O.appendChild(L),O.appendChild(j),O.appendChild(v),ne.appendChild(O)}),!a.length){const u=document.createElement("li");u.textContent="paste to add image",u.className="null",ne.appendChild(u)}},le=(t,i)=>{if(ue(),w=t,re=i,i==="pin"){const a=n.pins[parseInt(w.dataset.idx||"",10)];q.classList.add("show");const l=w.getBoundingClientRect();w.classList.add("selected"),z.value=a.type||"???",$.value=a.notes||"",be(t),q.style.top=`${l.bottom<c.clientHeight/2?l.bottom:l.top-q.clientHeight}px`,q.style.left=`${l.right<c.clientWidth/2?l.right:l.left-q.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",u=>{u.target&&![q,w].includes(u.target)&&!(q.contains(u.target)||!(w!=null&&w.contains(u.target)))&&ue()},{once:!0})})}else(i==="image"||i==="drawing")&&w.classList.add("selected")},ue=()=>{q.classList.remove("show"),w==null||w.classList.remove("selected"),w=null},Ye=t=>{let i=t.nextSibling;for(;i;)i.dataset.idx=(parseInt(i.dataset.idx||"",10)-1).toString(10),i=i.nextSibling};S.addEventListener("click",()=>{if(!w)return;const t=parseInt(w.dataset.idx||"",10),i=n.pins[t];T({name:"delete pin",undo(){n.pins.splice(t,0,i),he(),le(p.children[t],"pin"),E()},redo(){n.pins.splice(t,1),he(),ue(),E()}})}),z.addEventListener("input",()=>{if(!w)return;const t=n.pins[parseInt(w.dataset.idx||"",10)];t.type=z.value||"???",w.textContent=t.type,E()}),$.addEventListener("input",()=>{if(!w)return;const t=n.pins[parseInt(w.dataset.idx||"",10)];t.notes=$.value,E()}),c.addEventListener("pointerdown",t=>{const i=document.activeElement;if(f.contains(i)&&(i==null||i.blur()),t.button===1){t.preventDefault(),Xe(t);return}else if(t.button===0){if(D==="select"){ue();const a=document.elementFromPoint(t.clientX,t.clientY);if(a!=null&&a.closest("#pins")){i==null||i.blur(),t.preventDefault(),le(a,"pin");const l=n.pins[parseInt(a.dataset.idx||"",10)];dt(t,a,(u,v)=>{a.style.left=`${u}px`,a.style.top=`${v}px`,l.x=u,l.y=v,le(a,"pin")})}else a!=null&&a.closest("#images")?(i==null||i.blur(),t.preventDefault(),le(a,"image")):a!=null&&a.closest("#drawings")&&(i==null||i.blur(),t.preventDefault(),le(a,"drawing"));return}else if(D==="pan")t.preventDefault(),Xe(t);else if(D==="pin"){t.preventDefault();const a=P,l=document.createElement("div");l.textContent=a;const u=Re();l.style.top=`${u.y}px`,l.style.left=`${u.x}px`,l.dataset.idx=n.pins.length.toString(10),K.click();const v={x:u.x,y:u.y,type:a,notes:"",images:""};T({name:"place pin",undo(){ue(),n.pins.pop(),l.remove(),ye(),E()},redo(){p.appendChild(l),n.pins.push(v),ye(),le(l,"pin"),E()}})}else if(D==="draw")t.preventDefault(),ut(t,P);else if(D==="text"){t.preventDefault();const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}const l=Re();a.style.top=`${l.y}px`,a.style.left=`${l.x}px`,a.style.fontSize="200%",a.dataset.idx=n.text.length.toString(10),K.click(),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var v;(v=a.textContent)!=null&&v.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ye(a),a.remove(),E())});const u={x:l.x,y:l.y,text:"",size:2};T({name:"place text",undo(){a.remove(),n.text.pop(),E()},redo(){y.appendChild(a),n.text.push(u),a.focus(),E()}})}}}),c.addEventListener("pointermove",t=>{m.style.left=`${t.clientX}px`,m.style.top=`${t.clientY}px`});const ft=t=>{const i=w;if(!i)return;const a=n.pins[parseInt(i.dataset.idx||"",10)],l=a.images,u=[a.images,t].filter(v=>v).join("|");T({name:"add image to pin",undo(){a.images=l,be(i),E()},redo(){a.images=u,be(i),E()}})},pt=t=>{if(!w)return;const i=`${w.dataset.x}|${w.dataset.y}`,a=n.images[i];T({name:"place image",undo(){a?n.images[i]=a:delete n.images[i],pe(),E()},redo(){n.images[i]=t,pe(),E()}})};Xt(t=>{w&&re==="pin"?ft(t):w&&re==="image"&&pt(t)});let Le=!1;window.addEventListener("keydown",t=>{var a;const i=document.activeElement;if((i==null?void 0:i.tagName)==="TEXTAREA"||(i==null?void 0:i.tagName)==="INPUT"||(i==null?void 0:i.contentEditable)==="plaintext-only"||(i==null?void 0:i.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&i.parentElement===y){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size*=2,i.style.fontSize=`${l.size*100}%`,E()}else if(t.ctrlKey&&t.key==="-"&&i.parentElement===y){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size/=2,i.style.fontSize=`${l.size*100}%`,E()}return}if(t.ctrlKey&&t.key==="z"){const l=Wt();l!==!1&&ce(["undo",l].filter(u=>u).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const l=Ht();l!==!1&&ce(["redo",l].filter(u=>u).join(" - "))}if(t.key==="Escape"&&ue(),(t.key==="Backspace"||t.key==="Delete")&&w&&re==="image"){const l=`${w.dataset.x}|${w.dataset.y}`,u=n.images[l];T({name:"delete image",undo(){n.images[l]=u,pe(),E()},redo(){delete n.images[l],pe(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&w&&re==="drawing"){const l=Array.from(((a=w.parentElement)==null?void 0:a.children)||[]).indexOf(w),u=n.drawings[l];T({name:"delete drawing",undo(){n.drawings.splice(l,0,u),we(),E()},redo(){n.drawings.splice(l,1),we(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&w&&re==="pin"&&S.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),_.click();return}if(t.ctrlKey&&t.key==="c"&&w&&re==="image"){t.preventDefault(),navigator.clipboard.writeText(w.src);return}if(!Le&&t.key===" "){Le=!0;const l=D,u=P;H("pan"),window.addEventListener("keyup",v=>{v.key===" "&&(Le=!1,H(l,u))})}if(t.key==="q"){t.preventDefault(),H("select");return}if(t.key==="t"){t.preventDefault(),H("text");return}if(t.key==="b"){t.preventDefault(),H("draw",qe);return}if(t.key==="p"){t.preventDefault(),H("pin",Ae);return}}),c.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const i=s;d();const a=s-i,l=Ke(),u={x:(l.x+n.offset.x)/i,y:(l.y+n.offset.y)/i};n.offset.x+=u.x*a,n.offset.y+=u.y*a,ye(),w&&le(w,re)});const mt=(t,i)=>{n.offset.x=t*s-c.clientWidth/2-me.clientWidth/2,n.offset.y=i*s-c.clientHeight/2,ye()};let Ee;W.addEventListener("focus",()=>{Ee=new Et("key"),Ee.addDocuments(Object.entries(o).flatMap(([t,{pins:i,text:a}])=>i.map((l,u)=>({key:`${t}-p-${u}`,area:t,text:[t,l.type,l.notes].filter(v=>v).join(" > "),original:l})).concat(a.map((l,u)=>({key:`${t}-t-${u}`,area:t,text:[t,l.text].filter(v=>v).join(" > "),original:l}))))),Ee.addIndex("text")}),W.addEventListener("input",()=>{const t=Ee.search(W.value);me.textContent="",t.forEach(i=>{const a=document.createElement("li"),l=document.createElement("span");l.innerHTML=i.text,Kt(l,W.value,Ee.tokenizer.tokenize);const u=document.createElement("button");u.title="focus",u.textContent="ðŸ”",u.addEventListener("click",()=>{ue();const v=i.area;e!==v&&A(v),mt(i.original.x,i.original.y)}),u.addEventListener("dblclick",()=>{n.zoom=1,d()}),a.appendChild(u),a.appendChild(l),me.appendChild(a)})}),Array.from(N).forEach(t=>{const i=document.createElement("option");i.value=t.value,C.appendChild(i)}),A(e),Pe()})();
