import{g as bt,a as Me,s as Te}from"./Storage-BM7PRQyX.js";import{e as Ge}from"./index-VMKSC2vY.js";var Et=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],d="",f=0,u=n.length;f<u;++f)d+=n.charAt(f),s.push(d);return s},e}(),St=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function qe(e,r){r=r||[],e=e||{};for(var o=e,n=0;n<r.length;n++)if(o=o[r[n]],o==null)return null;return o}var kt=function(){function e(o){this._uidFieldName=o,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,d){this._tokenToIdfCache={};var f=this._tokenMap,u;typeof f[n]!="object"?f[n]=u={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(u=f[n],u.$totalNumOccurrences++);var p=u.$uidMap;typeof p[s]!="object"?(u.$numDocumentOccurrences++,p[s]={$document:d,$numTokenOccurrences:1}):p[s].$numTokenOccurrences++},r.search=function(n,s){for(var d={},f=0,u=n.length;f<u;f++){var p=n[f],k=this._tokenMap[p];if(!k)return[];if(f===0)for(var g=Object.keys(k.$uidMap),m=0,y=g.length;m<y;m++){var h=g[m];d[h]=k.$uidMap[h].$document}else for(var g=Object.keys(d),m=0,y=g.length;m<y;m++){var h=g[m];typeof k.$uidMap[h]!="object"&&delete d[h]}}var v=[];for(var h in d)v.push(d[h]);var w=this._createCalculateTfIdf();return v.sort(function(C,X){return w(n,X,s)-w(n,C,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(f,u){if(!s[f]){var p=typeof n[f]<"u"?n[f].$numDocumentOccurrences:0;s[f]=1+Math.log(u.length/(1+p))}return s[f]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,d=this._createCalculateIdf();return function(u,p,k){for(var g=0,m=0,y=u.length;m<y;++m){var h=u[m],v=d(h,k);v===1/0&&(v=0);var w;s instanceof Array?w=p&&qe(p,s):w=p&&p[s];var C=typeof n[h]<"u"&&typeof n[h].$uidMap[w]<"u"?n[h].$uidMap[w].$numTokenOccurrences:0;g+=C*v}return g}},e}(),Ct=/[^a-zа-яё0-9\-']+/i,$t=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(Ct).filter(function(s){return s})},e}();function Je(e,r){for(var o=0;o<r.length;o++){var n=r[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function It(e,r,o){return r&&Je(e.prototype,r),o&&Je(e,o),e}var Ot=function(){function e(o){if(!o)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=o,this._indexStrategy=new Et,this._searchIndex=new kt(o),this._sanitizer=new St,this._tokenizer=new $t,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var d=this._indexStrategy,f=this._sanitizer,u=this._searchIndex,p=this._tokenizer,k=this._uidFieldName,g=0,m=n.length;g<m;g++){var y=n[g],h;k instanceof Array?h=qe(y,k):h=y[k];for(var v=0,w=s.length;v<w;v++){var C,X=s[v];if(X instanceof Array?C=qe(y,X):C=y[X],C!=null&&typeof C!="string"&&C.toString&&(C=C.toString()),typeof C=="string")for(var L=p.tokenize(f.sanitize(C)),q=0,oe=L.length;q<oe;q++)for(var D=L[q],Q=d.expandToken(D),Y=0,U=Q.length;Y<U;Y++){var V=Q[Y];u.indexDocument(V,h,y)}}}},It(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),_e={exports:{}};function zt(e,r){var o=e[0]-r[0],n=e[1]-r[1];return o*o+n*n}var Lt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;for(var n=o*o,s=r[0],d=[s],f,u=1,p=r.length;u<p;u++)f=r[u],zt(f,s)>n&&(d.push(f),s=f);return s!==f&&d.push(f),d};function _t(e,r,o){var n=r[0],s=r[1],d=o[0]-n,f=o[1]-s;if(d!==0||f!==0){var u=((e[0]-n)*d+(e[1]-s)*f)/(d*d+f*f);u>1?(n=o[0],s=o[1]):u>0&&(n+=d*u,s+=f*u)}return d=e[0]-n,f=e[1]-s,d*d+f*f}function Ne(e,r,o,n,s){for(var d=n,f,u=r+1;u<o;u++){var p=_t(e[u],e[r],e[o]);p>d&&(f=u,d=p)}d>n&&(f-r>1&&Ne(e,r,f,n,s),s.push(e[f]),o-f>1&&Ne(e,f,o,n,s))}var Dt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;var n=o*o,s=r.length-1,d=[r[0]];return Ne(r,0,s,n,d),d.push(r[s]),d},st=Lt,ct=Dt;_e.exports=function(r,o){return r=st(r,o),r=ct(r,o),r};_e.exports.radialDistance=st;_e.exports.douglasPeucker=ct;var jt=_e.exports;const Mt=bt(jt);let lt=!1;function E(e=!0){lt=e}window.addEventListener("beforeunload",function(e){if(!lt)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function Qe(e,r,o,n=s=>s){return e*n(.5-r*(.5-o))}function Tt(e){return[-e[0],-e[1]]}function H(e,r){return[e[0]+r[0],e[1]+r[1]]}function K(e,r){return[e[0]-r[0],e[1]-r[1]]}function B(e,r){return[e[0]*r,e[1]*r]}function qt(e,r){return[e[0]/r,e[1]/r]}function $e(e){return[e[1],-e[0]]}function Ve(e,r){return e[0]*r[0]+e[1]*r[1]}function Nt(e,r){return e[0]===r[0]&&e[1]===r[1]}function Pt(e){return Math.hypot(e[0],e[1])}function At(e){return e[0]*e[0]+e[1]*e[1]}function et(e,r){return At(K(e,r))}function ut(e){return qt(e,Pt(e))}function Ft(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function Ie(e,r,o){let n=Math.sin(o),s=Math.cos(o),d=e[0]-r[0],f=e[1]-r[1],u=d*s-f*n,p=d*n+f*s;return[u+r[0],p+r[1]]}function Pe(e,r,o){return H(e,B(K(r,e),o))}function tt(e,r,o){return H(e,B(r,o))}var{min:be,PI:Kt}=Math,nt=.275,Oe=Kt+1e-4;function Xt(e,r={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:d=!0,easing:f=S=>S,start:u={},end:p={},last:k=!1}=r,{cap:g=!0,easing:m=S=>S*(2-S)}=u,{cap:y=!0,easing:h=S=>--S*S*S+1}=p;if(e.length===0||o<=0)return[];let v=e[e.length-1].runningLength,w=u.taper===!1?0:u.taper===!0?Math.max(o,v):u.taper,C=p.taper===!1?0:p.taper===!0?Math.max(o,v):p.taper,X=Math.pow(o*n,2),L=[],q=[],oe=e.slice(0,10).reduce((S,I)=>{let $=I.pressure;if(d){let O=be(1,I.distance/o),he=be(1,1-O);$=be(1,S+(he-S)*(O*nt))}return(S+$)/2},e[0].pressure),D=Qe(o,s,e[e.length-1].pressure,f),Q,Y=e[0].vector,U=e[0].point,V=U,F=U,Z=V,me=!1;for(let S=0;S<e.length;S++){let{pressure:I}=e[S],{point:$,vector:O,distance:he,runningLength:G}=e[S];if(S<e.length-1&&v-G<3)continue;if(s){if(d){let j=be(1,he/o),de=be(1,1-j);I=be(1,oe+(de-oe)*(j*nt))}D=Qe(o,s,I,f)}else D=o/2;Q===void 0&&(Q=D);let le=G<w?m(G/w):1,ue=v-G<C?h((v-G)/C):1;D=Math.max(.01,D*Math.min(le,ue));let ye=(S<e.length-1?e[S+1]:e[S]).vector,ge=S<e.length-1?Ve(O,ye):1,Ee=Ve(O,Y)<0&&!me,xe=ge!==null&&ge<0;if(Ee||xe){let j=B($e(Y),D);for(let de=1/13,fe=0;fe<=1;fe+=de)F=Ie(K($,j),$,Oe*fe),L.push(F),Z=Ie(H($,j),$,Oe*-fe),q.push(Z);U=F,V=Z,xe&&(me=!0);continue}if(me=!1,S===e.length-1){let j=B($e(O),D);L.push(K($,j)),q.push(H($,j));continue}let ie=B($e(Pe(ye,O,ge)),D);F=K($,ie),(S<=1||et(U,F)>X)&&(L.push(F),U=F),Z=H($,ie),(S<=1||et(V,Z)>X)&&(q.push(Z),V=Z),oe=I,Y=O}let N=e[0].point.slice(0,2),P=e.length>1?e[e.length-1].point.slice(0,2):H(e[0].point,[1,1]),ee=[],R=[];if(e.length===1){if(!(w||C)||k){let S=tt(N,ut($e(K(N,P))),-(Q||D)),I=[];for(let $=1/13,O=$;O<=1;O+=$)I.push(Ie(S,N,Oe*2*O));return I}}else{if(!(w||C&&e.length===1))if(g)for(let I=1/13,$=I;$<=1;$+=I){let O=Ie(q[0],N,Oe*$);ee.push(O)}else{let I=K(L[0],q[0]),$=B(I,.5),O=B(I,.51);ee.push(K(N,$),K(N,O),H(N,O),H(N,$))}let S=$e(Tt(e[e.length-1].vector));if(C||w&&e.length===1)R.push(P);else if(y){let I=tt(P,S,D);for(let $=1/29,O=$;O<1;O+=$)R.push(Ie(I,P,Oe*3*O))}else R.push(H(P,B(S,D)),H(P,B(S,D*.99)),K(P,B(S,D*.99)),K(P,B(S,D)))}return L.concat(R,q.reverse(),ee)}function Yt(e,r={}){var o;let{streamline:n=.5,size:s=16,last:d=!1}=r;if(e.length===0)return[];let f=.15+(1-n)*.85,u=Array.isArray(e[0])?e:e.map(({x:h,y:v,pressure:w=.5})=>[h,v,w]);if(u.length===2){let h=u[1];u=u.slice(0,-1);for(let v=1;v<5;v++)u.push(Pe(u[0],h,v/4))}u.length===1&&(u=[...u,[...H(u[0],[1,1]),...u[0].slice(2)]]);let p=[{point:[u[0][0],u[0][1]],pressure:u[0][2]>=0?u[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,g=0,m=p[0],y=u.length-1;for(let h=1;h<u.length;h++){let v=d&&h===y?u[h].slice(0,2):Pe(m.point,u[h],f);if(Nt(m.point,v))continue;let w=Ft(v,m.point);if(g+=w,h<y&&!k){if(g<s)continue;k=!0}m={point:v,pressure:u[h][2]>=0?u[h][2]:.5,vector:ut(K(m.point,v)),distance:w,runningLength:g},p.push(m)}return p[0].vector=((o=p[1])==null?void 0:o.vector)||[0,0],p}function Rt(e,r={}){return Xt(Yt(e,r),r)}var Wt=Rt;const Le=(e,r)=>(e+r)/2;function Bt(e,r=!0){const o=e.length;if(o<4)return"";let n=e[0],s=e[1];const d=e[2];let f=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${Le(s[0],d[0]).toFixed(2)},${Le(s[1],d[1]).toFixed(2)} T`;for(let u=2,p=o-1;u<p;u++)n=e[u],s=e[u+1],f+=`${Le(n[0],s[0]).toFixed(2)},${Le(n[1],s[1]).toFixed(2)} `;return r&&(f+="Z"),f}function rt(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),Ae(r,e.points,e.size),r}function Ae(e,r,o){e.setAttributeNS(null,"d",Bt(Wt(r,{size:o,smoothing:.5,streamline:.25,thinning:.5})))}function ot(e,r,o){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),o)}function it(e,r){const o=[],n=/^\s*$/;function s(d){if(d.nodeType==3)(r||!n.test(d.nodeValue||""))&&o.push(d);else for(var f=0,u=d.childNodes.length;f<u;++f)s(d.childNodes[f])}return s(e),o}const at=(e,r)=>{e.forEach(o=>{const n=o.textContent,s=r(n||""),d=document.createRange().createContextualFragment(s);o.replaceWith(d)})},Ht=(e,r,o)=>{const n=o(r);let s=it(e,!0);at(s,d=>ot(d,[r],'<mark class="exact">$1</mark>')),s=it(e,!0),at(s,d=>ot(d,n,"<mark>$1</mark>"))};function dt(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function ft(e){return e}function pt(e,r){r=r||{};const o=r.delimiter||".",n=r.maxDepth,s=r.transformKey||ft,d={};function f(u,p,k){k=k||1,Object.keys(u).forEach(function(g){const m=u[g],y=r.safe&&Array.isArray(m),h=Object.prototype.toString.call(m),v=dt(m),w=h==="[object Object]"||h==="[object Array]",C=p?p+o+s(g):s(g);if(!y&&!v&&w&&Object.keys(m).length&&(!r.maxDepth||k<n))return f(m,C,k+1);d[C]=m})}return f(e),d}function mt(e,r){r=r||{};const o=r.delimiter||".",n=r.overwrite||!1,s=r.transformKey||ft,d={};if(dt(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function u(g){const m=Number(g);return isNaN(m)||g.indexOf(".")!==-1||r.object?g:m}function p(g,m,y){return Object.keys(y).reduce(function(h,v){return h[g+o+v]=y[v],h},m)}function k(g){const m=Object.prototype.toString.call(g),y=m==="[object Array]",h=m==="[object Object]";if(g){if(y)return!g.length;if(h)return!Object.keys(g).length}else return!0}return e=Object.keys(e).reduce(function(g,m){const y=Object.prototype.toString.call(e[m]);return!(y==="[object Object]"||y==="[object Array]")||k(e[m])?(g[m]=e[m],g):p(m,g,pt(e[m],r))},{}),Object.keys(e).forEach(function(g){const m=g.split(o).map(s);let y=u(m.shift()),h=u(m[0]),v=d;for(;h!==void 0;){if(y==="__proto__")return;const w=Object.prototype.toString.call(v[y]),C=w==="[object Object]"||w==="[object Array]";if(!n&&!C&&typeof v[y]<"u")return;(n&&!C||!n&&v[y]==null)&&(v[y]=typeof h=="number"&&!r.object?[]:{}),v=v[y],m.length>0&&(y=u(m.shift()),h=u(m[0]))}v[y]=mt(e[g],r)}),d}function Ut(){return new Promise((e,r)=>{const o=document.createElement("input");o.type="file",o.onchange=()=>{var d;const n=(d=o.files)==null?void 0:d[0];if(!n)return e("");const s=new FileReader;s.onload=()=>{const f=s.result,u=new TextDecoder("utf-8");let p="";const k=[],g=1e5;for(let m=0;m<f.byteLength;m+=g)for(p+=u.decode(f.slice(m,Math.min(f.byteLength,m+g)));p.includes(`,
`);){let[y,...h]=p.split(`,
`);p=h.join(`,
`),y=y.replace(/^\[\n/,""),y=y.replace(/^\]/,""),!(y==="["||y==="]")&&k.push(JSON.parse(y))}e(mt(Object.fromEntries(k)))},s.onerror=f=>{r(f)},s.readAsArrayBuffer(n)},o.oncancel=()=>{e("")},o.click()})}function Zt(e){document.addEventListener("paste",r=>{const o=r.clipboardData||r.originalEvent.clipboardData,n=o.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=o.items;for(let d in s){const f=s[d];if(f.kind==="file"){const u=f.getAsFile(),p=new FileReader;p.onload=()=>{const k=p.result;k!=null&&k.startsWith("data:image")&&e(k)},p.readAsDataURL(u)}}})}async function Gt(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable(),s=Object.entries(pt(e));await n.write(`[
`);for(let d of s)await n.write(JSON.stringify(d)),d!==s[s.length-1]&&await n.write(`,
`);await n.write(`
]`),await n.close()}const J=[];let re=-1;const Jt=50;function M(e){for(J.splice(re+1,J.length),J.push(e);J.length>Jt;)J.shift();re=J.length-1,J[re].redo()}function Qt(){const e=J[re];return e?(e.undo(),--re,e.name):(re=-1,!1)}function Vt(){++re;const e=J[re];return e?(e==null||e.redo(),e==null?void 0:e.name):(re=J.length-1,!1)}(async()=>{let e=Me("current"),r=Me("grid"),o=Me("areas"),n,s=1;const d=()=>{s=Math.pow(1.1,n.zoom)},f=document.querySelector("#overlay"),u=document.querySelector("#controls"),p=document.querySelector("#map-container"),k=document.querySelector("#map"),g=document.querySelector("#images"),m=document.querySelector("#drawings"),y=document.querySelector("#pins"),h=document.querySelector("#text"),v=document.querySelector("#about"),w=document.querySelector("#cursor"),C=document.querySelector("#ping"),X=document.querySelector("#btn-about"),L=document.querySelector("#areas"),q=document.querySelector("#btn-area-add"),oe=document.querySelector("#btn-area-rename"),D=document.querySelector("#btn-area-delete"),Q=document.querySelector("#btn-grid"),Y=document.querySelector("#btn-save"),U=document.querySelector("#btn-export"),V=document.querySelector("#btn-import"),F=document.querySelector("#btn-select"),Z=document.querySelector("#btn-pan"),me=document.querySelector("#btn-text"),N=document.querySelectorAll('#options-colour > input[type="radio"]'),P=document.querySelector("#stroke"),ee=document.querySelectorAll('#options-pin input[type="radio"]'),R=document.querySelector("#custom-pin"),S=document.querySelector("#custom-pin-entry"),I=document.querySelector("#context"),$=document.querySelector("#context-delete"),O=document.querySelector("#context-pin"),he=document.querySelector("#context-datalist"),G=document.querySelector("#context-notes"),le=document.querySelector("#context-images"),ue=document.querySelector("#search"),ye=document.querySelector("#search-results"),ge=document.querySelector("#toasts");if(!f||!u||!p||!k||!g||!m||!y||!h||!v||!w||!C||!F||!Z||!me||!X||!L||!q||!oe||!D||!Q||!Y||!U||!V||!N.length||!P||!ee.length||!R||!S||!I||!$||!he||!O||!G||!le||!ue||!ye||!ge)throw new Error("Could not find elements");const Ee=t=>{f.textContent=t,f.classList.add("show")},xe=()=>{f.textContent="",f.classList.remove("show")},ie=t=>{const i=document.createElement("li");i.textContent=t,ge.appendChild(i),setTimeout(()=>{i.remove()},2500)},j=t=>{e=t,n=o[t],L.value=t,se(),ht()},de=()=>{L.textContent="",Object.keys(o).sort().forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e&&(i.selected=!0),L.appendChild(i)})},fe=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},De=()=>{y.textContent="",n.pins.forEach((t,i)=>{const a=t.type,c=document.createElement("div");c.textContent=a||"???",c.style.top=`${t.y}px`,c.style.left=`${t.x}px`,y.appendChild(c),c.dataset.idx=i.toString(10)}),fe()},ht=()=>{de(),De(),h.textContent="",n.text.forEach((t,i)=>{const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}a.style.top=`${t.y}px`,a.style.left=`${t.x}px`,a.style.fontSize=`${t.size*100}%`,a.textContent=t.text,a.dataset.idx=i.toString(10),h.appendChild(a),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var c;(c=a.textContent)!=null&&c.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ue(a),a.remove(),E())})}),Se(),pe(),d(),ve()};X.addEventListener("click",()=>{v.classList.toggle("show")}),L.addEventListener("change",()=>{const t=e,i=L.value;t!==i&&M({name:"change area",undo(){j(t)},redo(){j(i)}})}),q.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(o).length}`);if(!t)return;if(o[t]){window.alert("error: an area with that name already exists!");return}const i=e,a={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};M({name:"create area",undo(){delete o[t],de(),j(i),E()},redo(){o[t]=a,de(),j(t),E()}})}),oe.addEventListener("click",()=>{const t=e,i=window.prompt("rename area",e);!i||i===t||M({name:"rename area",undo(){o[t]=o[i],delete o[i],e=t,L.selectedOptions[0].value=L.selectedOptions[0].textContent=t,E()},redo(){o[i]=o[t],delete o[t],e=i,L.selectedOptions[0].value=L.selectedOptions[0].textContent=i,E()}})}),D.addEventListener("click",()=>{const t=e;if(Object.keys(o).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const i=Object.keys(o).filter(x=>x!==t)[0],a=o[t],c=L.selectedOptions[0],l=L.selectedIndex;M({name:"delete area",undo(){o[t]=a,L.insertBefore(c,L.children[l]),j(t),E()},redo(){delete o[t],c.remove(),j(i),E()}})}),Q.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",i=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!i)return;const a=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!a)return;const c=r[0],l=r[1],x=parseInt(i,10),z=parseInt(a,10);M({name:"resize grid",undo(){r[0]=c,r[1]=l,pe(),E()},redo(){r[0]=x,r[1]=z,pe(),E()}})}),Y.addEventListener("click",async()=>{Ee("saving...");try{await Te("grid",r),await Te("current",e),await Te("areas",o),ie("saved"),E(!1)}finally{xe()}}),U.addEventListener("click",async()=>{Ee("exporting...");try{await Gt({grid:r,current:e,areas:o}),ie("exported"),E(!1)}catch(t){Ge(t),window.alert(`error: failed to export - ${t.message}`)}finally{xe()}}),V.addEventListener("click",async()=>{Ee("importing...");try{const t=await Ut();if(!t)return;if(typeof t.current!="string"||typeof t.areas!="object")throw new Error("invalid file");const i=r,a=t.grid,c=o,l=t.areas,x=e,z=t.current;ie("imported"),M({name:"import",undo(){r=i,o=c,j(x),E()},redo(){r=a,o=l,j(z),E()}})}catch(t){Ge(t),window.alert(`error: failed to import - ${t.message}`)}finally{xe()}}),N.forEach(t=>{t.style.backgroundColor=t.value}),ee.forEach(t=>{var a;const i=document.createElement("span");i.textContent=t.value||"",(a=t.parentElement)==null||a.appendChild(i)});let A="select",te="",Fe=Array.from(N)[0].value,Ke=Array.from(ee)[0].value;const W=(t,i="",a=!0)=>{var c;A=t,te=i,A==="select"?(w.textContent="",w.className="select",p.style.cursor="auto"):A==="pan"?(w.textContent="",w.className="pan",p.style.cursor="grab"):A==="text"?(w.textContent="Type here...",w.className="text",p.style.cursor="text"):A==="pin"?(Ke=te,w.textContent=te,w.className="pin",p.style.cursor="none"):A==="draw"&&(Fe=te,w.style.setProperty("--colour",te),w.textContent="",w.className="draw",p.style.cursor="crosshair"),a&&((c=document.querySelector(`input[type="radio"][name="tool"][value="${te||A}"]`))==null||c.click())};N.forEach(t=>{t.addEventListener("change",()=>{W("draw",t.value,!1)})}),S.addEventListener("input",()=>{R.value=S.value,R.nextElementSibling.textContent=R.value,R.disabled=!R.value.trim()}),ee.forEach(t=>{t.addEventListener("change",()=>{W("pin",t.value,!1)})}),F.addEventListener("change",()=>{W("select",void 0,!1)}),Z.addEventListener("change",()=>{W("pan",void 0,!1)}),me.addEventListener("change",()=>{W("text",void 0,!1)});const Xe=()=>{w.style.setProperty("--size",`${parseInt(P.value,10)}px`)};P.addEventListener("input",Xe);const yt=(t,i)=>{C.style.left=`${t}px`,C.style.top=`${i}px`,C.classList.remove("show"),document.body.offsetHeight,C.classList.add("show")},gt=(t,i)=>{const a=parseFloat(P.value)/(s*2),c=rt({points:[],colour:i,size:a});m.appendChild(c);let l=[];const x=10;let z=0;const _=we=>{const ze=Date.now(),ce=Re(we.clientX,we.clientY);ce.x/=s,ce.y/=s,ze-z<x?(l[l.length-1][0]=ce.x,l[l.length-1][1]=ce.y):(z=ze,l=Mt(l,2/s),l.push([ce.x,ce.y])),Ae(c,l,a)};_(t);const T=()=>{window.removeEventListener("pointermove",_),Ae(c,l,a);const we={points:l,size:a,colour:i};M({name:"draw",undo(){n.drawings.pop(),Se(),E()},redo(){n.drawings.push(we),Se(),E()}})};window.addEventListener("pointermove",_),window.addEventListener("pointerup",T,{once:!0})},ve=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;p.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,p.style.backgroundPositionX=`${-n.offset.x}px`,p.style.backgroundPositionY=`${-n.offset.y}px`,k.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,fe()},Se=()=>{m.textContent="",n.drawings.forEach(t=>{m.appendChild(rt(t))})},Ye=()=>Object.keys(n.images).length?Object.keys(n.images).map(t=>t.split("|").map(i=>parseInt(i,10))).reduce(([t,i,a,c],[l,x])=>[Math.min(t,l),Math.min(i,x),Math.max(a,l),Math.max(c,x)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0],pe=()=>{g.textContent="";const[t,i,a,c]=Ye();for(let l=i-1;l<=c+1;++l)for(let x=t-1;x<=a+1;++x){const z=n.images[`${x}|${l}`],_=document.createElement(z?"img":"div");_.src=z,_.draggable=!1,_.dataset.x=x.toString(10),_.dataset.y=l.toString(10),_.style.width=`${r[0]}px`,_.style.height=`${r[1]}px`,_.style.transform=`translate(${x*r[0]}px, ${l*r[1]}px)`,g.appendChild(_)}},Re=(t,i)=>({x:t+n.offset.x,y:i+n.offset.y}),We=()=>({x:parseFloat(w.style.left),y:parseFloat(w.style.top)}),Be=()=>{const t=We(),i=Re(t.x,t.y);return i.x/=s,i.y/=s,i},He=t=>{const i={...n.offset},a={x:t.clientX,y:t.clientY},c=p.style.cursor;p.style.cursor="grabbing";const l=z=>{n.offset.x=-(z.clientX-a.x)+i.x,n.offset.y=-(z.clientY-a.y)+i.y,b&&ae(b,ne),ve()},x=()=>{window.removeEventListener("pointermove",l),p.style.cursor=c};window.addEventListener("pointermove",l),window.addEventListener("pointerup",x,{once:!0})},xt=(t,i,a)=>{const c={x:t.clientX,y:t.clientY},l={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)},x=p.style.cursor;p.style.cursor="move";const z=T=>{a((T.clientX-c.x)/s+l.x,(T.clientY-c.y)/s+l.y)},_=()=>{window.removeEventListener("pointermove",z),p.style.cursor=x;const T={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)};(T.x!==l.x||T.y!==l.y)&&M({name:"move",undo(){a(l.x,l.y),E()},redo(){a(T.x,T.y),E()}})};window.addEventListener("pointermove",z),window.addEventListener("pointerup",_,{once:!0})};let b=null,ne="";const ke=t=>{var c;if(t!==b)return;const i=n.pins[parseInt(t.dataset.idx||"",10)];le.textContent="";const a=(((c=i.images)==null?void 0:c.split("|"))||[]).filter(l=>l);if(a.forEach(l=>{const x=document.createElement("img");x.src=l,x.draggable=!1;const z=document.createElement("li"),_=document.createElement("button");_.title="open in new tab",_.textContent="🔍",_.addEventListener("click",()=>{window.open(l,"_blank")});const T=document.createElement("button");T.title="delete",T.textContent="✖",T.addEventListener("click",()=>{z.remove();const we=i.images,ze=Array.from(le.querySelectorAll("img")).map(ce=>ce.src).join("|");M({name:"delete image in pin",undo(){i.images=we,ke(t),E()},redo(){i.images=ze,ke(t),E()}})}),z.appendChild(_),z.appendChild(T),z.appendChild(x),le.appendChild(z)}),!a.length){const l=document.createElement("li");l.textContent="paste to add image",l.className="null",le.appendChild(l)}},ae=(t,i)=>{if(se(),b=t,ne=i,i==="pin"){const a=n.pins[parseInt(b.dataset.idx||"",10)];I.classList.add("show");const c=b.getBoundingClientRect();b.classList.add("selected"),O.value=a.type||"???",G.value=a.notes||"",ke(t),I.style.top=`${c.bottom<p.clientHeight/2?c.bottom:c.top-I.clientHeight}px`,I.style.left=`${c.right<p.clientWidth/2?c.right:c.left-I.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",l=>{l.target&&![I,b].includes(l.target)&&!(I.contains(l.target)||!(b!=null&&b.contains(l.target)))&&se()},{once:!0})})}else(i==="image"||i==="drawing")&&b.classList.add("selected")},se=()=>{I.classList.remove("show"),b==null||b.classList.remove("selected"),b=null},Ue=t=>{let i=t.nextSibling;for(;i;)i.dataset.idx=(parseInt(i.dataset.idx||"",10)-1).toString(10),i=i.nextSibling};$.addEventListener("click",()=>{if(!b)return;const t=parseInt(b.dataset.idx||"",10),i=n.pins[t];M({name:"delete pin",undo(){n.pins.splice(t,0,i),De(),ae(y.children[t],"pin"),E()},redo(){n.pins.splice(t,1),De(),se(),E()}})}),O.addEventListener("input",()=>{if(!b)return;const t=n.pins[parseInt(b.dataset.idx||"",10)];t.type=O.value||"???",b.textContent=t.type,E()}),G.addEventListener("input",()=>{if(!b)return;const t=n.pins[parseInt(b.dataset.idx||"",10)];t.notes=G.value,E()}),p.addEventListener("pointerdown",t=>{const i=document.activeElement;if(u.contains(i)&&(i==null||i.blur()),t.button===1){t.preventDefault(),He(t);return}else if(t.button===0){if(A==="select"){se();const a=document.elementFromPoint(t.clientX,t.clientY);if(a!=null&&a.closest("#pins")){i==null||i.blur(),t.preventDefault(),ae(a,"pin");const c=n.pins[parseInt(a.dataset.idx||"",10)];xt(t,a,(l,x)=>{a.style.left=`${l}px`,a.style.top=`${x}px`,c.x=l,c.y=x,ae(a,"pin")})}else a!=null&&a.closest("#images")?(i==null||i.blur(),t.preventDefault(),ae(a,"image")):a!=null&&a.closest("#drawings")&&(i==null||i.blur(),t.preventDefault(),ae(a,"drawing"));return}else if(A==="pan")t.preventDefault(),He(t);else if(A==="pin"){t.preventDefault();const a=te,c=document.createElement("div");c.textContent=a;const l=Be();c.style.top=`${l.y}px`,c.style.left=`${l.x}px`,c.dataset.idx=n.pins.length.toString(10),F.click();const x={x:l.x,y:l.y,type:a,notes:"",images:""};M({name:"place pin",undo(){se(),n.pins.pop(),c.remove(),ve(),E()},redo(){y.appendChild(c),n.pins.push(x),ve(),ae(c,"pin"),E()}})}else if(A==="draw")t.preventDefault(),gt(t,te);else if(A==="text"){t.preventDefault();const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}const c=Be();a.style.top=`${c.y}px`,a.style.left=`${c.x}px`,a.style.fontSize="200%",a.dataset.idx=n.text.length.toString(10),F.click(),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var x;(x=a.textContent)!=null&&x.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ue(a),a.remove(),E())});const l={x:c.x,y:c.y,text:"",size:2};M({name:"place text",undo(){a.remove(),n.text.pop(),E()},redo(){h.appendChild(a),n.text.push(l),a.focus(),E()}})}}}),p.addEventListener("pointermove",t=>{w.style.left=`${t.clientX}px`,w.style.top=`${t.clientY}px`});const vt=t=>{const i=b;if(!i)return;const a=n.pins[parseInt(i.dataset.idx||"",10)],c=a.images,l=[a.images,t].filter(x=>x).join("|");M({name:"add image to pin",undo(){a.images=c,ke(i),E()},redo(){a.images=l,ke(i),E()}})},wt=t=>{if(!b)return;const i=`${b.dataset.x}|${b.dataset.y}`,a=n.images[i];M({name:"place image",undo(){a?n.images[i]=a:delete n.images[i],pe(),E()},redo(){n.images[i]=t,pe(),E()}})};Zt(t=>{b&&ne==="pin"?vt(t):b&&ne==="image"&&wt(t)});let je=!1;window.addEventListener("keydown",t=>{var a;const i=document.activeElement;if((i==null?void 0:i.tagName)==="TEXTAREA"||(i==null?void 0:i.tagName)==="INPUT"||(i==null?void 0:i.contentEditable)==="plaintext-only"||(i==null?void 0:i.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&i.parentElement===h){t.preventDefault();const c=n.text[parseInt(i.dataset.idx||"",10)];c.size*=2,i.style.fontSize=`${c.size*100}%`,E()}else if(t.ctrlKey&&t.key==="-"&&i.parentElement===h){t.preventDefault();const c=n.text[parseInt(i.dataset.idx||"",10)];c.size/=2,i.style.fontSize=`${c.size*100}%`,E()}return}if(t.ctrlKey&&t.key==="z"){const c=Qt();c!==!1&&ie(["undo",c].filter(l=>l).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const c=Vt();c!==!1&&ie(["redo",c].filter(l=>l).join(" - "))}if(t.key==="Escape"&&se(),(t.key==="Backspace"||t.key==="Delete")&&b&&ne==="image"){const c=`${b.dataset.x}|${b.dataset.y}`,l=n.images[c];M({name:"delete image",undo(){n.images[c]=l,pe(),E()},redo(){delete n.images[c],pe(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&b&&ne==="drawing"){const c=Array.from(((a=b.parentElement)==null?void 0:a.children)||[]).indexOf(b),l=n.drawings[c];M({name:"delete drawing",undo(){n.drawings.splice(c,0,l),Se(),E()},redo(){n.drawings.splice(c,1),Se(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&b&&ne==="pin"&&$.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),Y.click();return}if(t.ctrlKey&&t.key==="c"&&b&&ne==="image"){t.preventDefault(),navigator.clipboard.writeText(b.src);return}if(!je&&t.key===" "){je=!0;const c=A,l=te;W("pan"),window.addEventListener("keyup",x=>{x.key===" "&&(je=!1,W(c,l))})}if(t.key==="q"){t.preventDefault(),W("select");return}if(t.key==="t"){t.preventDefault(),W("text");return}if(t.key==="b"){t.preventDefault(),W("draw",Fe);return}if(t.key==="p"){t.preventDefault(),W("pin",Ke);return}if(t.key==="f"){t.preventDefault();const[c,l,x,z]=Ye(),_=1/(Math.max(Math.abs(x-c),Math.abs(z-l))+2);for(n.zoom=1,d();s>_&&n.zoom>-100;)--n.zoom,d();Ze(((c+x)/2+.5)*r[0],((l+z)/2+.5)*r[1]);return}}),p.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const i=s;d();const a=s-i,c=We(),l={x:(c.x+n.offset.x)/i,y:(c.y+n.offset.y)/i};n.offset.x+=l.x*a,n.offset.y+=l.y*a,ve(),b&&ae(b,ne)});const Ze=(t,i)=>{let a=0,c=0;u.clientWidth/p.clientWidth<u.clientHeight/p.clientHeight?a=u.clientWidth/2:c=u.clientHeight/2,n.offset.x=t*s-p.clientWidth/2-a,n.offset.y=i*s-p.clientHeight/2-c,yt(p.clientWidth/2+a,p.clientHeight/2+c),ve()};let Ce;ue.addEventListener("focus",()=>{Ce=new Ot("key"),Ce.addDocuments(Object.entries(o).flatMap(([t,{pins:i,text:a}])=>i.map((c,l)=>({key:`${t}-p-${l}`,area:t,text:[t,c.type,c.notes].filter(x=>x).join(" > "),original:c})).concat(a.map((c,l)=>({key:`${t}-t-${l}`,area:t,text:[t,c.text].filter(x=>x).join(" > "),original:c}))))),Ce.addIndex("text")}),ue.addEventListener("input",()=>{const t=Ce.search(ue.value);ye.textContent="",t.forEach(i=>{const a=document.createElement("li"),c=document.createElement("span");c.innerHTML=i.text,Ht(c,ue.value,Ce.tokenizer.tokenize);const l=document.createElement("button");l.title="focus",l.textContent="🔍",l.addEventListener("click",()=>{se();const x=i.area;e!==x&&j(x),Ze(i.original.x,i.original.y)}),l.addEventListener("dblclick",()=>{n.zoom=1,d()}),a.appendChild(l),a.appendChild(c),ye.appendChild(a)})}),Array.from(ee).forEach(t=>{const i=document.createElement("option");i.value=t.value,he.appendChild(i)}),j(e),Xe()})();
