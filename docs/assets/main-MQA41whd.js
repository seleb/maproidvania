import{g as xt,a as Te,s as Me}from"./Storage-gnyVIklg.js";import{e as Ue}from"./index-D3PXsbd7.js";var vt=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],u="",f=0,c=n.length;f<c;++f)u+=n.charAt(f),s.push(u);return s},e}(),wt=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function Pe(e,r){r=r||[],e=e||{};for(var o=e,n=0;n<r.length;n++)if(o=o[r[n]],o==null)return null;return o}var Et=function(){function e(o){this._uidFieldName=o,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,u){this._tokenToIdfCache={};var f=this._tokenMap,c;typeof f[n]!="object"?f[n]=c={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(c=f[n],c.$totalNumOccurrences++);var p=c.$uidMap;typeof p[s]!="object"?(c.$numDocumentOccurrences++,p[s]={$document:u,$numTokenOccurrences:1}):p[s].$numTokenOccurrences++},r.search=function(n,s){for(var u={},f=0,c=n.length;f<c;f++){var p=n[f],S=this._tokenMap[p];if(!S)return[];if(f===0)for(var v=Object.keys(S.$uidMap),b=0,k=v.length;b<k;b++){var w=v[b];u[w]=S.$uidMap[w].$document}else for(var v=Object.keys(u),b=0,k=v.length;b<k;b++){var w=v[b];typeof S.$uidMap[w]!="object"&&delete u[w]}}var m=[];for(var w in u)m.push(u[w]);var I=this._createCalculateTfIdf();return m.sort(function(E,K){return I(n,K,s)-I(n,E,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(f,c){if(!s[f]){var p=typeof n[f]<"u"?n[f].$numDocumentOccurrences:0;s[f]=1+Math.log(c.length/(1+p))}return s[f]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,u=this._createCalculateIdf();return function(c,p,S){for(var v=0,b=0,k=c.length;b<k;++b){var w=c[b],m=u(w,S);m===1/0&&(m=0);var I;s instanceof Array?I=p&&Pe(p,s):I=p&&p[s];var E=typeof n[w]<"u"&&typeof n[w].$uidMap[I]<"u"?n[w].$uidMap[I].$numTokenOccurrences:0;v+=E*m}return v}},e}(),bt=/[^a-zа-яё0-9\-']+/i,St=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(bt).filter(function(s){return s})},e}();function He(e,r){for(var o=0;o<r.length;o++){var n=r[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function kt(e,r,o){return r&&He(e.prototype,r),o&&He(e,o),e}var $t=function(){function e(o){if(!o)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=o,this._indexStrategy=new vt,this._searchIndex=new Et(o),this._sanitizer=new wt,this._tokenizer=new St,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var u=this._indexStrategy,f=this._sanitizer,c=this._searchIndex,p=this._tokenizer,S=this._uidFieldName,v=0,b=n.length;v<b;v++){var k=n[v],w;S instanceof Array?w=Pe(k,S):w=k[S];for(var m=0,I=s.length;m<I;m++){var E,K=s[m];if(K instanceof Array?E=Pe(k,K):E=k[K],E!=null&&typeof E!="string"&&E.toString&&(E=E.toString()),typeof E=="string")for(var W=p.tokenize(f.sanitize(E)),F=0,ae=W.length;F<ae;F++)for(var D=W[F],ee=u.expandToken(D),Z=0,R=ee.length;Z<R;Z++){var te=ee[Z];c.indexDocument(te,w,k)}}}},kt(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),De={exports:{}};function Ct(e,r){var o=e[0]-r[0],n=e[1]-r[1];return o*o+n*n}var It=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;for(var n=o*o,s=r[0],u=[s],f,c=1,p=r.length;c<p;c++)f=r[c],Ct(f,s)>n&&(u.push(f),s=f);return s!==f&&u.push(f),u};function zt(e,r,o){var n=r[0],s=r[1],u=o[0]-n,f=o[1]-s;if(u!==0||f!==0){var c=((e[0]-n)*u+(e[1]-s)*f)/(u*u+f*f);c>1?(n=o[0],s=o[1]):c>0&&(n+=u*c,s+=f*c)}return u=e[0]-n,f=e[1]-s,u*u+f*f}function qe(e,r,o,n,s){for(var u=n,f,c=r+1;c<o;c++){var p=zt(e[c],e[r],e[o]);p>u&&(f=c,u=p)}u>n&&(f-r>1&&qe(e,r,f,n,s),s.push(e[f]),o-f>1&&qe(e,f,o,n,s))}var Lt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;var n=o*o,s=r.length-1,u=[r[0]];return qe(r,0,s,n,u),u.push(r[s]),u},at=It,st=Lt;De.exports=function(r,o){return r=at(r,o),r=st(r,o),r};De.exports.radialDistance=at;De.exports.douglasPeucker=st;var _t=De.exports;const Dt=xt(_t);let ct=!1;function y(e=!0){ct=e}window.addEventListener("beforeunload",function(e){if(!ct)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function Ge(e,r,o,n=s=>s){return e*n(.5-r*(.5-o))}function Ot(e){return[-e[0],-e[1]]}function G(e,r){return[e[0]+r[0],e[1]+r[1]]}function Y(e,r){return[e[0]-r[0],e[1]-r[1]]}function H(e,r){return[e[0]*r,e[1]*r]}function Tt(e,r){return[e[0]/r,e[1]/r]}function Se(e){return[e[1],-e[0]]}function Ze(e,r){return e[0]*r[0]+e[1]*r[1]}function Mt(e,r){return e[0]===r[0]&&e[1]===r[1]}function Pt(e){return Math.hypot(e[0],e[1])}function qt(e){return e[0]*e[0]+e[1]*e[1]}function Je(e,r){return qt(Y(e,r))}function lt(e){return Tt(e,Pt(e))}function Nt(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function ke(e,r,o){let n=Math.sin(o),s=Math.cos(o),u=e[0]-r[0],f=e[1]-r[1],c=u*s-f*n,p=u*n+f*s;return[c+r[0],p+r[1]]}function Ne(e,r,o){return G(e,H(Y(r,e),o))}function Qe(e,r,o){return G(e,H(r,o))}var{min:ye,PI:At}=Math,Ve=.275,$e=At+1e-4;function jt(e,r={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:u=!0,easing:f=x=>x,start:c={},end:p={},last:S=!1}=r,{cap:v=!0,easing:b=x=>x*(2-x)}=c,{cap:k=!0,easing:w=x=>--x*x*x+1}=p;if(e.length===0||o<=0)return[];let m=e[e.length-1].runningLength,I=c.taper===!1?0:c.taper===!0?Math.max(o,m):c.taper,E=p.taper===!1?0:p.taper===!0?Math.max(o,m):p.taper,K=Math.pow(o*n,2),W=[],F=[],ae=e.slice(0,10).reduce((x,L)=>{let $=L.pressure;if(u){let C=ye(1,L.distance/o),ne=ye(1,1-C);$=ye(1,x+(ne-x)*(C*Ve))}return(x+$)/2},e[0].pressure),D=Ge(o,s,e[e.length-1].pressure,f),ee,Z=e[0].vector,R=e[0].point,te=R,J=R,X=te,se=!1;for(let x=0;x<e.length;x++){let{pressure:L}=e[x],{point:$,vector:C,distance:ne,runningLength:B}=e[x];if(x<e.length-1&&m-B<3)continue;if(s){if(u){let Q=ye(1,ne/o),O=ye(1,1-Q);L=ye(1,ae+(O-ae)*(Q*Ve))}D=Ge(o,s,L,f)}else D=o/2;ee===void 0&&(ee=D);let me=B<I?b(B/I):1,Ie=m-B<E?w((m-B)/E):1;D=Math.max(.01,D*Math.min(me,Ie));let ce=(x<e.length-1?e[x+1]:e[x]).vector,A=x<e.length-1?Ze(C,ce):1,xe=Ze(C,Z)<0&&!se,ve=A!==null&&A<0;if(xe||ve){let Q=H(Se(Z),D);for(let O=1/13,j=0;j<=1;j+=O)J=ke(Y($,Q),$,$e*j),W.push(J),X=ke(G($,Q),$,$e*-j),F.push(X);R=J,te=X,ve&&(se=!0);continue}if(se=!1,x===e.length-1){let Q=H(Se(C),D);W.push(Y($,Q)),F.push(G($,Q));continue}let he=H(Se(Ne(ce,C,A)),D);J=Y($,he),(x<=1||Je(R,J)>K)&&(W.push(J),R=J),X=G($,he),(x<=1||Je(te,X)>K)&&(F.push(X),te=X),ae=L,Z=C}let q=e[0].point.slice(0,2),P=e.length>1?e[e.length-1].point.slice(0,2):G(e[0].point,[1,1]),fe=[],N=[];if(e.length===1){if(!(I||E)||S){let x=Qe(q,lt(Se(Y(q,P))),-(ee||D)),L=[];for(let $=1/13,C=$;C<=1;C+=$)L.push(ke(x,q,$e*2*C));return L}}else{if(!(I||E&&e.length===1))if(v)for(let L=1/13,$=L;$<=1;$+=L){let C=ke(F[0],q,$e*$);fe.push(C)}else{let L=Y(W[0],F[0]),$=H(L,.5),C=H(L,.51);fe.push(Y(q,$),Y(q,C),G(q,C),G(q,$))}let x=Se(Ot(e[e.length-1].vector));if(E||I&&e.length===1)N.push(P);else if(k){let L=Qe(P,x,D);for(let $=1/29,C=$;C<1;C+=$)N.push(ke(L,P,$e*3*C))}else N.push(G(P,H(x,D)),G(P,H(x,D*.99)),Y(P,H(x,D*.99)),Y(P,H(x,D)))}return W.concat(N,F.reverse(),fe)}function Ft(e,r={}){var o;let{streamline:n=.5,size:s=16,last:u=!1}=r;if(e.length===0)return[];let f=.15+(1-n)*.85,c=Array.isArray(e[0])?e:e.map(({x:w,y:m,pressure:I=.5})=>[w,m,I]);if(c.length===2){let w=c[1];c=c.slice(0,-1);for(let m=1;m<5;m++)c.push(Ne(c[0],w,m/4))}c.length===1&&(c=[...c,[...G(c[0],[1,1]),...c[0].slice(2)]]);let p=[{point:[c[0][0],c[0][1]],pressure:c[0][2]>=0?c[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],S=!1,v=0,b=p[0],k=c.length-1;for(let w=1;w<c.length;w++){let m=u&&w===k?c[w].slice(0,2):Ne(b.point,c[w],f);if(Mt(b.point,m))continue;let I=Nt(m,b.point);if(v+=I,w<k&&!S){if(v<s)continue;S=!0}b={point:m,pressure:c[w][2]>=0?c[w][2]:.5,vector:lt(Y(b.point,m)),distance:I,runningLength:v},p.push(b)}return p[0].vector=((o=p[1])==null?void 0:o.vector)||[0,0],p}function Rt(e,r={}){return jt(Ft(e,r),r)}var Xt=Rt;const Le=(e,r)=>(e+r)/2;function Yt(e,r=!0){const o=e.length;if(o<4)return"";let n=e[0],s=e[1];const u=e[2];let f=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${Le(s[0],u[0]).toFixed(2)},${Le(s[1],u[1]).toFixed(2)} T`;for(let c=2,p=o-1;c<p;c++)n=e[c],s=e[c+1],f+=`${Le(n[0],s[0]).toFixed(2)},${Le(n[1],s[1]).toFixed(2)} `;return r&&(f+="Z"),f}function et(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),Ae(r,e.points,e.size),r}function Ae(e,r,o){e.setAttributeNS(null,"d",Yt(Xt(r,{size:o,smoothing:.5,streamline:.25,thinning:.5})))}function tt(e,r,o){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),o)}function nt(e,r){const o=[],n=/^\s*$/;function s(u){if(u.nodeType==3)(r||!n.test(u.nodeValue||""))&&o.push(u);else for(var f=0,c=u.childNodes.length;f<c;++f)s(u.childNodes[f])}return s(e),o}const rt=(e,r)=>{e.forEach(o=>{const n=o.textContent,s=r(n||""),u=document.createRange().createContextualFragment(s);o.replaceWith(u)})},Kt=(e,r,o)=>{const n=o(r);let s=nt(e,!0);rt(s,u=>tt(u,[r],'<mark class="exact">$1</mark>')),s=nt(e,!0),rt(s,u=>tt(u,n,"<mark>$1</mark>"))},{parse:Wt,stringify:Bt}=JSON,{keys:Ut}=Object,Ce=String,dt="string",ot={},_e="object",ut=(e,r)=>r,Ht=e=>e instanceof Ce?Ce(e):e,Gt=(e,r)=>typeof r===dt?new Ce(r):r,ft=(e,r,o,n)=>{const s=[];for(let u=Ut(o),{length:f}=u,c=0;c<f;c++){const p=u[c],S=o[p];if(S instanceof Ce){const v=e[S];typeof v===_e&&!r.has(v)?(r.add(v),o[p]=ot,s.push({k:p,a:[e,r,v,n]})):o[p]=n.call(o,p,v)}else o[p]!==ot&&(o[p]=n.call(o,p,S))}for(let{length:u}=s,f=0;f<u;f++){const{k:c,a:p}=s[f];o[c]=n.call(o,c,ft.apply(null,p))}return o},it=(e,r,o)=>{const n=Ce(r.push(o)-1);return e.set(o,n),n},Zt=(e,r)=>{const o=Wt(e,Gt).map(Ht),n=o[0],s=r||ut,u=typeof n===_e&&n?ft(o,new Set,n,s):n;return s.call({"":u},"",u)},Jt=(e,r,o)=>{const n=r&&typeof r===_e?(v,b)=>v===""||-1<r.indexOf(v)?b:void 0:r||ut,s=new Map,u=[],f=[];let c=+it(s,u,n.call({"":e},"",e)),p=!c;for(;c<u.length;)p=!0,f[c]=Bt(u[c++],S,o);return"["+f.join(",")+"]";function S(v,b){if(p)return p=!p,b;const k=n.call(this,v,b);switch(typeof k){case _e:if(k===null)return k;case dt:return s.get(k)||it(s,u,k)}return k}};function Qt(){return new Promise((e,r)=>{const o=document.createElement("input");o.type="file",o.onchange=()=>{var u;const n=(u=o.files)==null?void 0:u[0];if(!n)return;const s=new FileReader;s.readAsText(n,"UTF-8"),s.onload=()=>{var f;e(Zt(((f=s.result)==null?void 0:f.toString())||""))},s.onerror=r},o.click()})}function Vt(e){document.addEventListener("paste",r=>{const o=r.clipboardData||r.originalEvent.clipboardData,n=o.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=o.items;for(let u in s){const f=s[u];if(f.kind==="file"){const c=f.getAsFile(),p=new FileReader;p.onload=()=>{const S=p.result;S!=null&&S.startsWith("data:image")&&e(S)},p.readAsDataURL(c)}}})}async function en(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable();await n.write(Jt(e)),await n.close()}const V=[];let ie=-1;const tn=50;function M(e){for(V.splice(ie+1,V.length),V.push(e);V.length>tn;)V.shift();ie=V.length-1,V[ie].redo()}function nn(){const e=V[ie];return e?(e.undo(),--ie,e.name):(ie=-1,!1)}function rn(){++ie;const e=V[ie];return e?(e==null||e.redo(),e==null?void 0:e.name):(ie=V.length-1,!1)}(async()=>{let e=Te("current"),r=Te("grid"),o=Te("areas"),n,s=1;const u=()=>{s=Math.pow(1.1,n.zoom)},f=document.querySelector("#controls"),c=document.querySelector("#map-container"),p=document.querySelector("#map"),S=document.querySelector("#images"),v=document.querySelector("#drawings"),b=document.querySelector("#pins"),k=document.querySelector("#text"),w=document.querySelector("#about"),m=document.querySelector("#cursor"),I=document.querySelector("#btn-about"),E=document.querySelector("#areas"),K=document.querySelector("#btn-area-add"),W=document.querySelector("#btn-area-rename"),F=document.querySelector("#btn-area-delete"),ae=document.querySelector("#btn-grid"),D=document.querySelector("#btn-save"),ee=document.querySelector("#btn-export"),Z=document.querySelector("#btn-import"),R=document.querySelector("#btn-select"),te=document.querySelector("#btn-pan"),J=document.querySelector("#btn-text"),X=document.querySelectorAll('#options-colour > input[type="radio"]'),se=document.querySelector("#stroke"),q=document.querySelectorAll('#options-pin input[type="radio"]'),P=document.querySelector("#custom-pin"),fe=document.querySelector("#custom-pin-entry"),N=document.querySelector("#context"),x=document.querySelector("#context-delete"),L=document.querySelector("#context-pin"),$=document.querySelector("#context-datalist"),C=document.querySelector("#context-notes"),ne=document.querySelector("#context-images"),B=document.querySelector("#search"),me=document.querySelector("#search-results"),Ie=document.querySelector("#toasts");if(!f||!c||!p||!S||!v||!b||!k||!w||!m||!R||!te||!J||!I||!E||!K||!W||!F||!ae||!D||!ee||!Z||!X.length||!se||!q.length||!P||!fe||!N||!x||!$||!L||!C||!ne||!B||!me||!Ie)throw new Error("Could not find elements");const ce=t=>{const i=document.createElement("li");i.textContent=t,Ie.appendChild(i),setTimeout(()=>{i.remove()},2500)},A=t=>{e=t,n=o[t],E.value=t,de(),Q()},xe=()=>{E.textContent="",Object.keys(o).sort().forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e&&(i.selected=!0),E.appendChild(i)})},ve=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},he=()=>{b.textContent="",n.pins.forEach((t,i)=>{const a=t.type,l=document.createElement("div");l.textContent=a||"???",l.style.top=`${t.y}px`,l.style.left=`${t.x}px`,b.appendChild(l),l.dataset.idx=i.toString(10)}),ve()},Q=()=>{xe(),he(),k.textContent="",n.text.forEach((t,i)=>{const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}a.style.top=`${t.y}px`,a.style.left=`${t.x}px`,a.style.fontSize=`${t.size*100}%`,a.textContent=t.text,a.dataset.idx=i.toString(10),k.appendChild(a),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",y()}),a.addEventListener("blur",()=>{var l;(l=a.textContent)!=null&&l.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Be(a),a.remove(),y())})}),we(),pe(),u(),ge()};I.addEventListener("click",()=>{w.classList.toggle("show")}),E.addEventListener("change",()=>{const t=e,i=E.value;t!==i&&M({name:"change area",undo(){A(t)},redo(){A(i)}})}),K.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(o).length}`);if(!t)return;if(o[t]){window.alert("error: an area with that name already exists!");return}const i=e,a={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};M({name:"create area",undo(){delete o[t],xe(),A(i),y()},redo(){o[t]=a,xe(),A(t),y()}})}),W.addEventListener("click",()=>{const t=e,i=window.prompt("rename area",e);!i||i===t||M({name:"rename area",undo(){o[t]=o[i],delete o[i],e=t,E.selectedOptions[0].value=E.selectedOptions[0].textContent=t,y()},redo(){o[i]=o[t],delete o[t],e=i,E.selectedOptions[0].value=E.selectedOptions[0].textContent=i,y()}})}),F.addEventListener("click",()=>{const t=e;if(Object.keys(o).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const i=Object.keys(o).filter(h=>h!==t)[0],a=o[t],l=E.selectedOptions[0],d=E.selectedIndex;M({name:"delete area",undo(){o[t]=a,E.insertBefore(l,E.children[d]),A(t),y()},redo(){delete o[t],l.remove(),A(i),y()}})}),ae.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",i=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!i)return;const a=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!a)return;const l=r[0],d=r[1],h=parseInt(i,10),z=parseInt(a,10);M({name:"resize grid",undo(){r[0]=l,r[1]=d,pe(),y()},redo(){r[0]=h,r[1]=z,pe(),y()}})}),D.addEventListener("click",async()=>{await Me("grid",r),await Me("current",e),await Me("areas",o),ce("saved"),y(!1)}),ee.addEventListener("click",async()=>{try{await en({grid:r,current:e,areas:o}),ce("exported"),y(!1)}catch(t){Ue(t),window.alert(`error: failed to export - ${t.message}`)}}),Z.addEventListener("click",async()=>{try{const t=await Qt();if(typeof t.current!="string"||typeof t.areas!="object")throw new Error("invalid file");const i=r,a=t.grid,l=o,d=t.areas,h=e,z=t.current;ce("imported"),M({name:"import",undo(){r=i,o=l,A(h),y()},redo(){r=a,o=d,A(z),y()}})}catch(t){Ue(t),window.alert(`error: failed to import - ${t.message}`)}}),X.forEach(t=>{t.style.backgroundColor=t.value}),q.forEach(t=>{var a;const i=document.createElement("span");i.textContent=t.value||"",(a=t.parentElement)==null||a.appendChild(i)});let O="select",j="",je=Array.from(X)[0].value,Fe=Array.from(q)[0].value;const U=(t,i="",a=!0)=>{var l;O=t,j=i,O==="select"?(m.textContent="",m.className="select",c.style.cursor="auto"):O==="pan"?(m.textContent="",m.className="pan",c.style.cursor="grab"):O==="text"?(m.textContent="Type here...",m.className="text",c.style.cursor="text"):O==="pin"?(Fe=j,m.textContent=j,m.className="pin",c.style.cursor="none"):O==="draw"&&(je=j,m.style.setProperty("--colour",j),m.textContent="",m.className="draw",c.style.cursor="crosshair"),a&&((l=document.querySelector(`input[type="radio"][name="tool"][value="${j||O}"]`))==null||l.click())};X.forEach(t=>{t.addEventListener("change",()=>{U("draw",t.value,!1)})}),fe.addEventListener("input",()=>{P.value=fe.value,P.nextElementSibling.textContent=P.value,P.disabled=!P.value.trim()}),q.forEach(t=>{t.addEventListener("change",()=>{U("pin",t.value,!1)})}),R.addEventListener("change",()=>{U("select",void 0,!1)}),te.addEventListener("change",()=>{U("pan",void 0,!1)}),J.addEventListener("change",()=>{U("text",void 0,!1)});const Re=()=>{m.style.setProperty("--size",`${parseInt(se.value,10)}px`)};se.addEventListener("input",Re);const pt=(t,i)=>{const a=parseFloat(se.value)/(s*2),l=et({points:[],colour:i,size:a});v.appendChild(l);let d=[];const h=10;let z=0;const _=oe=>{const ze=Date.now(),ue=Xe(oe.clientX,oe.clientY);ue.x/=s,ue.y/=s,ze-z<h?(d[d.length-1][0]=ue.x,d[d.length-1][1]=ue.y):(z=ze,d=Dt(d,2/s),d.push([ue.x,ue.y])),Ae(l,d,a)};_(t);const T=()=>{window.removeEventListener("pointermove",_),Ae(l,d,a);const oe={points:d,size:a,colour:i};M({name:"draw",undo(){n.drawings.pop(),we(),y()},redo(){n.drawings.push(oe),we(),y()}})};window.addEventListener("pointermove",_),window.addEventListener("pointerup",T,{once:!0})},ge=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;c.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,c.style.backgroundPositionX=`${-n.offset.x}px`,c.style.backgroundPositionY=`${-n.offset.y}px`,p.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,ve()},we=()=>{v.textContent="",n.drawings.forEach(t=>{v.appendChild(et(t))})},pe=()=>{S.textContent="";const[t,i,a,l]=Object.keys(n.images).length?Object.keys(n.images).map(d=>d.split("|").map(h=>parseInt(h,10))).reduce(([d,h,z,_],[T,oe])=>[Math.min(d,T),Math.min(h,oe),Math.max(z,T),Math.max(_,oe)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0];for(let d=i-1;d<=l+1;++d)for(let h=t-1;h<=a+1;++h){const z=n.images[`${h}|${d}`],_=document.createElement(z?"img":"div");_.src=z,_.draggable=!1,_.dataset.x=h.toString(10),_.dataset.y=d.toString(10),_.style.width=`${r[0]}px`,_.style.height=`${r[1]}px`,_.style.transform=`translate(${h*r[0]}px, ${d*r[1]}px)`,S.appendChild(_)}},Xe=(t,i)=>({x:t+n.offset.x,y:i+n.offset.y}),Ye=()=>({x:parseFloat(m.style.left),y:parseFloat(m.style.top)}),Ke=()=>{const t=Ye(),i=Xe(t.x,t.y);return i.x/=s,i.y/=s,i},We=t=>{const i={...n.offset},a={x:t.clientX,y:t.clientY},l=c.style.cursor;c.style.cursor="grabbing";const d=z=>{n.offset.x=-(z.clientX-a.x)+i.x,n.offset.y=-(z.clientY-a.y)+i.y,g&&le(g,re),ge()},h=()=>{window.removeEventListener("pointermove",d),c.style.cursor=l};window.addEventListener("pointermove",d),window.addEventListener("pointerup",h,{once:!0})},mt=(t,i,a)=>{const l={x:t.clientX,y:t.clientY},d={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)},h=c.style.cursor;c.style.cursor="move";const z=T=>{a((T.clientX-l.x)/s+d.x,(T.clientY-l.y)/s+d.y)},_=()=>{window.removeEventListener("pointermove",z),c.style.cursor=h;const T={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)};(T.x!==d.x||T.y!==d.y)&&M({name:"move",undo(){a(d.x,d.y),y()},redo(){a(T.x,T.y),y()}})};window.addEventListener("pointermove",z),window.addEventListener("pointerup",_,{once:!0})};let g=null,re="";const Ee=t=>{var l;if(t!==g)return;const i=n.pins[parseInt(t.dataset.idx||"",10)];ne.textContent="";const a=(((l=i.images)==null?void 0:l.split("|"))||[]).filter(d=>d);if(a.forEach(d=>{const h=document.createElement("img");h.src=d,h.draggable=!1;const z=document.createElement("li"),_=document.createElement("button");_.title="open in new tab",_.textContent="🔍",_.addEventListener("click",()=>{window.open(d,"_blank")});const T=document.createElement("button");T.title="delete",T.textContent="✖",T.addEventListener("click",()=>{z.remove();const oe=i.images,ze=Array.from(ne.querySelectorAll("img")).map(ue=>ue.src).join("|");M({name:"delete image in pin",undo(){i.images=oe,Ee(t),y()},redo(){i.images=ze,Ee(t),y()}})}),z.appendChild(_),z.appendChild(T),z.appendChild(h),ne.appendChild(z)}),!a.length){const d=document.createElement("li");d.textContent="paste to add image",d.className="null",ne.appendChild(d)}},le=(t,i)=>{if(de(),g=t,re=i,i==="pin"){const a=n.pins[parseInt(g.dataset.idx||"",10)];N.classList.add("show");const l=g.getBoundingClientRect();g.classList.add("selected"),L.value=a.type||"???",C.value=a.notes||"",Ee(t),N.style.top=`${l.bottom<c.clientHeight/2?l.bottom:l.top-N.clientHeight}px`,N.style.left=`${l.right<c.clientWidth/2?l.right:l.left-N.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",d=>{d.target&&![N,g].includes(d.target)&&!(N.contains(d.target)||!(g!=null&&g.contains(d.target)))&&de()},{once:!0})})}else(i==="image"||i==="drawing")&&g.classList.add("selected")},de=()=>{N.classList.remove("show"),g==null||g.classList.remove("selected"),g=null},Be=t=>{let i=t.nextSibling;for(;i;)i.dataset.idx=(parseInt(i.dataset.idx||"",10)-1).toString(10),i=i.nextSibling};x.addEventListener("click",()=>{if(!g)return;const t=parseInt(g.dataset.idx||"",10),i=n.pins[t];M({name:"delete pin",undo(){n.pins.splice(t,0,i),he(),le(b.children[t],"pin"),y()},redo(){n.pins.splice(t,1),he(),de(),y()}})}),L.addEventListener("input",()=>{if(!g)return;const t=n.pins[parseInt(g.dataset.idx||"",10)];t.type=L.value||"???",g.textContent=t.type,y()}),C.addEventListener("input",()=>{if(!g)return;const t=n.pins[parseInt(g.dataset.idx||"",10)];t.notes=C.value,y()}),c.addEventListener("pointerdown",t=>{const i=document.activeElement;if(f.contains(i)&&(i==null||i.blur()),t.button===1){t.preventDefault(),We(t);return}else if(t.button===0){if(O==="select"){de();const a=document.elementFromPoint(t.clientX,t.clientY);if(a!=null&&a.closest("#pins")){i==null||i.blur(),t.preventDefault(),le(a,"pin");const l=n.pins[parseInt(a.dataset.idx||"",10)];mt(t,a,(d,h)=>{a.style.left=`${d}px`,a.style.top=`${h}px`,l.x=d,l.y=h,le(a,"pin")})}else a!=null&&a.closest("#images")?(i==null||i.blur(),t.preventDefault(),le(a,"image")):a!=null&&a.closest("#drawings")&&(i==null||i.blur(),t.preventDefault(),le(a,"drawing"));return}else if(O==="pan")t.preventDefault(),We(t);else if(O==="pin"){t.preventDefault();const a=j,l=document.createElement("div");l.textContent=a;const d=Ke();l.style.top=`${d.y}px`,l.style.left=`${d.x}px`,l.dataset.idx=n.pins.length.toString(10),R.click();const h={x:d.x,y:d.y,type:a,notes:"",images:""};M({name:"place pin",undo(){de(),n.pins.pop(),l.remove(),ge(),y()},redo(){b.appendChild(l),n.pins.push(h),ge(),le(l,"pin"),y()}})}else if(O==="draw")t.preventDefault(),pt(t,j);else if(O==="text"){t.preventDefault();const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}const l=Ke();a.style.top=`${l.y}px`,a.style.left=`${l.x}px`,a.style.fontSize="200%",a.dataset.idx=n.text.length.toString(10),R.click(),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",y()}),a.addEventListener("blur",()=>{var h;(h=a.textContent)!=null&&h.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Be(a),a.remove(),y())});const d={x:l.x,y:l.y,text:"",size:2};M({name:"place text",undo(){a.remove(),n.text.pop(),y()},redo(){k.appendChild(a),n.text.push(d),a.focus(),y()}})}}}),c.addEventListener("pointermove",t=>{m.style.left=`${t.clientX}px`,m.style.top=`${t.clientY}px`});const ht=t=>{const i=g;if(!i)return;const a=n.pins[parseInt(i.dataset.idx||"",10)],l=a.images,d=[a.images,t].filter(h=>h).join("|");M({name:"add image to pin",undo(){a.images=l,Ee(i),y()},redo(){a.images=d,Ee(i),y()}})},gt=t=>{if(!g)return;const i=`${g.dataset.x}|${g.dataset.y}`,a=n.images[i];M({name:"place image",undo(){a?n.images[i]=a:delete n.images[i],pe(),y()},redo(){n.images[i]=t,pe(),y()}})};Vt(t=>{g&&re==="pin"?ht(t):g&&re==="image"&&gt(t)});let Oe=!1;window.addEventListener("keydown",t=>{var a;const i=document.activeElement;if((i==null?void 0:i.tagName)==="TEXTAREA"||(i==null?void 0:i.tagName)==="INPUT"||(i==null?void 0:i.contentEditable)==="plaintext-only"||(i==null?void 0:i.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&i.parentElement===k){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size*=2,i.style.fontSize=`${l.size*100}%`,y()}else if(t.ctrlKey&&t.key==="-"&&i.parentElement===k){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size/=2,i.style.fontSize=`${l.size*100}%`,y()}return}if(t.ctrlKey&&t.key==="z"){const l=nn();l!==!1&&ce(["undo",l].filter(d=>d).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const l=rn();l!==!1&&ce(["redo",l].filter(d=>d).join(" - "))}if(t.key==="Escape"&&de(),(t.key==="Backspace"||t.key==="Delete")&&g&&re==="image"){const l=`${g.dataset.x}|${g.dataset.y}`,d=n.images[l];M({name:"delete image",undo(){n.images[l]=d,pe(),y()},redo(){delete n.images[l],pe(),y()}})}if((t.key==="Backspace"||t.key==="Delete")&&g&&re==="drawing"){const l=Array.from(((a=g.parentElement)==null?void 0:a.children)||[]).indexOf(g),d=n.drawings[l];M({name:"delete drawing",undo(){n.drawings.splice(l,0,d),we(),y()},redo(){n.drawings.splice(l,1),we(),y()}})}if((t.key==="Backspace"||t.key==="Delete")&&g&&re==="pin"&&x.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),D.click();return}if(t.ctrlKey&&t.key==="c"&&g&&re==="image"){t.preventDefault(),navigator.clipboard.writeText(g.src);return}if(!Oe&&t.key===" "){Oe=!0;const l=O,d=j;U("pan"),window.addEventListener("keyup",h=>{h.key===" "&&(Oe=!1,U(l,d))})}if(t.key==="q"){t.preventDefault(),U("select");return}if(t.key==="t"){t.preventDefault(),U("text");return}if(t.key==="b"){t.preventDefault(),U("draw",je);return}if(t.key==="p"){t.preventDefault(),U("pin",Fe);return}}),c.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const i=s;u();const a=s-i,l=Ye(),d={x:(l.x+n.offset.x)/i,y:(l.y+n.offset.y)/i};n.offset.x+=d.x*a,n.offset.y+=d.y*a,ge(),g&&le(g,re)});const yt=(t,i)=>{n.offset.x=t*s-c.clientWidth/2-me.clientWidth/2,n.offset.y=i*s-c.clientHeight/2,ge()};let be;B.addEventListener("focus",()=>{be=new $t("key"),be.addDocuments(Object.entries(o).flatMap(([t,{pins:i,text:a}])=>i.map((l,d)=>({key:`${t}-p-${d}`,area:t,text:[t,l.type,l.notes].filter(h=>h).join(" > "),original:l})).concat(a.map((l,d)=>({key:`${t}-t-${d}`,area:t,text:[t,l.text].filter(h=>h).join(" > "),original:l}))))),be.addIndex("text")}),B.addEventListener("input",()=>{const t=be.search(B.value);me.textContent="",t.forEach(i=>{const a=document.createElement("li"),l=document.createElement("span");l.innerHTML=i.text,Kt(l,B.value,be.tokenizer.tokenize);const d=document.createElement("button");d.title="focus",d.textContent="🔍",d.addEventListener("click",()=>{de();const h=i.area;e!==h&&A(h),yt(i.original.x,i.original.y)}),d.addEventListener("dblclick",()=>{n.zoom=1,u()}),a.appendChild(d),a.appendChild(l),me.appendChild(a)})}),Array.from(q).forEach(t=>{const i=document.createElement("option");i.value=t.value,$.appendChild(i)}),A(e),Re()})();
