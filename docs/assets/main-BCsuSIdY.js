import{g as ht,a as Le,s as De}from"./Storage-r8d0wHG4.js";import{e as Be}from"./index-LSloAIwY.js";var yt=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],d="",f=0,c=n.length;f<c;++f)d+=n.charAt(f),s.push(d);return s},e}(),gt=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function je(e,r){r=r||[],e=e||{};for(var o=e,n=0;n<r.length;n++)if(o=o[r[n]],o==null)return null;return o}var xt=function(){function e(o){this._uidFieldName=o,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,d){this._tokenToIdfCache={};var f=this._tokenMap,c;typeof f[n]!="object"?f[n]=c={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(c=f[n],c.$totalNumOccurrences++);var y=c.$uidMap;typeof y[s]!="object"?(c.$numDocumentOccurrences++,y[s]={$document:d,$numTokenOccurrences:1}):y[s].$numTokenOccurrences++},r.search=function(n,s){for(var d={},f=0,c=n.length;f<c;f++){var y=n[f],k=this._tokenMap[y];if(!k)return[];if(f===0)for(var g=Object.keys(k.$uidMap),m=0,v=g.length;m<v;m++){var h=g[m];d[h]=k.$uidMap[h].$document}else for(var g=Object.keys(d),m=0,v=g.length;m<v;m++){var h=g[m];typeof k.$uidMap[h]!="object"&&delete d[h]}}var p=[];for(var h in d)p.push(d[h]);var I=this._createCalculateTfIdf();return p.sort(function(b,Y){return I(n,Y,s)-I(n,b,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(f,c){if(!s[f]){var y=typeof n[f]<"u"?n[f].$numDocumentOccurrences:0;s[f]=1+Math.log(c.length/(1+y))}return s[f]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,d=this._createCalculateIdf();return function(c,y,k){for(var g=0,m=0,v=c.length;m<v;++m){var h=c[m],p=d(h,k);p===1/0&&(p=0);var I;s instanceof Array?I=y&&je(y,s):I=y&&y[s];var b=typeof n[h]<"u"&&typeof n[h].$uidMap[I]<"u"?n[h].$uidMap[I].$numTokenOccurrences:0;g+=b*p}return g}},e}(),vt=/[^a-zа-яё0-9\-']+/i,wt=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(vt).filter(function(s){return s})},e}();function We(e,r){for(var o=0;o<r.length;o++){var n=r[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function bt(e,r,o){return r&&We(e.prototype,r),o&&We(e,o),e}var Et=function(){function e(o){if(!o)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=o,this._indexStrategy=new yt,this._searchIndex=new xt(o),this._sanitizer=new gt,this._tokenizer=new wt,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var d=this._indexStrategy,f=this._sanitizer,c=this._searchIndex,y=this._tokenizer,k=this._uidFieldName,g=0,m=n.length;g<m;g++){var v=n[g],h;k instanceof Array?h=je(v,k):h=v[k];for(var p=0,I=s.length;p<I;p++){var b,Y=s[p];if(Y instanceof Array?b=je(v,Y):b=v[Y],b!=null&&typeof b!="string"&&b.toString&&(b=b.toString()),typeof b=="string")for(var B=y.tokenize(f.sanitize(b)),F=0,ae=B.length;F<ae;F++)for(var L=B[F],ee=d.expandToken(L),J=0,K=ee.length;J<K;J++){var te=ee[J];c.indexDocument(te,h,v)}}}},bt(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),ze={exports:{}};function St(e,r){var o=e[0]-r[0],n=e[1]-r[1];return o*o+n*n}var kt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;for(var n=o*o,s=r[0],d=[s],f,c=1,y=r.length;c<y;c++)f=r[c],St(f,s)>n&&(d.push(f),s=f);return s!==f&&d.push(f),d};function It(e,r,o){var n=r[0],s=r[1],d=o[0]-n,f=o[1]-s;if(d!==0||f!==0){var c=((e[0]-n)*d+(e[1]-s)*f)/(d*d+f*f);c>1?(n=o[0],s=o[1]):c>0&&(n+=d*c,s+=f*c)}return d=e[0]-n,f=e[1]-s,d*d+f*f}function Te(e,r,o,n,s){for(var d=n,f,c=r+1;c<o;c++){var y=It(e[c],e[r],e[o]);y>d&&(f=c,d=y)}d>n&&(f-r>1&&Te(e,r,f,n,s),s.push(e[f]),o-f>1&&Te(e,f,o,n,s))}var Ct=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;var n=o*o,s=r.length-1,d=[r[0]];return Te(r,0,s,n,d),d.push(r[s]),d},nt=kt,rt=Ct;ze.exports=function(r,o){return r=nt(r,o),r=rt(r,o),r};ze.exports.radialDistance=nt;ze.exports.douglasPeucker=rt;var $t=ze.exports;const Ot=ht($t);let ot=!1;function E(e=!0){ot=e}window.addEventListener("beforeunload",function(e){if(!ot)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function Ue(e,r,o,n=s=>s){return e*n(.5-r*(.5-o))}function zt(e){return[-e[0],-e[1]]}function G(e,r){return[e[0]+r[0],e[1]+r[1]]}function X(e,r){return[e[0]-r[0],e[1]-r[1]]}function H(e,r){return[e[0]*r,e[1]*r]}function _t(e,r){return[e[0]/r,e[1]/r]}function Se(e){return[e[1],-e[0]]}function He(e,r){return e[0]*r[0]+e[1]*r[1]}function Lt(e,r){return e[0]===r[0]&&e[1]===r[1]}function Dt(e){return Math.hypot(e[0],e[1])}function jt(e){return e[0]*e[0]+e[1]*e[1]}function Ge(e,r){return jt(X(e,r))}function it(e){return _t(e,Dt(e))}function Tt(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function ke(e,r,o){let n=Math.sin(o),s=Math.cos(o),d=e[0]-r[0],f=e[1]-r[1],c=d*s-f*n,y=d*n+f*s;return[c+r[0],y+r[1]]}function Ne(e,r,o){return G(e,H(X(r,e),o))}function Je(e,r,o){return G(e,H(r,o))}var{min:ge,PI:Nt}=Math,Ze=.275,Ie=Nt+1e-4;function Mt(e,r={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:d=!0,easing:f=S=>S,start:c={},end:y={},last:k=!1}=r,{cap:g=!0,easing:m=S=>S*(2-S)}=c,{cap:v=!0,easing:h=S=>--S*S*S+1}=y;if(e.length===0||o<=0)return[];let p=e[e.length-1].runningLength,I=c.taper===!1?0:c.taper===!0?Math.max(o,p):c.taper,b=y.taper===!1?0:y.taper===!0?Math.max(o,p):y.taper,Y=Math.pow(o*n,2),B=[],F=[],ae=e.slice(0,10).reduce((S,z)=>{let C=z.pressure;if(d){let $=ge(1,z.distance/o),ne=ge(1,1-$);C=ge(1,S+(ne-S)*($*Ze))}return(S+C)/2},e[0].pressure),L=Ue(o,s,e[e.length-1].pressure,f),ee,J=e[0].vector,K=e[0].point,te=K,Z=K,R=te,se=!1;for(let S=0;S<e.length;S++){let{pressure:z}=e[S],{point:C,vector:$,distance:ne,runningLength:W}=e[S];if(S<e.length-1&&p-W<3)continue;if(s){if(d){let Q=ge(1,ne/o),D=ge(1,1-Q);z=ge(1,ae+(D-ae)*(Q*Ze))}L=Ue(o,s,z,f)}else L=o/2;ee===void 0&&(ee=L);let me=W<I?m(W/I):1,Ce=p-W<b?h((p-W)/b):1;L=Math.max(.01,L*Math.min(me,Ce));let ce=(S<e.length-1?e[S+1]:e[S]).vector,P=S<e.length-1?He($,ce):1,xe=He($,J)<0&&!se,ve=P!==null&&P<0;if(xe||ve){let Q=H(Se(J),L);for(let D=1/13,A=0;A<=1;A+=D)Z=ke(X(C,Q),C,Ie*A),B.push(Z),R=ke(G(C,Q),C,Ie*-A),F.push(R);K=Z,te=R,ve&&(se=!0);continue}if(se=!1,S===e.length-1){let Q=H(Se($),L);B.push(X(C,Q)),F.push(G(C,Q));continue}let he=H(Se(Ne(ce,$,P)),L);Z=X(C,he),(S<=1||Ge(K,Z)>Y)&&(B.push(Z),K=Z),R=G(C,he),(S<=1||Ge(te,R)>Y)&&(F.push(R),te=R),ae=z,J=$}let M=e[0].point.slice(0,2),N=e.length>1?e[e.length-1].point.slice(0,2):G(e[0].point,[1,1]),fe=[],q=[];if(e.length===1){if(!(I||b)||k){let S=Je(M,it(Se(X(M,N))),-(ee||L)),z=[];for(let C=1/13,$=C;$<=1;$+=C)z.push(ke(S,M,Ie*2*$));return z}}else{if(!(I||b&&e.length===1))if(g)for(let z=1/13,C=z;C<=1;C+=z){let $=ke(F[0],M,Ie*C);fe.push($)}else{let z=X(B[0],F[0]),C=H(z,.5),$=H(z,.51);fe.push(X(M,C),X(M,$),G(M,$),G(M,C))}let S=Se(zt(e[e.length-1].vector));if(b||I&&e.length===1)q.push(N);else if(v){let z=Je(N,S,L);for(let C=1/29,$=C;$<1;$+=C)q.push(ke(z,N,Ie*3*$))}else q.push(G(N,H(S,L)),G(N,H(S,L*.99)),X(N,H(S,L*.99)),X(N,H(S,L)))}return B.concat(q,F.reverse(),fe)}function qt(e,r={}){var o;let{streamline:n=.5,size:s=16,last:d=!1}=r;if(e.length===0)return[];let f=.15+(1-n)*.85,c=Array.isArray(e[0])?e:e.map(({x:h,y:p,pressure:I=.5})=>[h,p,I]);if(c.length===2){let h=c[1];c=c.slice(0,-1);for(let p=1;p<5;p++)c.push(Ne(c[0],h,p/4))}c.length===1&&(c=[...c,[...G(c[0],[1,1]),...c[0].slice(2)]]);let y=[{point:[c[0][0],c[0][1]],pressure:c[0][2]>=0?c[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,g=0,m=y[0],v=c.length-1;for(let h=1;h<c.length;h++){let p=d&&h===v?c[h].slice(0,2):Ne(m.point,c[h],f);if(Lt(m.point,p))continue;let I=Tt(p,m.point);if(g+=I,h<v&&!k){if(g<s)continue;k=!0}m={point:p,pressure:c[h][2]>=0?c[h][2]:.5,vector:it(X(m.point,p)),distance:I,runningLength:g},y.push(m)}return y[0].vector=((o=y[1])==null?void 0:o.vector)||[0,0],y}function Pt(e,r={}){return Mt(qt(e,r),r)}var At=Pt;const Oe=(e,r)=>(e+r)/2;function Ft(e,r=!0){const o=e.length;if(o<4)return"";let n=e[0],s=e[1];const d=e[2];let f=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${Oe(s[0],d[0]).toFixed(2)},${Oe(s[1],d[1]).toFixed(2)} T`;for(let c=2,y=o-1;c<y;c++)n=e[c],s=e[c+1],f+=`${Oe(n[0],s[0]).toFixed(2)},${Oe(n[1],s[1]).toFixed(2)} `;return r&&(f+="Z"),f}function Qe(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),Me(r,e.points,e.size),r}function Me(e,r,o){e.setAttributeNS(null,"d",Ft(At(r,{size:o,smoothing:.5,streamline:.25,thinning:.5})))}function Ve(e,r,o){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),o)}function et(e,r){const o=[],n=/^\s*$/;function s(d){if(d.nodeType==3)(r||!n.test(d.nodeValue||""))&&o.push(d);else for(var f=0,c=d.childNodes.length;f<c;++f)s(d.childNodes[f])}return s(e),o}const tt=(e,r)=>{e.forEach(o=>{const n=o.textContent,s=r(n||""),d=document.createRange().createContextualFragment(s);o.replaceWith(d)})},Kt=(e,r,o)=>{const n=o(r);let s=et(e,!0);tt(s,d=>Ve(d,[r],'<mark class="exact">$1</mark>')),s=et(e,!0),tt(s,d=>Ve(d,n,"<mark>$1</mark>"))};function at(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function st(e){return e}function ct(e,r){r=r||{};const o=r.delimiter||".",n=r.maxDepth,s=r.transformKey||st,d={};function f(c,y,k){k=k||1,Object.keys(c).forEach(function(g){const m=c[g],v=r.safe&&Array.isArray(m),h=Object.prototype.toString.call(m),p=at(m),I=h==="[object Object]"||h==="[object Array]",b=y?y+o+s(g):s(g);if(!v&&!p&&I&&Object.keys(m).length&&(!r.maxDepth||k<n))return f(m,b,k+1);d[b]=m})}return f(e),d}function lt(e,r){r=r||{};const o=r.delimiter||".",n=r.overwrite||!1,s=r.transformKey||st,d={};if(at(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function c(g){const m=Number(g);return isNaN(m)||g.indexOf(".")!==-1||r.object?g:m}function y(g,m,v){return Object.keys(v).reduce(function(h,p){return h[g+o+p]=v[p],h},m)}function k(g){const m=Object.prototype.toString.call(g),v=m==="[object Array]",h=m==="[object Object]";if(g){if(v)return!g.length;if(h)return!Object.keys(g).length}else return!0}return e=Object.keys(e).reduce(function(g,m){const v=Object.prototype.toString.call(e[m]);return!(v==="[object Object]"||v==="[object Array]")||k(e[m])?(g[m]=e[m],g):y(m,g,ct(e[m],r))},{}),Object.keys(e).forEach(function(g){const m=g.split(o).map(s);let v=c(m.shift()),h=c(m[0]),p=d;for(;h!==void 0;){if(v==="__proto__")return;const I=Object.prototype.toString.call(p[v]),b=I==="[object Object]"||I==="[object Array]";if(!n&&!b&&typeof p[v]<"u")return;(n&&!b||!n&&p[v]==null)&&(p[v]=typeof h=="number"&&!r.object?[]:{}),p=p[v],m.length>0&&(v=c(m.shift()),h=c(m[0]))}p[v]=lt(e[g],r)}),d}function Rt(){return new Promise((e,r)=>{const o=document.createElement("input");o.type="file",o.onchange=()=>{var d;const n=(d=o.files)==null?void 0:d[0];if(!n)return;const s=new FileReader;s.readAsText(n,"UTF-8"),s.onload=()=>{var f;e(lt(Object.fromEntries(JSON.parse(((f=s.result)==null?void 0:f.toString())||""))))},s.onerror=r},o.click()})}function Xt(e){document.addEventListener("paste",r=>{const o=r.clipboardData||r.originalEvent.clipboardData,n=o.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=o.items;for(let d in s){const f=s[d];if(f.kind==="file"){const c=f.getAsFile(),y=new FileReader;y.onload=()=>{const k=y.result;k!=null&&k.startsWith("data:image")&&e(k)},y.readAsDataURL(c)}}})}async function Yt(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable(),s=Object.entries(ct(e));await n.write(`[
`);for(let d of s)await n.write(JSON.stringify(d)),d!==s[s.length-1]&&await n.write(`,
`);await n.write(`
]`),await n.close()}const V=[];let ie=-1;const Bt=50;function T(e){for(V.splice(ie+1,V.length),V.push(e);V.length>Bt;)V.shift();ie=V.length-1,V[ie].redo()}function Wt(){const e=V[ie];return e?(e.undo(),--ie,e.name):(ie=-1,!1)}function Ut(){++ie;const e=V[ie];return e?(e==null||e.redo(),e==null?void 0:e.name):(ie=V.length-1,!1)}(async()=>{let e=Le("current"),r=Le("grid"),o=Le("areas"),n,s=1;const d=()=>{s=Math.pow(1.1,n.zoom)},f=document.querySelector("#controls"),c=document.querySelector("#map-container"),y=document.querySelector("#map"),k=document.querySelector("#images"),g=document.querySelector("#drawings"),m=document.querySelector("#pins"),v=document.querySelector("#text"),h=document.querySelector("#about"),p=document.querySelector("#cursor"),I=document.querySelector("#btn-about"),b=document.querySelector("#areas"),Y=document.querySelector("#btn-area-add"),B=document.querySelector("#btn-area-rename"),F=document.querySelector("#btn-area-delete"),ae=document.querySelector("#btn-grid"),L=document.querySelector("#btn-save"),ee=document.querySelector("#btn-export"),J=document.querySelector("#btn-import"),K=document.querySelector("#btn-select"),te=document.querySelector("#btn-pan"),Z=document.querySelector("#btn-text"),R=document.querySelectorAll('#options-colour > input[type="radio"]'),se=document.querySelector("#stroke"),M=document.querySelectorAll('#options-pin input[type="radio"]'),N=document.querySelector("#custom-pin"),fe=document.querySelector("#custom-pin-entry"),q=document.querySelector("#context"),S=document.querySelector("#context-delete"),z=document.querySelector("#context-pin"),C=document.querySelector("#context-datalist"),$=document.querySelector("#context-notes"),ne=document.querySelector("#context-images"),W=document.querySelector("#search"),me=document.querySelector("#search-results"),Ce=document.querySelector("#toasts");if(!f||!c||!y||!k||!g||!m||!v||!h||!p||!K||!te||!Z||!I||!b||!Y||!B||!F||!ae||!L||!ee||!J||!R.length||!se||!M.length||!N||!fe||!q||!S||!C||!z||!$||!ne||!W||!me||!Ce)throw new Error("Could not find elements");const ce=t=>{const i=document.createElement("li");i.textContent=t,Ce.appendChild(i),setTimeout(()=>{i.remove()},2500)},P=t=>{e=t,n=o[t],b.value=t,ue(),Q()},xe=()=>{b.textContent="",Object.keys(o).sort().forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e&&(i.selected=!0),b.appendChild(i)})},ve=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},he=()=>{m.textContent="",n.pins.forEach((t,i)=>{const a=t.type,l=document.createElement("div");l.textContent=a||"???",l.style.top=`${t.y}px`,l.style.left=`${t.x}px`,m.appendChild(l),l.dataset.idx=i.toString(10)}),ve()},Q=()=>{xe(),he(),v.textContent="",n.text.forEach((t,i)=>{const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}a.style.top=`${t.y}px`,a.style.left=`${t.x}px`,a.style.fontSize=`${t.size*100}%`,a.textContent=t.text,a.dataset.idx=i.toString(10),v.appendChild(a),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var l;(l=a.textContent)!=null&&l.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ye(a),a.remove(),E())})}),we(),pe(),d(),ye()};I.addEventListener("click",()=>{h.classList.toggle("show")}),b.addEventListener("change",()=>{const t=e,i=b.value;t!==i&&T({name:"change area",undo(){P(t)},redo(){P(i)}})}),Y.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(o).length}`);if(!t)return;if(o[t]){window.alert("error: an area with that name already exists!");return}const i=e,a={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};T({name:"create area",undo(){delete o[t],xe(),P(i),E()},redo(){o[t]=a,xe(),P(t),E()}})}),B.addEventListener("click",()=>{const t=e,i=window.prompt("rename area",e);!i||i===t||T({name:"rename area",undo(){o[t]=o[i],delete o[i],e=t,b.selectedOptions[0].value=b.selectedOptions[0].textContent=t,E()},redo(){o[i]=o[t],delete o[t],e=i,b.selectedOptions[0].value=b.selectedOptions[0].textContent=i,E()}})}),F.addEventListener("click",()=>{const t=e;if(Object.keys(o).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const i=Object.keys(o).filter(x=>x!==t)[0],a=o[t],l=b.selectedOptions[0],u=b.selectedIndex;T({name:"delete area",undo(){o[t]=a,b.insertBefore(l,b.children[u]),P(t),E()},redo(){delete o[t],l.remove(),P(i),E()}})}),ae.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",i=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!i)return;const a=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!a)return;const l=r[0],u=r[1],x=parseInt(i,10),O=parseInt(a,10);T({name:"resize grid",undo(){r[0]=l,r[1]=u,pe(),E()},redo(){r[0]=x,r[1]=O,pe(),E()}})}),L.addEventListener("click",async()=>{await De("grid",r),await De("current",e),await De("areas",o),ce("saved"),E(!1)}),ee.addEventListener("click",async()=>{try{await Yt({grid:r,current:e,areas:o}),ce("exported"),E(!1)}catch(t){Be(t),window.alert(`error: failed to export - ${t.message}`)}}),J.addEventListener("click",async()=>{try{const t=await Rt();if(typeof t.current!="string"||typeof t.areas!="object")throw new Error("invalid file");const i=r,a=t.grid,l=o,u=t.areas,x=e,O=t.current;ce("imported"),T({name:"import",undo(){r=i,o=l,P(x),E()},redo(){r=a,o=u,P(O),E()}})}catch(t){Be(t),window.alert(`error: failed to import - ${t.message}`)}}),R.forEach(t=>{t.style.backgroundColor=t.value}),M.forEach(t=>{var a;const i=document.createElement("span");i.textContent=t.value||"",(a=t.parentElement)==null||a.appendChild(i)});let D="select",A="",qe=Array.from(R)[0].value,Pe=Array.from(M)[0].value;const U=(t,i="",a=!0)=>{var l;D=t,A=i,D==="select"?(p.textContent="",p.className="select",c.style.cursor="auto"):D==="pan"?(p.textContent="",p.className="pan",c.style.cursor="grab"):D==="text"?(p.textContent="Type here...",p.className="text",c.style.cursor="text"):D==="pin"?(Pe=A,p.textContent=A,p.className="pin",c.style.cursor="none"):D==="draw"&&(qe=A,p.style.setProperty("--colour",A),p.textContent="",p.className="draw",c.style.cursor="crosshair"),a&&((l=document.querySelector(`input[type="radio"][name="tool"][value="${A||D}"]`))==null||l.click())};R.forEach(t=>{t.addEventListener("change",()=>{U("draw",t.value,!1)})}),fe.addEventListener("input",()=>{N.value=fe.value,N.nextElementSibling.textContent=N.value,N.disabled=!N.value.trim()}),M.forEach(t=>{t.addEventListener("change",()=>{U("pin",t.value,!1)})}),K.addEventListener("change",()=>{U("select",void 0,!1)}),te.addEventListener("change",()=>{U("pan",void 0,!1)}),Z.addEventListener("change",()=>{U("text",void 0,!1)});const Ae=()=>{p.style.setProperty("--size",`${parseInt(se.value,10)}px`)};se.addEventListener("input",Ae);const ut=(t,i)=>{const a=parseFloat(se.value)/(s*2),l=Qe({points:[],colour:i,size:a});g.appendChild(l);let u=[];const x=10;let O=0;const _=oe=>{const $e=Date.now(),de=Fe(oe.clientX,oe.clientY);de.x/=s,de.y/=s,$e-O<x?(u[u.length-1][0]=de.x,u[u.length-1][1]=de.y):(O=$e,u=Ot(u,2/s),u.push([de.x,de.y])),Me(l,u,a)};_(t);const j=()=>{window.removeEventListener("pointermove",_),Me(l,u,a);const oe={points:u,size:a,colour:i};T({name:"draw",undo(){n.drawings.pop(),we(),E()},redo(){n.drawings.push(oe),we(),E()}})};window.addEventListener("pointermove",_),window.addEventListener("pointerup",j,{once:!0})},ye=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;c.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,c.style.backgroundPositionX=`${-n.offset.x}px`,c.style.backgroundPositionY=`${-n.offset.y}px`,y.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,ve()},we=()=>{g.textContent="",n.drawings.forEach(t=>{g.appendChild(Qe(t))})},pe=()=>{k.textContent="";const[t,i,a,l]=Object.keys(n.images).length?Object.keys(n.images).map(u=>u.split("|").map(x=>parseInt(x,10))).reduce(([u,x,O,_],[j,oe])=>[Math.min(u,j),Math.min(x,oe),Math.max(O,j),Math.max(_,oe)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0];for(let u=i-1;u<=l+1;++u)for(let x=t-1;x<=a+1;++x){const O=n.images[`${x}|${u}`],_=document.createElement(O?"img":"div");_.src=O,_.draggable=!1,_.dataset.x=x.toString(10),_.dataset.y=u.toString(10),_.style.width=`${r[0]}px`,_.style.height=`${r[1]}px`,_.style.transform=`translate(${x*r[0]}px, ${u*r[1]}px)`,k.appendChild(_)}},Fe=(t,i)=>({x:t+n.offset.x,y:i+n.offset.y}),Ke=()=>({x:parseFloat(p.style.left),y:parseFloat(p.style.top)}),Re=()=>{const t=Ke(),i=Fe(t.x,t.y);return i.x/=s,i.y/=s,i},Xe=t=>{const i={...n.offset},a={x:t.clientX,y:t.clientY},l=c.style.cursor;c.style.cursor="grabbing";const u=O=>{n.offset.x=-(O.clientX-a.x)+i.x,n.offset.y=-(O.clientY-a.y)+i.y,w&&le(w,re),ye()},x=()=>{window.removeEventListener("pointermove",u),c.style.cursor=l};window.addEventListener("pointermove",u),window.addEventListener("pointerup",x,{once:!0})},dt=(t,i,a)=>{const l={x:t.clientX,y:t.clientY},u={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)},x=c.style.cursor;c.style.cursor="move";const O=j=>{a((j.clientX-l.x)/s+u.x,(j.clientY-l.y)/s+u.y)},_=()=>{window.removeEventListener("pointermove",O),c.style.cursor=x;const j={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)};(j.x!==u.x||j.y!==u.y)&&T({name:"move",undo(){a(u.x,u.y),E()},redo(){a(j.x,j.y),E()}})};window.addEventListener("pointermove",O),window.addEventListener("pointerup",_,{once:!0})};let w=null,re="";const be=t=>{var l;if(t!==w)return;const i=n.pins[parseInt(t.dataset.idx||"",10)];ne.textContent="";const a=(((l=i.images)==null?void 0:l.split("|"))||[]).filter(u=>u);if(a.forEach(u=>{const x=document.createElement("img");x.src=u,x.draggable=!1;const O=document.createElement("li"),_=document.createElement("button");_.title="open in new tab",_.textContent="🔍",_.addEventListener("click",()=>{window.open(u,"_blank")});const j=document.createElement("button");j.title="delete",j.textContent="✖",j.addEventListener("click",()=>{O.remove();const oe=i.images,$e=Array.from(ne.querySelectorAll("img")).map(de=>de.src).join("|");T({name:"delete image in pin",undo(){i.images=oe,be(t),E()},redo(){i.images=$e,be(t),E()}})}),O.appendChild(_),O.appendChild(j),O.appendChild(x),ne.appendChild(O)}),!a.length){const u=document.createElement("li");u.textContent="paste to add image",u.className="null",ne.appendChild(u)}},le=(t,i)=>{if(ue(),w=t,re=i,i==="pin"){const a=n.pins[parseInt(w.dataset.idx||"",10)];q.classList.add("show");const l=w.getBoundingClientRect();w.classList.add("selected"),z.value=a.type||"???",$.value=a.notes||"",be(t),q.style.top=`${l.bottom<c.clientHeight/2?l.bottom:l.top-q.clientHeight}px`,q.style.left=`${l.right<c.clientWidth/2?l.right:l.left-q.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",u=>{u.target&&![q,w].includes(u.target)&&!(q.contains(u.target)||!(w!=null&&w.contains(u.target)))&&ue()},{once:!0})})}else(i==="image"||i==="drawing")&&w.classList.add("selected")},ue=()=>{q.classList.remove("show"),w==null||w.classList.remove("selected"),w=null},Ye=t=>{let i=t.nextSibling;for(;i;)i.dataset.idx=(parseInt(i.dataset.idx||"",10)-1).toString(10),i=i.nextSibling};S.addEventListener("click",()=>{if(!w)return;const t=parseInt(w.dataset.idx||"",10),i=n.pins[t];T({name:"delete pin",undo(){n.pins.splice(t,0,i),he(),le(m.children[t],"pin"),E()},redo(){n.pins.splice(t,1),he(),ue(),E()}})}),z.addEventListener("input",()=>{if(!w)return;const t=n.pins[parseInt(w.dataset.idx||"",10)];t.type=z.value||"???",w.textContent=t.type,E()}),$.addEventListener("input",()=>{if(!w)return;const t=n.pins[parseInt(w.dataset.idx||"",10)];t.notes=$.value,E()}),c.addEventListener("pointerdown",t=>{const i=document.activeElement;if(f.contains(i)&&(i==null||i.blur()),t.button===1){t.preventDefault(),Xe(t);return}else if(t.button===0){if(D==="select"){ue();const a=document.elementFromPoint(t.clientX,t.clientY);if(a!=null&&a.closest("#pins")){i==null||i.blur(),t.preventDefault(),le(a,"pin");const l=n.pins[parseInt(a.dataset.idx||"",10)];dt(t,a,(u,x)=>{a.style.left=`${u}px`,a.style.top=`${x}px`,l.x=u,l.y=x,le(a,"pin")})}else a!=null&&a.closest("#images")?(i==null||i.blur(),t.preventDefault(),le(a,"image")):a!=null&&a.closest("#drawings")&&(i==null||i.blur(),t.preventDefault(),le(a,"drawing"));return}else if(D==="pan")t.preventDefault(),Xe(t);else if(D==="pin"){t.preventDefault();const a=A,l=document.createElement("div");l.textContent=a;const u=Re();l.style.top=`${u.y}px`,l.style.left=`${u.x}px`,l.dataset.idx=n.pins.length.toString(10),K.click();const x={x:u.x,y:u.y,type:a,notes:"",images:""};T({name:"place pin",undo(){ue(),n.pins.pop(),l.remove(),ye(),E()},redo(){m.appendChild(l),n.pins.push(x),ye(),le(l,"pin"),E()}})}else if(D==="draw")t.preventDefault(),ut(t,A);else if(D==="text"){t.preventDefault();const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}const l=Re();a.style.top=`${l.y}px`,a.style.left=`${l.x}px`,a.style.fontSize="200%",a.dataset.idx=n.text.length.toString(10),K.click(),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",E()}),a.addEventListener("blur",()=>{var x;(x=a.textContent)!=null&&x.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ye(a),a.remove(),E())});const u={x:l.x,y:l.y,text:"",size:2};T({name:"place text",undo(){a.remove(),n.text.pop(),E()},redo(){v.appendChild(a),n.text.push(u),a.focus(),E()}})}}}),c.addEventListener("pointermove",t=>{p.style.left=`${t.clientX}px`,p.style.top=`${t.clientY}px`});const ft=t=>{const i=w;if(!i)return;const a=n.pins[parseInt(i.dataset.idx||"",10)],l=a.images,u=[a.images,t].filter(x=>x).join("|");T({name:"add image to pin",undo(){a.images=l,be(i),E()},redo(){a.images=u,be(i),E()}})},pt=t=>{if(!w)return;const i=`${w.dataset.x}|${w.dataset.y}`,a=n.images[i];T({name:"place image",undo(){a?n.images[i]=a:delete n.images[i],pe(),E()},redo(){n.images[i]=t,pe(),E()}})};Xt(t=>{w&&re==="pin"?ft(t):w&&re==="image"&&pt(t)});let _e=!1;window.addEventListener("keydown",t=>{var a;const i=document.activeElement;if((i==null?void 0:i.tagName)==="TEXTAREA"||(i==null?void 0:i.tagName)==="INPUT"||(i==null?void 0:i.contentEditable)==="plaintext-only"||(i==null?void 0:i.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&i.parentElement===v){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size*=2,i.style.fontSize=`${l.size*100}%`,E()}else if(t.ctrlKey&&t.key==="-"&&i.parentElement===v){t.preventDefault();const l=n.text[parseInt(i.dataset.idx||"",10)];l.size/=2,i.style.fontSize=`${l.size*100}%`,E()}return}if(t.ctrlKey&&t.key==="z"){const l=Wt();l!==!1&&ce(["undo",l].filter(u=>u).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const l=Ut();l!==!1&&ce(["redo",l].filter(u=>u).join(" - "))}if(t.key==="Escape"&&ue(),(t.key==="Backspace"||t.key==="Delete")&&w&&re==="image"){const l=`${w.dataset.x}|${w.dataset.y}`,u=n.images[l];T({name:"delete image",undo(){n.images[l]=u,pe(),E()},redo(){delete n.images[l],pe(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&w&&re==="drawing"){const l=Array.from(((a=w.parentElement)==null?void 0:a.children)||[]).indexOf(w),u=n.drawings[l];T({name:"delete drawing",undo(){n.drawings.splice(l,0,u),we(),E()},redo(){n.drawings.splice(l,1),we(),E()}})}if((t.key==="Backspace"||t.key==="Delete")&&w&&re==="pin"&&S.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),L.click();return}if(t.ctrlKey&&t.key==="c"&&w&&re==="image"){t.preventDefault(),navigator.clipboard.writeText(w.src);return}if(!_e&&t.key===" "){_e=!0;const l=D,u=A;U("pan"),window.addEventListener("keyup",x=>{x.key===" "&&(_e=!1,U(l,u))})}if(t.key==="q"){t.preventDefault(),U("select");return}if(t.key==="t"){t.preventDefault(),U("text");return}if(t.key==="b"){t.preventDefault(),U("draw",qe);return}if(t.key==="p"){t.preventDefault(),U("pin",Pe);return}}),c.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const i=s;d();const a=s-i,l=Ke(),u={x:(l.x+n.offset.x)/i,y:(l.y+n.offset.y)/i};n.offset.x+=u.x*a,n.offset.y+=u.y*a,ye(),w&&le(w,re)});const mt=(t,i)=>{n.offset.x=t*s-c.clientWidth/2-me.clientWidth/2,n.offset.y=i*s-c.clientHeight/2,ye()};let Ee;W.addEventListener("focus",()=>{Ee=new Et("key"),Ee.addDocuments(Object.entries(o).flatMap(([t,{pins:i,text:a}])=>i.map((l,u)=>({key:`${t}-p-${u}`,area:t,text:[t,l.type,l.notes].filter(x=>x).join(" > "),original:l})).concat(a.map((l,u)=>({key:`${t}-t-${u}`,area:t,text:[t,l.text].filter(x=>x).join(" > "),original:l}))))),Ee.addIndex("text")}),W.addEventListener("input",()=>{const t=Ee.search(W.value);me.textContent="",t.forEach(i=>{const a=document.createElement("li"),l=document.createElement("span");l.innerHTML=i.text,Kt(l,W.value,Ee.tokenizer.tokenize);const u=document.createElement("button");u.title="focus",u.textContent="🔍",u.addEventListener("click",()=>{ue();const x=i.area;e!==x&&P(x),mt(i.original.x,i.original.y)}),u.addEventListener("dblclick",()=>{n.zoom=1,d()}),a.appendChild(u),a.appendChild(l),me.appendChild(a)})}),Array.from(M).forEach(t=>{const i=document.createElement("option");i.value=t.value,C.appendChild(i)}),P(e),Ae()})();
