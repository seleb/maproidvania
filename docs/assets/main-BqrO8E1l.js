import{g as Et,a as be,s as Ne,r as St}from"./Storage-DJIz66Gu.js";import{e as Te}from"./index-Dc_9f-Ua.js";var kt=function(){function e(){}var r=e.prototype;return r.expandToken=function(n){for(var s=[],u="",f=0,d=n.length;f<d;++f)u+=n.charAt(f),s.push(u);return s},e}(),Ct=function(){function e(){}var r=e.prototype;return r.sanitize=function(n){return n?n.toLocaleLowerCase().trim():""},e}();function qe(e,r){r=r||[],e=e||{};for(var o=e,n=0;n<r.length;n++)if(o=o[r[n]],o==null)return null;return o}var $t=function(){function e(o){this._uidFieldName=o,this._tokenToIdfCache={},this._tokenMap={}}var r=e.prototype;return r.indexDocument=function(n,s,u){this._tokenToIdfCache={};var f=this._tokenMap,d;typeof f[n]!="object"?f[n]=d={$numDocumentOccurrences:0,$totalNumOccurrences:1,$uidMap:{}}:(d=f[n],d.$totalNumOccurrences++);var p=d.$uidMap;typeof p[s]!="object"?(d.$numDocumentOccurrences++,p[s]={$document:u,$numTokenOccurrences:1}):p[s].$numTokenOccurrences++},r.search=function(n,s){for(var u={},f=0,d=n.length;f<d;f++){var p=n[f],C=this._tokenMap[p];if(!C)return[];if(f===0)for(var x=Object.keys(C.$uidMap),m=0,y=x.length;m<y;m++){var h=x[m];u[h]=C.$uidMap[h].$document}else for(var x=Object.keys(u),m=0,y=x.length;m<y;m++){var h=x[m];typeof C.$uidMap[h]!="object"&&delete u[h]}}var w=[];for(var h in u)w.push(u[h]);var v=this._createCalculateTfIdf();return w.sort(function($,X){return v(n,X,s)-v(n,$,s)})},r._createCalculateIdf=function(){var n=this._tokenMap,s=this._tokenToIdfCache;return function(f,d){if(!s[f]){var p=typeof n[f]<"u"?n[f].$numDocumentOccurrences:0;s[f]=1+Math.log(d.length/(1+p))}return s[f]}},r._createCalculateTfIdf=function(){var n=this._tokenMap,s=this._uidFieldName,u=this._createCalculateIdf();return function(d,p,C){for(var x=0,m=0,y=d.length;m<y;++m){var h=d[m],w=u(h,C);w===1/0&&(w=0);var v;s instanceof Array?v=p&&qe(p,s):v=p&&p[s];var $=typeof n[h]<"u"&&typeof n[h].$uidMap[v]<"u"?n[h].$uidMap[v].$numTokenOccurrences:0;x+=$*w}return x}},e}(),It=/[^a-zа-яё0-9\-']+/i,Ot=function(){function e(){}var r=e.prototype;return r.tokenize=function(n){return n.split(It).filter(function(s){return s})},e}();function Qe(e,r){for(var o=0;o<r.length;o++){var n=r[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zt(e,r,o){return r&&Qe(e.prototype,r),o&&Qe(e,o),e}var Lt=function(){function e(o){if(!o)throw Error("js-search requires a uid field name constructor parameter");this._uidFieldName=o,this._indexStrategy=new kt,this._searchIndex=new $t(o),this._sanitizer=new Ct,this._tokenizer=new Ot,this._documents=[],this._searchableFields=[]}var r=e.prototype;return r.addDocument=function(n){this.addDocuments([n])},r.addDocuments=function(n){this._documents=this._documents.concat(n),this.indexDocuments_(n,this._searchableFields)},r.addIndex=function(n){this._searchableFields.push(n),this.indexDocuments_(this._documents,[n])},r.search=function(n){var s=this._tokenizer.tokenize(this._sanitizer.sanitize(n));return this._searchIndex.search(s,this._documents)},r.indexDocuments_=function(n,s){this._initialized=!0;for(var u=this._indexStrategy,f=this._sanitizer,d=this._searchIndex,p=this._tokenizer,C=this._uidFieldName,x=0,m=n.length;x<m;x++){var y=n[x],h;C instanceof Array?h=qe(y,C):h=y[C];for(var w=0,v=s.length;w<v;w++){var $,X=s[w];if(X instanceof Array?$=qe(y,X):$=y[X],$!=null&&typeof $!="string"&&$.toString&&($=$.toString()),typeof $=="string")for(var z=p.tokenize(f.sanitize($)),q=0,re=z.length;q<re;q++)for(var D=z[q],Q=u.expandToken(D),Y=0,U=Q.length;Y<U;Y++){var V=Q[Y];d.indexDocument(V,h,y)}}}},zt(e,[{key:"indexStrategy",set:function(n){if(this._initialized)throw Error("IIndexStrategy cannot be set after initialization");this._indexStrategy=n},get:function(){return this._indexStrategy}},{key:"sanitizer",set:function(n){if(this._initialized)throw Error("ISanitizer cannot be set after initialization");this._sanitizer=n},get:function(){return this._sanitizer}},{key:"searchIndex",set:function(n){if(this._initialized)throw Error("ISearchIndex cannot be set after initialization");this._searchIndex=n},get:function(){return this._searchIndex}},{key:"tokenizer",set:function(n){if(this._initialized)throw Error("ITokenizer cannot be set after initialization");this._tokenizer=n},get:function(){return this._tokenizer}}]),e}(),De={exports:{}};function _t(e,r){var o=e[0]-r[0],n=e[1]-r[1];return o*o+n*n}var Dt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;for(var n=o*o,s=r[0],u=[s],f,d=1,p=r.length;d<p;d++)f=r[d],_t(f,s)>n&&(u.push(f),s=f);return s!==f&&u.push(f),u};function jt(e,r,o){var n=r[0],s=r[1],u=o[0]-n,f=o[1]-s;if(u!==0||f!==0){var d=((e[0]-n)*u+(e[1]-s)*f)/(u*u+f*f);d>1?(n=o[0],s=o[1]):d>0&&(n+=u*d,s+=f*d)}return u=e[0]-n,f=e[1]-s,u*u+f*f}function Pe(e,r,o,n,s){for(var u=n,f,d=r+1;d<o;d++){var p=jt(e[d],e[r],e[o]);p>u&&(f=d,u=p)}u>n&&(f-r>1&&Pe(e,r,f,n,s),s.push(e[f]),o-f>1&&Pe(e,f,o,n,s))}var Mt=function(r,o){if(r.length<=1)return r;o=typeof o=="number"?o:1;var n=o*o,s=r.length-1,u=[r[0]];return Pe(r,0,s,n,u),u.push(r[s]),u},ct=Dt,lt=Mt;De.exports=function(r,o){return r=ct(r,o),r=lt(r,o),r};De.exports.radialDistance=ct;De.exports.douglasPeucker=lt;var Nt=De.exports;const Tt=Et(Nt);let dt=!1;function b(e=!0){dt=e}window.addEventListener("beforeunload",function(e){if(!dt)return;const r="You have unsaved changes, are you sure you want to quit?";return(e||window.event).returnValue=r,r});function Ve(e,r,o,n=s=>s){return e*n(.5-r*(.5-o))}function qt(e){return[-e[0],-e[1]]}function H(e,r){return[e[0]+r[0],e[1]+r[1]]}function K(e,r){return[e[0]-r[0],e[1]-r[1]]}function B(e,r){return[e[0]*r,e[1]*r]}function Pt(e,r){return[e[0]/r,e[1]/r]}function $e(e){return[e[1],-e[0]]}function et(e,r){return e[0]*r[0]+e[1]*r[1]}function At(e,r){return e[0]===r[0]&&e[1]===r[1]}function Ft(e){return Math.hypot(e[0],e[1])}function Kt(e){return e[0]*e[0]+e[1]*e[1]}function tt(e,r){return Kt(K(e,r))}function ut(e){return Pt(e,Ft(e))}function Xt(e,r){return Math.hypot(e[1]-r[1],e[0]-r[0])}function Ie(e,r,o){let n=Math.sin(o),s=Math.cos(o),u=e[0]-r[0],f=e[1]-r[1],d=u*s-f*n,p=u*n+f*s;return[d+r[0],p+r[1]]}function Ae(e,r,o){return H(e,B(K(r,e),o))}function nt(e,r,o){return H(e,B(r,o))}var{min:Ee,PI:Yt}=Math,rt=.275,Oe=Yt+1e-4;function Rt(e,r={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:u=!0,easing:f=S=>S,start:d={},end:p={},last:C=!1}=r,{cap:x=!0,easing:m=S=>S*(2-S)}=d,{cap:y=!0,easing:h=S=>--S*S*S+1}=p;if(e.length===0||o<=0)return[];let w=e[e.length-1].runningLength,v=d.taper===!1?0:d.taper===!0?Math.max(o,w):d.taper,$=p.taper===!1?0:p.taper===!0?Math.max(o,w):p.taper,X=Math.pow(o*n,2),z=[],q=[],re=e.slice(0,10).reduce((S,L)=>{let k=L.pressure;if(u){let O=Ee(1,L.distance/o),ie=Ee(1,1-O);k=Ee(1,S+(ie-S)*(O*rt))}return(S+k)/2},e[0].pressure),D=Ve(o,s,e[e.length-1].pressure,f),Q,Y=e[0].vector,U=e[0].point,V=U,Z=U,F=V,ge=!1;for(let S=0;S<e.length;S++){let{pressure:L}=e[S],{point:k,vector:O,distance:ie,runningLength:ae}=e[S];if(S<e.length-1&&w-ae<3)continue;if(s){if(u){let N=Ee(1,ie/o),M=Ee(1,1-N);L=Ee(1,re+(M-re)*(N*rt))}D=Ve(o,s,L,f)}else D=o/2;Q===void 0&&(Q=D);let xe=ae<v?m(ae/v):1,fe=w-ae<$?h((w-ae)/$):1;D=Math.max(.01,D*Math.min(xe,fe));let se=(S<e.length-1?e[S+1]:e[S]).vector,pe=S<e.length-1?et(O,se):1,ze=et(O,Y)<0&&!ge,me=pe!==null&&pe<0;if(ze||me){let N=B($e(Y),D);for(let M=1/13,ce=0;ce<=1;ce+=M)Z=Ie(K(k,N),k,Oe*ce),z.push(Z),F=Ie(H(k,N),k,Oe*-ce),q.push(F);U=Z,V=F,me&&(ge=!0);continue}if(ge=!1,S===e.length-1){let N=B($e(O),D);z.push(K(k,N)),q.push(H(k,N));continue}let he=B($e(Ae(se,O,pe)),D);Z=K(k,he),(S<=1||tt(U,Z)>X)&&(z.push(Z),U=Z),F=H(k,he),(S<=1||tt(V,F)>X)&&(q.push(F),V=F),re=L,Y=O}let R=e[0].point.slice(0,2),P=e.length>1?e[e.length-1].point.slice(0,2):H(e[0].point,[1,1]),oe=[],G=[];if(e.length===1){if(!(v||$)||C){let S=nt(R,ut($e(K(R,P))),-(Q||D)),L=[];for(let k=1/13,O=k;O<=1;O+=k)L.push(Ie(S,R,Oe*2*O));return L}}else{if(!(v||$&&e.length===1))if(x)for(let L=1/13,k=L;k<=1;k+=L){let O=Ie(q[0],R,Oe*k);oe.push(O)}else{let L=K(z[0],q[0]),k=B(L,.5),O=B(L,.51);oe.push(K(R,k),K(R,O),H(R,O),H(R,k))}let S=$e(qt(e[e.length-1].vector));if($||v&&e.length===1)G.push(P);else if(y){let L=nt(P,S,D);for(let k=1/29,O=k;O<1;O+=k)G.push(Ie(L,P,Oe*3*O))}else G.push(H(P,B(S,D)),H(P,B(S,D*.99)),K(P,B(S,D*.99)),K(P,B(S,D)))}return z.concat(G,q.reverse(),oe)}function Wt(e,r={}){var o;let{streamline:n=.5,size:s=16,last:u=!1}=r;if(e.length===0)return[];let f=.15+(1-n)*.85,d=Array.isArray(e[0])?e:e.map(({x:h,y:w,pressure:v=.5})=>[h,w,v]);if(d.length===2){let h=d[1];d=d.slice(0,-1);for(let w=1;w<5;w++)d.push(Ae(d[0],h,w/4))}d.length===1&&(d=[...d,[...H(d[0],[1,1]),...d[0].slice(2)]]);let p=[{point:[d[0][0],d[0][1]],pressure:d[0][2]>=0?d[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],C=!1,x=0,m=p[0],y=d.length-1;for(let h=1;h<d.length;h++){let w=u&&h===y?d[h].slice(0,2):Ae(m.point,d[h],f);if(At(m.point,w))continue;let v=Xt(w,m.point);if(x+=v,h<y&&!C){if(x<s)continue;C=!0}m={point:w,pressure:d[h][2]>=0?d[h][2]:.5,vector:ut(K(m.point,w)),distance:v,runningLength:x},p.push(m)}return p[0].vector=((o=p[1])==null?void 0:o.vector)||[0,0],p}function Bt(e,r={}){return Rt(Wt(e,r),r)}var Ht=Bt;const _e=(e,r)=>(e+r)/2;function Ut(e,r=!0){const o=e.length;if(o<4)return"";let n=e[0],s=e[1];const u=e[2];let f=`M${n[0].toFixed(2)},${n[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${_e(s[0],u[0]).toFixed(2)},${_e(s[1],u[1]).toFixed(2)} T`;for(let d=2,p=o-1;d<p;d++)n=e[d],s=e[d+1],f+=`${_e(n[0],s[0]).toFixed(2)},${_e(n[1],s[1]).toFixed(2)} `;return r&&(f+="Z"),f}function ot(e){const r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttributeNS(null,"fill",e.colour),Fe(r,e.points,e.size),r}function Fe(e,r,o){e.setAttributeNS(null,"d",Ut(Ht(r,{size:o,smoothing:.5,streamline:.25,thinning:.5})))}function it(e,r,o){return e.replace(new RegExp(`(${r.map(n=>n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"ig"),o)}function at(e,r){const o=[],n=/^\s*$/;function s(u){if(u.nodeType==3)(r||!n.test(u.nodeValue||""))&&o.push(u);else for(var f=0,d=u.childNodes.length;f<d;++f)s(u.childNodes[f])}return s(e),o}const st=(e,r)=>{e.forEach(o=>{const n=o.textContent,s=r(n||""),u=document.createRange().createContextualFragment(s);o.replaceWith(u)})},Zt=(e,r,o)=>{const n=o(r);let s=at(e,!0);st(s,u=>it(u,[r],'<mark class="exact">$1</mark>')),s=at(e,!0),st(s,u=>it(u,n,"<mark>$1</mark>"))};function ft(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function pt(e){return e}function mt(e,r){r=r||{};const o=r.delimiter||".",n=r.maxDepth,s=r.transformKey||pt,u={};function f(d,p,C){C=C||1,Object.keys(d).forEach(function(x){const m=d[x],y=r.safe&&Array.isArray(m),h=Object.prototype.toString.call(m),w=ft(m),v=h==="[object Object]"||h==="[object Array]",$=p?p+o+s(x):s(x);if(!y&&!w&&v&&Object.keys(m).length&&(!r.maxDepth||C<n))return f(m,$,C+1);u[$]=m})}return f(e),u}function ht(e,r){r=r||{};const o=r.delimiter||".",n=r.overwrite||!1,s=r.transformKey||pt,u={};if(ft(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function d(x){const m=Number(x);return isNaN(m)||x.indexOf(".")!==-1||r.object?x:m}function p(x,m,y){return Object.keys(y).reduce(function(h,w){return h[x+o+w]=y[w],h},m)}function C(x){const m=Object.prototype.toString.call(x),y=m==="[object Array]",h=m==="[object Object]";if(x){if(y)return!x.length;if(h)return!Object.keys(x).length}else return!0}return e=Object.keys(e).reduce(function(x,m){const y=Object.prototype.toString.call(e[m]);return!(y==="[object Object]"||y==="[object Array]")||C(e[m])?(x[m]=e[m],x):p(m,x,mt(e[m],r))},{}),Object.keys(e).forEach(function(x){const m=x.split(o).map(s);let y=d(m.shift()),h=d(m[0]),w=u;for(;h!==void 0;){if(y==="__proto__")return;const v=Object.prototype.toString.call(w[y]),$=v==="[object Object]"||v==="[object Array]";if(!n&&!$&&typeof w[y]<"u")return;(n&&!$||!n&&w[y]==null)&&(w[y]=typeof h=="number"&&!r.object?[]:{}),w=w[y],m.length>0&&(y=d(m.shift()),h=d(m[0]))}w[y]=ht(e[x],r)}),u}function Gt(){return new Promise((e,r)=>{const o=document.createElement("input");o.type="file",o.onchange=()=>{var u;const n=(u=o.files)==null?void 0:u[0];if(!n)return e("");const s=new FileReader;s.onload=()=>{const f=s.result,d=new TextDecoder("utf-8");let p="";const C=[],x=1e5;for(let m=0;m<f.byteLength;m+=x)for(p+=d.decode(f.slice(m,Math.min(f.byteLength,m+x)));p.includes(`,
`);){let[y,...h]=p.split(`,
`);p=h.join(`,
`),y=y.replace(/^\[\n/,""),y=y.replace(/^\]/,""),!(y==="["||y==="]")&&C.push(JSON.parse(y))}e(ht(Object.fromEntries(C)))},s.onerror=f=>{r(f)},s.readAsArrayBuffer(n)},o.oncancel=()=>{e("")},o.click()})}function Jt(e){document.addEventListener("paste",r=>{const o=r.clipboardData||r.originalEvent.clipboardData,n=o.getData("text");if(n!=null&&n.startsWith("data:image")){e(n);return}const s=o.items;for(let u in s){const f=s[u];if(f.kind==="file"){const d=f.getAsFile(),p=new FileReader;p.onload=()=>{const C=p.result;C!=null&&C.startsWith("data:image")&&e(C)},p.readAsDataURL(d)}}})}async function Qt(e){if(!("showSaveFilePicker"in window))throw new Error("browser does not support native file system access");const r={types:[{description:"JSON",accept:{"application/json":[".json"]}}]},n=await(await window.showSaveFilePicker(r)).createWritable(),s=Object.entries(mt(e));await n.write(`[
`);for(let u of s)await n.write(JSON.stringify(u)),u!==s[s.length-1]&&await n.write(`,
`);await n.write(`
]`),await n.close()}const J=[];let ne=-1;const Vt=50;function j(e){for(J.splice(ne+1,J.length),J.push(e);J.length>Vt;)J.shift();ne=J.length-1,J[ne].redo()}function en(){const e=J[ne];return e?(e.undo(),--ne,e.name):(ne=-1,!1)}function tn(){++ne;const e=J[ne];return e?(e==null||e.redo(),e==null?void 0:e.name):(ne=J.length-1,!1)}(async()=>{let e=be("current"),r=be("grid"),o=be("areas"),n,s=1;const u=()=>{s=Math.pow(1.1,n.zoom)},f=document.querySelector("#overlay"),d=document.querySelector("#controls"),p=document.querySelector("#map-container"),C=document.querySelector("#map"),x=document.querySelector("#images"),m=document.querySelector("#drawings"),y=document.querySelector("#pins"),h=document.querySelector("#text"),w=document.querySelector("#about"),v=document.querySelector("#cursor"),$=document.querySelector("#ping"),X=document.querySelector("#btn-about"),z=document.querySelector("#areas"),q=document.querySelector("#btn-area-add"),re=document.querySelector("#btn-area-rename"),D=document.querySelector("#btn-area-delete"),Q=document.querySelector("#btn-grid"),Y=document.querySelector("#btn-save"),U=document.querySelector("#btn-export"),V=document.querySelector("#btn-import"),Z=document.querySelector("#btn-new"),F=document.querySelector("#btn-select"),ge=document.querySelector("#btn-pan"),R=document.querySelector("#btn-text"),P=document.querySelectorAll('#options-colour > input[type="radio"]'),oe=document.querySelector("#stroke"),G=document.querySelectorAll('#options-pin input[type="radio"]'),S=document.querySelector("#custom-pin"),L=document.querySelector("#custom-pin-entry"),k=document.querySelector("#context"),O=document.querySelector("#context-delete"),ie=document.querySelector("#context-pin"),ae=document.querySelector("#context-datalist"),xe=document.querySelector("#context-notes"),fe=document.querySelector("#context-images"),se=document.querySelector("#search"),pe=document.querySelector("#search-results"),ze=document.querySelector("#toasts");if(!f||!d||!p||!C||!x||!m||!y||!h||!w||!v||!$||!F||!ge||!R||!X||!z||!q||!re||!D||!Q||!Y||!U||!V||!Z||!P.length||!oe||!G.length||!S||!L||!k||!O||!ae||!ie||!xe||!fe||!se||!pe||!ze)throw new Error("Could not find elements");const me=t=>{f.textContent=t,f.classList.add("show")},he=()=>{f.textContent="",f.classList.remove("show")},N=t=>{const i=document.createElement("li");i.textContent=t,ze.appendChild(i),setTimeout(()=>{i.remove()},2500)},M=t=>{e=t,n=o[t],z.value=t,de(),yt()},ce=()=>{z.textContent="",Object.keys(o).sort().forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,t===e&&(i.selected=!0),z.appendChild(i)})},Ke=()=>{document.querySelectorAll("#pins > *").forEach(t=>{t.style.transform=`translate(-50%, -50%) scale(${1/s})`})},je=()=>{y.textContent="",n.pins.forEach((t,i)=>{const a=t.type,c=document.createElement("div");c.textContent=a||"???",c.style.top=`${t.y}px`,c.style.left=`${t.x}px`,y.appendChild(c),c.dataset.idx=i.toString(10)}),Ke()},yt=()=>{ce(),je(),h.textContent="",n.text.forEach((t,i)=>{const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}a.style.top=`${t.y}px`,a.style.left=`${t.x}px`,a.style.fontSize=`${t.size*100}%`,a.textContent=t.text,a.dataset.idx=i.toString(10),h.appendChild(a),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",b()}),a.addEventListener("blur",()=>{var c;(c=a.textContent)!=null&&c.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ge(a),a.remove(),b())})}),Se(),ye(),u(),we()};X.addEventListener("click",()=>{w.classList.toggle("show")}),z.addEventListener("change",()=>{const t=e,i=z.value;t!==i&&j({name:"change area",undo(){M(t)},redo(){M(i)}})}),q.addEventListener("click",()=>{const t=window.prompt("new area name?",`area ${Object.keys(o).length}`);if(!t)return;if(o[t]){window.alert("error: an area with that name already exists!");return}const i=e,a={offset:{x:0,y:0},zoom:1,images:{},drawings:[],pins:[],text:[]};j({name:"create area",undo(){delete o[t],ce(),M(i),b()},redo(){o[t]=a,ce(),M(t),b()}})}),re.addEventListener("click",()=>{const t=e,i=window.prompt("rename area",e);!i||i===t||j({name:"rename area",undo(){o[t]=o[i],delete o[i],e=t,z.selectedOptions[0].value=z.selectedOptions[0].textContent=t,b()},redo(){o[i]=o[t],delete o[t],e=i,z.selectedOptions[0].value=z.selectedOptions[0].textContent=i,b()}})}),D.addEventListener("click",()=>{const t=e;if(Object.keys(o).length<=1){window.alert("error: cannot delete only area!");return}if(!window.confirm("delete area?"))return;const i=Object.keys(o).filter(g=>g!==t)[0],a=o[t],c=z.selectedOptions[0],l=z.selectedIndex;j({name:"delete area",undo(){o[t]=a,z.insertBefore(c,z.children[l]),M(t),b()},redo(){delete o[t],c.remove(),M(i),b()}})}),Q.addEventListener("click",()=>{const t="note: this is global and will misalign anything that has been already placed on the map",i=window.prompt(`Set map cell width (${t})`,r[0].toString(10));if(!i)return;const a=window.prompt(`Set map cell height (${t})`,r[1].toString(10));if(!a)return;const c=r[0],l=r[1],g=parseInt(i,10),I=parseInt(a,10);j({name:"resize grid",undo(){r[0]=c,r[1]=l,ye(),b()},redo(){r[0]=g,r[1]=I,ye(),b()}})}),Y.addEventListener("click",async()=>{me("saving...");try{await Ne("grid",r),await Ne("current",e),await Ne("areas",o),N("saved"),b(!1)}finally{he()}}),U.addEventListener("click",async()=>{me("exporting...");try{await Qt({grid:r,current:e,areas:o}),N("exported"),b(!1)}catch(t){Te(t),window.alert(`error: failed to export - ${t.message}`)}finally{he()}}),V.addEventListener("click",async()=>{me("importing...");try{const t=await Gt();if(!t)return;if(typeof t.current!="string"||typeof t.areas!="object")throw new Error("invalid file");const i=r,a=t.grid,c=o,l=t.areas,g=e,I=t.current;N("imported"),j({name:"import",undo(){r=i,o=c,M(g),b()},redo(){r=a,o=l,M(I),b()}})}catch(t){Te(t),window.alert(`error: failed to import - ${t.message}`)}finally{he()}}),Z.addEventListener("click",async()=>{if(confirm(`Create a new map?
This will clear the one currently saved in your browser, make sure to export a save file if you don't want to lose any data!`))try{me("resetting...");const i=r,a=o,c=e;await St();const l=be("grid"),g=be("areas"),I=be("current");N("reset"),j({name:"reset",undo(){r=i,o=a,M(c),b()},redo(){r=l,o=g,M(I),b()}})}catch(i){Te(i),window.alert(`error: failed to reset - ${i.message}`)}finally{he()}}),P.forEach(t=>{t.style.backgroundColor=t.value}),G.forEach(t=>{var a;const i=document.createElement("span");i.textContent=t.value||"",(a=t.parentElement)==null||a.appendChild(i)});let A="select",ee="",Xe=Array.from(P)[0].value,Ye=Array.from(G)[0].value;const W=(t,i="",a=!0)=>{var c;A=t,ee=i,A==="select"?(v.textContent="",v.className="select",p.style.cursor="auto"):A==="pan"?(v.textContent="",v.className="pan",p.style.cursor="grab"):A==="text"?(v.textContent="Type here...",v.className="text",p.style.cursor="text"):A==="pin"?(Ye=ee,v.textContent=ee,v.className="pin",p.style.cursor="none"):A==="draw"&&(Xe=ee,v.style.setProperty("--colour",ee),v.textContent="",v.className="draw",p.style.cursor="crosshair"),a&&((c=document.querySelector(`input[type="radio"][name="tool"][value="${ee||A}"]`))==null||c.click())};P.forEach(t=>{t.addEventListener("change",()=>{W("draw",t.value,!1)})}),L.addEventListener("input",()=>{S.value=L.value,S.nextElementSibling.textContent=S.value,S.disabled=!S.value.trim()}),G.forEach(t=>{t.addEventListener("change",()=>{W("pin",t.value,!1)})}),F.addEventListener("change",()=>{W("select",void 0,!1)}),ge.addEventListener("change",()=>{W("pan",void 0,!1)}),R.addEventListener("change",()=>{W("text",void 0,!1)});const Re=()=>{v.style.setProperty("--size",`${parseInt(oe.value,10)}px`)};oe.addEventListener("input",Re);const gt=(t,i)=>{$.style.left=`${t}px`,$.style.top=`${i}px`,$.classList.remove("show"),document.body.offsetHeight,$.classList.add("show")},xt=(t,i)=>{const a=parseFloat(oe.value)/(s*2),c=ot({points:[],colour:i,size:a});m.appendChild(c);let l=[];const g=10;let I=0;const _=ve=>{const Le=Date.now(),ue=Be(ve.clientX,ve.clientY);ue.x/=s,ue.y/=s,Le-I<g?(l[l.length-1][0]=ue.x,l[l.length-1][1]=ue.y):(I=Le,l=Tt(l,2/s),l.push([ue.x,ue.y])),Fe(c,l,a)};_(t);const T=()=>{window.removeEventListener("pointermove",_),Fe(c,l,a);const ve={points:l,size:a,colour:i};j({name:"draw",undo(){n.drawings.pop(),Se(),b()},redo(){n.drawings.push(ve),Se(),b()}})};window.addEventListener("pointermove",_),window.addEventListener("pointerup",T,{once:!0})},we=()=>{let t=s;for(;t>4;)t/=2;for(;t<1;)t*=2;p.style.backgroundSize=`${r[0]*t/4}px ${r[1]*t/4}px`,p.style.backgroundPositionX=`${-n.offset.x}px`,p.style.backgroundPositionY=`${-n.offset.y}px`,C.style.transform=`translate(${-n.offset.x}px, ${-n.offset.y}px) scale(${s})`,Ke()},Se=()=>{m.textContent="",n.drawings.forEach(t=>{m.appendChild(ot(t))})},We=()=>Object.keys(n.images).length?Object.keys(n.images).map(t=>t.split("|").map(i=>parseInt(i,10))).reduce(([t,i,a,c],[l,g])=>[Math.min(t,l),Math.min(i,g),Math.max(a,l),Math.max(c,g)],[1/0,1/0,-1/0,-1/0]):[0,0,0,0],ye=()=>{x.textContent="";const[t,i,a,c]=We();for(let l=i-1;l<=c+1;++l)for(let g=t-1;g<=a+1;++g){const I=n.images[`${g}|${l}`],_=document.createElement(I?"img":"div");_.src=I,_.draggable=!1,_.dataset.x=g.toString(10),_.dataset.y=l.toString(10),_.style.width=`${r[0]}px`,_.style.height=`${r[1]}px`,_.style.transform=`translate(${g*r[0]}px, ${l*r[1]}px)`,x.appendChild(_)}},Be=(t,i)=>({x:t+n.offset.x,y:i+n.offset.y}),He=()=>({x:parseFloat(v.style.left),y:parseFloat(v.style.top)}),Ue=()=>{const t=He(),i=Be(t.x,t.y);return i.x/=s,i.y/=s,i},Ze=t=>{const i={...n.offset},a={x:t.clientX,y:t.clientY},c=p.style.cursor;p.style.cursor="grabbing";const l=I=>{n.offset.x=-(I.clientX-a.x)+i.x,n.offset.y=-(I.clientY-a.y)+i.y,E&&le(E,te),we()},g=()=>{window.removeEventListener("pointermove",l),p.style.cursor=c};window.addEventListener("pointermove",l),window.addEventListener("pointerup",g,{once:!0})},wt=(t,i,a)=>{const c={x:t.clientX,y:t.clientY},l={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)},g=p.style.cursor;p.style.cursor="move";const I=T=>{a((T.clientX-c.x)/s+l.x,(T.clientY-c.y)/s+l.y)},_=()=>{window.removeEventListener("pointermove",I),p.style.cursor=g;const T={x:parseInt(i.style.left,10),y:parseInt(i.style.top,10)};(T.x!==l.x||T.y!==l.y)&&j({name:"move",undo(){a(l.x,l.y),b()},redo(){a(T.x,T.y),b()}})};window.addEventListener("pointermove",I),window.addEventListener("pointerup",_,{once:!0})};let E=null,te="";const ke=t=>{var c;if(t!==E)return;const i=n.pins[parseInt(t.dataset.idx||"",10)];fe.textContent="";const a=(((c=i.images)==null?void 0:c.split("|"))||[]).filter(l=>l);if(a.forEach(l=>{const g=document.createElement("img");g.src=l,g.draggable=!1;const I=document.createElement("li"),_=document.createElement("button");_.title="open in new tab",_.textContent="🔍",_.addEventListener("click",()=>{window.open(l,"_blank")});const T=document.createElement("button");T.title="delete",T.textContent="✖",T.addEventListener("click",()=>{I.remove();const ve=i.images,Le=Array.from(fe.querySelectorAll("img")).map(ue=>ue.src).join("|");j({name:"delete image in pin",undo(){i.images=ve,ke(t),b()},redo(){i.images=Le,ke(t),b()}})}),I.appendChild(_),I.appendChild(T),I.appendChild(g),fe.appendChild(I)}),!a.length){const l=document.createElement("li");l.textContent="paste to add image",l.className="null",fe.appendChild(l)}},le=(t,i)=>{if(de(),E=t,te=i,i==="pin"){const a=n.pins[parseInt(E.dataset.idx||"",10)];k.classList.add("show");const c=E.getBoundingClientRect();E.classList.add("selected"),ie.value=a.type||"???",xe.value=a.notes||"",ke(t),k.style.top=`${c.bottom<p.clientHeight/2?c.bottom:c.top-k.clientHeight}px`,k.style.left=`${c.right<p.clientWidth/2?c.right:c.left-k.clientWidth}px`,requestAnimationFrame(()=>{window.addEventListener("pointerdown",l=>{l.target&&![k,E].includes(l.target)&&!(k.contains(l.target)||!(E!=null&&E.contains(l.target)))&&de()},{once:!0})})}else(i==="image"||i==="drawing")&&E.classList.add("selected")},de=()=>{k.classList.remove("show"),E==null||E.classList.remove("selected"),E=null},Ge=t=>{let i=t.nextSibling;for(;i;)i.dataset.idx=(parseInt(i.dataset.idx||"",10)-1).toString(10),i=i.nextSibling};O.addEventListener("click",()=>{if(!E)return;const t=parseInt(E.dataset.idx||"",10),i=n.pins[t];j({name:"delete pin",undo(){n.pins.splice(t,0,i),je(),le(y.children[t],"pin"),b()},redo(){n.pins.splice(t,1),je(),de(),b()}})}),ie.addEventListener("input",()=>{if(!E)return;const t=n.pins[parseInt(E.dataset.idx||"",10)];t.type=ie.value||"???",E.textContent=t.type,b()}),xe.addEventListener("input",()=>{if(!E)return;const t=n.pins[parseInt(E.dataset.idx||"",10)];t.notes=xe.value,b()}),p.addEventListener("pointerdown",t=>{const i=document.activeElement;if(d.contains(i)&&(i==null||i.blur()),t.button===1){t.preventDefault(),Ze(t);return}else if(t.button===0){if(A==="select"){de();const a=document.elementFromPoint(t.clientX,t.clientY);if(a!=null&&a.closest("#pins")){i==null||i.blur(),t.preventDefault(),le(a,"pin");const c=n.pins[parseInt(a.dataset.idx||"",10)];wt(t,a,(l,g)=>{a.style.left=`${l}px`,a.style.top=`${g}px`,c.x=l,c.y=g,le(a,"pin")})}else a!=null&&a.closest("#images")?(i==null||i.blur(),t.preventDefault(),le(a,"image")):a!=null&&a.closest("#drawings")&&(i==null||i.blur(),t.preventDefault(),le(a,"drawing"));return}else if(A==="pan")t.preventDefault(),Ze(t);else if(A==="pin"){t.preventDefault();const a=ee,c=document.createElement("div");c.textContent=a;const l=Ue();c.style.top=`${l.y}px`,c.style.left=`${l.x}px`,c.dataset.idx=n.pins.length.toString(10),F.click();const g={x:l.x,y:l.y,type:a,notes:"",images:""};j({name:"place pin",undo(){de(),n.pins.pop(),c.remove(),we(),b()},redo(){y.appendChild(c),n.pins.push(g),we(),le(c,"pin"),b()}})}else if(A==="draw")t.preventDefault(),xt(t,ee);else if(A==="text"){t.preventDefault();const a=document.createElement("div");try{a.contentEditable="plaintext-only"}catch{a.contentEditable="true"}const c=Ue();a.style.top=`${c.y}px`,a.style.left=`${c.x}px`,a.style.fontSize="200%",a.dataset.idx=n.text.length.toString(10),F.click(),a.addEventListener("input",()=>{n.text[parseInt(a.dataset.idx||"",10)].text=a.textContent||"",b()}),a.addEventListener("blur",()=>{var g;(g=a.textContent)!=null&&g.trim()||(n.text.splice(parseInt(a.dataset.idx||"",10),1),Ge(a),a.remove(),b())});const l={x:c.x,y:c.y,text:"",size:2};j({name:"place text",undo(){a.remove(),n.text.pop(),b()},redo(){h.appendChild(a),n.text.push(l),a.focus(),b()}})}}}),p.addEventListener("pointermove",t=>{v.style.left=`${t.clientX}px`,v.style.top=`${t.clientY}px`});const vt=t=>{const i=E;if(!i)return;const a=n.pins[parseInt(i.dataset.idx||"",10)],c=a.images,l=[a.images,t].filter(g=>g).join("|");j({name:"add image to pin",undo(){a.images=c,ke(i),b()},redo(){a.images=l,ke(i),b()}})},bt=t=>{if(!E)return;const i=`${E.dataset.x}|${E.dataset.y}`,a=n.images[i];j({name:"place image",undo(){a?n.images[i]=a:delete n.images[i],ye(),b()},redo(){n.images[i]=t,ye(),b()}})};Jt(t=>{E&&te==="pin"?vt(t):E&&te==="image"&&bt(t)});let Me=!1;window.addEventListener("keydown",t=>{var a;const i=document.activeElement;if((i==null?void 0:i.tagName)==="TEXTAREA"||(i==null?void 0:i.tagName)==="INPUT"||(i==null?void 0:i.contentEditable)==="plaintext-only"||(i==null?void 0:i.contentEditable)==="true"){if(t.ctrlKey&&t.key==="="&&i.parentElement===h){t.preventDefault();const c=n.text[parseInt(i.dataset.idx||"",10)];c.size*=2,i.style.fontSize=`${c.size*100}%`,b()}else if(t.ctrlKey&&t.key==="-"&&i.parentElement===h){t.preventDefault();const c=n.text[parseInt(i.dataset.idx||"",10)];c.size/=2,i.style.fontSize=`${c.size*100}%`,b()}return}if(t.ctrlKey&&t.key==="z"){const c=en();c!==!1&&N(["undo",c].filter(l=>l).join(" - "))}if(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z"){const c=tn();c!==!1&&N(["redo",c].filter(l=>l).join(" - "))}if(t.key==="Escape"&&de(),(t.key==="Backspace"||t.key==="Delete")&&E&&te==="image"){const c=`${E.dataset.x}|${E.dataset.y}`,l=n.images[c];j({name:"delete image",undo(){n.images[c]=l,ye(),b()},redo(){delete n.images[c],ye(),b()}})}if((t.key==="Backspace"||t.key==="Delete")&&E&&te==="drawing"){const c=Array.from(((a=E.parentElement)==null?void 0:a.children)||[]).indexOf(E),l=n.drawings[c];j({name:"delete drawing",undo(){n.drawings.splice(c,0,l),Se(),b()},redo(){n.drawings.splice(c,1),Se(),b()}})}if((t.key==="Backspace"||t.key==="Delete")&&E&&te==="pin"&&O.click(),t.ctrlKey&&t.key==="s"){t.preventDefault(),Y.click();return}if(t.ctrlKey&&t.key==="c"&&E&&te==="image"){t.preventDefault(),navigator.clipboard.writeText(E.src);return}if(!Me&&t.key===" "){Me=!0;const c=A,l=ee;W("pan"),window.addEventListener("keyup",g=>{g.key===" "&&(Me=!1,W(c,l))})}if(t.key==="q"){t.preventDefault(),W("select");return}if(t.key==="t"){t.preventDefault(),W("text");return}if(t.key==="b"){t.preventDefault(),W("draw",Xe);return}if(t.key==="p"){t.preventDefault(),W("pin",Ye);return}if(t.key==="f"){t.preventDefault();const[c,l,g,I]=We(),_=1/(Math.max(Math.abs(g-c),Math.abs(I-l))+2);for(n.zoom=1,u();s>_&&n.zoom>-100;)--n.zoom,u();Je(((c+g)/2+.5)*r[0],((l+I)/2+.5)*r[1]);return}}),p.addEventListener("wheel",t=>{n.offset.x+=t.deltaX,n.zoom-=Math.sign(t.deltaY);const i=s;u();const a=s-i,c=He(),l={x:(c.x+n.offset.x)/i,y:(c.y+n.offset.y)/i};n.offset.x+=l.x*a,n.offset.y+=l.y*a,we(),E&&le(E,te)});const Je=(t,i)=>{let a=0,c=0;d.clientWidth/p.clientWidth<d.clientHeight/p.clientHeight?a=d.clientWidth/2:c=d.clientHeight/2,n.offset.x=t*s-p.clientWidth/2-a,n.offset.y=i*s-p.clientHeight/2-c,gt(p.clientWidth/2+a,p.clientHeight/2+c),we()};let Ce;se.addEventListener("focus",()=>{Ce=new Lt("key"),Ce.addDocuments(Object.entries(o).flatMap(([t,{pins:i,text:a}])=>i.map((c,l)=>({key:`${t}-p-${l}`,area:t,text:[t,c.type,c.notes].filter(g=>g).join(" > "),original:c})).concat(a.map((c,l)=>({key:`${t}-t-${l}`,area:t,text:[t,c.text].filter(g=>g).join(" > "),original:c}))))),Ce.addIndex("text")}),se.addEventListener("input",()=>{const t=Ce.search(se.value);pe.textContent="",t.forEach(i=>{const a=document.createElement("li"),c=document.createElement("span");c.innerHTML=i.text,Zt(c,se.value,Ce.tokenizer.tokenize);const l=document.createElement("button");l.title="focus",l.textContent="🔍",l.addEventListener("click",()=>{de();const g=i.area;e!==g&&M(g),Je(i.original.x,i.original.y)}),l.addEventListener("dblclick",()=>{n.zoom=1,u()}),a.appendChild(l),a.appendChild(c),pe.appendChild(a)})}),Array.from(G).forEach(t=>{const i=document.createElement("option");i.value=t.value,ae.appendChild(i)}),M(e),Re()})();
